<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Avatar Universe Culinary Generator - V5.0</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap');

      :root {
        --color-background: #2c2823; /* Earthy brown */
        --color-text: #f0e6d2; /* Parchment */
        --color-primary: #ffd369; /* Gold accent */
        --color-secondary: #b08d57; /* Muted gold */
        --color-surface: #3e3830; /* Slightly lighter than body */
        --color-border: #5a4a3b; /* Darker border */
        --color-text-strong: #f4c588; /* Lighter gold for emphasis */
        --color-lore: #c9b38b; /* Muted parchment for lore */
        --font-heading: 'Cinzel', 'Luminari', 'Fantasy', serif;
        --font-body:
          'Lora', 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      }

      body {
        font-family: var(--font-body);
        background-color: var(--color-background);
        color: var(--color-text);
        padding: 1rem 2rem 3rem;
        line-height: 1.7;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .container {
        width: 100%;
        max-width: 900px; /* Max width for readability */
      }

      h1 {
        color: var(--color-primary);
        text-align: center;
        font-family: var(--font-heading);
        font-size: 2.5em;
        margin-bottom: 1.5rem;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
      }

      fieldset {
        border: 2px solid var(--color-border);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        background-color: rgba(
          0,
          0,
          0,
          0.1
        ); /* Subtle darker background for fieldset */
      }

      legend {
        font-family: var(--font-heading);
        color: var(--color-secondary);
        font-size: 1.5em;
        font-weight: bold;
        padding: 0 0.5em;
        margin-left: 1em; /* Align with padding */
      }

      label,
      select,
      input,
      button {
        display: block;
        margin-bottom: 1rem; /* Consistent margin for form elements */
        font-size: 1.1em;
      }
      label {
        color: var(--color-text-strong);
        margin-bottom: 0.5rem;
      }

      select,
      input[type='text'] {
        width: 100%;
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        color: var(--color-text);
        box-sizing: border-box;
        font-family: var(--font-body);
        transition:
          border-color 0.3s ease,
          box-shadow 0.3s ease;
      }
      select:focus,
      input[type='text']:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(255, 211, 105, 0.5);
        outline: none;
      }

      button[type='submit'] {
        width: auto;
        padding: 0.8rem 2rem;
        background: var(--color-secondary);
        color: var(--color-background);
        cursor: pointer;
        font-weight: bold;
        font-family: var(--font-heading);
        font-size: 1.2em;
        border: none;
        border-radius: 6px;
        transition:
          background-color 0.3s ease,
          transform 0.1s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        display: block;
        margin: 1.5rem auto 0; /* Center button */
      }
      button[type='submit']:hover {
        background: var(--color-primary);
        transform: translateY(-2px);
      }
      button[type='submit']:active {
        transform: translateY(0px);
      }

      .result {
        margin-top: 2rem;
        padding: 2rem;
        border: 3px solid var(--color-border);
        background: var(--color-surface);
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      }
      .result h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: var(--color-primary);
        font-family: var(--font-heading);
        font-size: 2em;
        border-bottom: 2px solid var(--color-secondary);
        padding-bottom: 0.75rem;
        text-align: center;
      }
      .result p {
        margin-bottom: 1rem;
      }
      .result ul {
        list-style-type: none;
        padding-left: 0;
      }
      .result ul li {
        background-color: rgba(0, 0, 0, 0.1);
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        border-left: 3px solid var(--color-secondary);
      }
      .result ul li::before {
        content: '‚ùñ '; /* Spirit-y bullet */
        color: var(--color-secondary);
        margin-right: 0.5em;
      }
      .dish-lore {
        font-style: italic;
        color: var(--color-lore);
        padding: 1rem;
        margin-top: 1.5rem;
        border-top: 1px dashed var(--color-border);
        border-bottom: 1px dashed var(--color-border);
        background-color: rgba(0, 0, 0, 0.05);
      }
      .dish-lore strong {
        font-family: var(--font-heading);
        color: var(--color-secondary);
        font-weight: normal;
      }

      .multiselect {
        display: grid; /* Use grid for better alignment */
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid var(--color-border);
        border-radius: 6px;
      }
      .multiselect label {
        margin: 0; /* Reset margin for grid items */
        cursor: pointer;
        padding: 0.5rem 0.8rem;
        border-radius: 4px;
        transition:
          background-color 0.2s,
          color 0.2s;
        display: flex;
        align-items: center;
        font-size: 1em;
        color: var(--color-text);
      }
      .multiselect input[type='checkbox'] {
        margin-right: 0.5em;
        transform: scale(1.2); /* Make checkbox slightly larger */
        accent-color: var(--color-secondary);
      }
      .multiselect label:hover {
        background-color: var(--color-border);
        color: var(--color-primary);
      }

      strong {
        color: var(--color-text-strong);
        font-weight: bold; /* Ensure Lora bold is used */
      }

      /* Responsive adjustments */
      @media (max-width: 600px) {
        body {
          padding: 1rem;
        }
        h1 {
          font-size: 2em;
        }
        .result h2 {
          font-size: 1.75em;
        }
        legend {
          font-size: 1.3em;
        }
        .multiselect {
          grid-template-columns: 1fr; /* Stack checkboxes on small screens */
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìú Avatar Universe Culinary Generator üç≤ v5.0</h1>

      <form id="dishForm">
        <fieldset>
          <legend>Dish Foundation</legend>
          <label for="dishTypeInput">Select Dish Type:</label>
          <select id="dishTypeInput" name="dishTypeInput">
            <option>Main Course</option>
            <option>Side Dish</option>
            <option>Snack</option>
            <option>Dessert</option>
            <option>Beverage</option>
            <option>Soup/Stew</option>
            <option>Salad</option>
            <option>Sauce/Condiment</option>
            <option>Street Food</option>
            <option>Festival Dish</option>
            <option>Appetizer</option>
            <option>Bread/Pastry</option>
            <option>Nectar</option>
          </select>

          <label for="baseFormat">Primary Culinary Format (Optional):</label>
          <select id="baseFormat" name="baseFormat">
            <option value="">‚Äî Any ‚Äî</option>
            <option>Noodles</option>
            <option>Dumplings/Buns</option>
            <option>Soup</option>
            <option>Stew</option>
            <option>Curry</option>
            <option>Rice Bowl/Plate</option>
            <option>Grilled/Skewered</option>
            <option>Roasted/Baked</option>
            <option>Fried</option>
            <option>Steamed</option>
            <option>Pastry/Pie/Tart</option>
            <option>Cake</option>
            <option>Cookie/Biscuit</option>
            <option>Salad (Leafy/Fruit/Grain)</option>
            <option>Fermented/Pickled</option>
            <option>Jerky/Dried</option>
            <option>Tea-Based Infusion</option>
            <option>Juice/Smoothie</option>
            <option>Nectar</option>
            <option>Stuffed (e.g., stuffed vegetable/fruit)</option>
            <option>Layered Dish</option>
            <option>Patties/Fritters</option>
            <option>Wrap/Roll</option>
          </select>
        </fieldset>

        <fieldset>
          <legend>Cultural Influence</legend>
          <label>Select Nation(s) of Origin/Influence:</label>
          <div class="multiselect">
            <label
              ><input type="checkbox" name="nation" value="Air Nomads" /> üå¨Ô∏è Air
              Nomads</label
            >
            <label
              ><input type="checkbox" name="nation" value="Water Tribes" /> üåä
              Water Tribes</label
            >
            <label
              ><input type="checkbox" name="nation" value="Earth Kingdom" /> ü™®
              Earth Kingdom</label
            >
            <label
              ><input type="checkbox" name="nation" value="Fire Nation" /> üî•
              Fire Nation</label
            >
            <label
              ><input type="checkbox" name="nation" value="United Republic" />
              üèôÔ∏è United Republic</label
            >
            <label
              ><input type="checkbox" name="nation" value="Spirit World" /> üåå
              Spirit World (Thematic)</label
            >
          </div>
        </fieldset>

        <fieldset>
          <legend>Thematic Inspiration</legend>
          <label for="specialThemes"
            >Special Theme or Inspiration (Optional):</label
          >
          <select id="specialThemes" name="specialThemes">
            <option value="">‚Äî None ‚Äî</option>
            <option value="Spiritual">Spirit World Influence / Sacred</option>
            <option value="Royal">Royal Banquet / Noble Feast</option>
            <option value="Survival">War-Era / Foraged / Survivalist</option>
            <option value="Fusion">Cross-Nation Culinary Fusion</option>
            <option value="Childhood">Childhood Comfort / Nostalgic</option>
            <option value="Medicinal">
              Healing / Restorative / Chi-Enhancing
            </option>
            <option value="Street">
              Bustling Market / Street Vendor Style
            </option>
            <option value="Luxury">Gourmet / Rare Ingredients</option>
            <option value="Festival">Celebratory / Festival Special</option>
            <option value="Ancient">Ancient Recipe / Lost Tradition</option>
            <option value="Innovative">
              Modern / Experimental / Zaofu Tech
            </option>
            <option value="Traveler">Wanderer's Fare / Easily Portable</option>
            <option value="Rustic">Simple Village / Farm-to-Table</option>
            <option value="Hidden">Secret Society / Hidden Technique</option>
          </select>
        </fieldset>

        <button type="submit">‚ú® Conjure a Dish! ‚ú®</button>
      </form>

      <div class="result" id="dishResult" style="display: none">
        <h2 id="dishName"></h2>
        <p><strong>Concept:</strong> <span id="dishConcept"></span></p>
        <p><strong>Key Ingredients & Roles:</strong></p>
        <ul id="ingredientList"></ul>
        <p><strong>Preparation, Presentation & Flavor Journey:</strong></p>
        <p id="dishNotes"></p>
        <div class="dish-lore" id="dishLore" style="display: none">
          <p>
            <strong>Whispers of the Past (Lore):</strong>
            <span id="loreText"></span>
          </p>
        </div>
      </div>
    </div>

    <script>
      // Utility functions (remain mostly unchanged, but moved to top for clarity)
      function getRandomElement(arr) {
        if (!arr || !Array.isArray(arr) || arr.length === 0) return undefined;
        return arr[Math.floor(Math.random() * arr.length)];
      }

      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        if (min > max) return min;
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      // --- Ingredient Property Getters ---
      // These functions centralize access to ingredient properties, providing fallbacks.
      function getIngredientProperty(ingredient, property, defaultValue) {
        if (ingredient === undefined || ingredient === null) {
          // Handle cases where ingredient might be undefined/null defensively
          if (property === 'name')
            return typeof defaultValue === 'string'
              ? defaultValue
              : 'Undefined Ingredient';
          if (
            property === 'tags' ||
            property === 'flavorNotes' ||
            property === 'loreHints' ||
            property === 'rolePreference'
          )
            return [];
          if (property === 'canBeBase' || property === 'rawCompatible')
            return false;
          if (property === 'type') return 'unknown_type';
          return defaultValue;
        }
        if (
          typeof ingredient === 'object' &&
          ingredient[property] !== undefined
        ) {
          return ingredient[property];
        }
        // Special handling for name if ingredient is just a string (though it should be an object)
        if (property === 'name' && typeof ingredient === 'string')
          return ingredient;
        // Default values for common array/boolean properties
        if (
          property === 'tags' ||
          property === 'flavorNotes' ||
          property === 'loreHints' ||
          property === 'rolePreference'
        )
          return [];
        if (property === 'canBeBase' || property === 'rawCompatible')
          return false;
        if (property === 'type') return 'unknown_type';
        return defaultValue;
      }

      function getIngredientName(ingredient, stripGeneric = false) {
        let name = getIngredientProperty(
          ingredient,
          'name',
          'Unknown Ingredient'
        );
        if (typeof name !== 'string') name = 'Unknown Ingredient'; // Ensure it's a string
        if (stripGeneric) {
          name = name.replace(/^(Generic|Basic|Common)\s+/i, '');
        }
        return name;
      }
      function getIngredientTags(ingredient) {
        return getIngredientProperty(ingredient, 'tags');
      }
      function getIngredientFlavorNotes(ingredient) {
        return getIngredientProperty(ingredient, 'flavorNotes');
      }
      function getIngredientRolePreference(ingredient) {
        return getIngredientProperty(ingredient, 'rolePreference');
      }
      function getIngredientType(ingredient) {
        return getIngredientProperty(ingredient, 'type', 'other');
      }
      function getCanBeBase(ingredient) {
        return getIngredientProperty(ingredient, 'canBeBase');
      }
      function getIngredientWeight(ingredient) {
        return getIngredientProperty(ingredient, 'weight', 'medium');
      }
      function getRawCompatible(ingredient) {
        return getIngredientProperty(ingredient, 'rawCompatible');
      }
      function getIngredientRarity(ingredient) {
        return getIngredientProperty(ingredient, 'rarity', 'common');
      }
      function getIngredientLoreHints(ingredient) {
        return getIngredientProperty(ingredient, 'loreHints');
      }

      // --- Core Data Definitions ---
      const FLAVOR_JOURNEYS = {
        structure: ['intro', 'core', 'aftertaste'],
        templates: [
          'The first experience is {intro}. This gently yields to {core}, before concluding with {aftertaste}.',
          '{intro} greets the palate, followed by the satisfying depth of {core}, and a finish of {aftertaste}.',
          'It begins with {intro}, builds to {core}, and leaves a memorable trace of {aftertaste}.',
          'The flavor journey unfolds as {intro}, leading smoothly into {core}, and ending with {aftertaste}.',
          'A delicate {intro} blossoms, giving way to the rich {core}, culminating in a lingering {aftertaste}.',
        ],
        flavorMap: {
          intro: [
            'subtle',
            'sweet',
            'mild',
            'creamy',
            'delicate',
            'floral',
            'aromatic',
            'gentle',
            'fresh',
            'light',
            'crisp',
            'tangy',
            'bright',
            'herbal',
            'zesty',
            'pure',
            'cool',
            'airy',
            'clean',
            'brightly-acidic',
            'effervescent',
            'refreshing',
            'citrusy',
            'soft',
            'silken',
            'velvety',
            'fragrant',
            'verdant',
            'earthy-sweet',
            'subtle-spice-hint',
            'whispered',
          ],
          core: [
            'bold',
            'savory',
            'fiery',
            'umami',
            'rich',
            'spicy',
            'earthy',
            'hearty',
            'robust',
            'intense',
            'deep',
            'complex',
            'smoky',
            'fruity_heat',
            'tart',
            'refreshing',
            'grounded',
            'gamey-rich',
            'rooty-deep',
            'sun-drenched',
            'intensely-umami',
            'fiery-sweet',
            'complex-spiced',
            'tangy-savory',
            'bitter-sweet',
            'nutty-brown',
            'woodsy',
            'mineral-rich',
          ],
          aftertaste: [
            'sharp',
            'tangy',
            'smoky',
            'cool',
            'crisp',
            'refreshing',
            'warm',
            'zesty',
            'bitter-sweet',
            'mineral',
            'herbal',
            'lasting',
            'clean',
            'spicy_glow',
            'smooth',
            'bright',
            'purity',
            'ethereal',
            'clean-mineral',
            'woodsy',
            'bitter-savory',
            'lingering-floral',
            'bright-zest',
            'smoky-warm',
            'velvet-soft',
            'peppery-zing',
            'clean-finish',
            'subtle-hum',
            'ethereal-echo',
            'sweet-reverberation',
          ],
        },
      };

      const FUSION_SYNERGY = {
        'Air Nomads': {
          'Water Tribes':
            'This dish masterfully balances the ethereal lightness of air with the profound, flowing depths of water, offering an experience that is both refreshing and deeply nourishing. It speaks of the horizon where sky meets sea.',
          'Earth Kingdom':
            "Here, light meets grounded‚Äîgentle, airy forms and pure flavors are built upon a foundation of earthy strength and steadfast resilience. It's a dialogue between the mountain peak and the fertile valley.",
          'Fire Nation':
            "A fascinating blend of ascetic harmony and elemental intensity, where serene, contemplative flavors are suddenly awakened by a spirited, fiery touch. It's the calm before the invigorating storm.",
          'United Republic':
            "Ancient nomadic wisdom finds new, vibrant expression through modern innovation and diverse cultural exchange, creating a taste that's both timelessly spiritual and excitingly contemporary.",
          'Spirit World':
            "Ethereal tastes of the Spirit World find a natural resonance with the Air Nomads' meditative practices, resulting in a dish that feels like whispered mantras and floating incense.",
        },
        'Water Tribes': {
          'Earth Kingdom':
            'A powerful fusion of oceanic bounty and terrestrial abundance, this creation reflects the enduring, cyclical connection between the vast sea and the steadfast land. It tastes of coastal cliffs and deep-rooted kelp forests.',
          'Fire Nation':
            'The cool, adaptive resilience of the polar currents encounters the volcanic heart of the Fire Nation, forging a dynamic interplay of temperatures, textures, and energies‚Äîlike steam rising from where magma meets ice.',
          'United Republic':
            'Traditional tribal flavors, honed by generations of survival and community, are reimagined with urban sophistication and a dash of global influence, bridging ancient heritage with the vibrant pulse of the modern world.',
          'Spirit World':
            'The mystical energies of the Spirit World infuse the deep, intuitive nature of Water Tribe cuisine, creating flavors that shift and shimmer like moonlight on a spirit oasis.',
        },
        'Earth Kingdom': {
          'Fire Nation':
            "Solid, dependable flavors, as ancient as the mountains, are dramatically invigorated by passionate spice and transformative heat. This dish is a testament to the earth's endurance and fire's capacity for bold creation.",
          'United Republic':
            "The diverse, inexhaustible riches of the Earth Kingdom's vast lands are presented with Republic City's innovative culinary spirit, resulting in a true melting pot of robust tastes and surprising harmonies.",
          'Spirit World':
            "The ancient, unseen energies of the Spirit World are anchored by the Earth Kingdom's grounded flavors, as if ancient ley lines themselves have seasoned the meal.",
        },
        'Fire Nation': {
          'United Republic':
            'The bold, assertive, and unapologetically flavorful cuisine of the Fire Nation is refined and broadened with cosmopolitan flair and novel techniques, offering an exciting yet thoughtfully balanced culinary adventure for the discerning palate.',
          'Spirit World':
            'The transformative, sometimes unpredictable nature of the Spirit World melds with Fire Nation intensity, producing a dish that is both fiercely alive and touched by the uncanny. This might involve ancestral infusion techniques preserved by Fire Sages or shrine monks to channel such energies.',
        },
        'United Republic': {
          'Spirit World':
            'The innovative spirit of Republic City dares to interpret the unknowable flavors of the Spirit World, resulting in a dish that is both modern and deeply mystical, a bridge between worlds.',
        },
      };
      Object.keys(FUSION_SYNERGY).forEach((nation1) => {
        Object.keys(FUSION_SYNERGY[nation1]).forEach((nation2) => {
          if (!FUSION_SYNERGY[nation2]) FUSION_SYNERGY[nation2] = {};
          if (!FUSION_SYNERGY[nation2][nation1])
            FUSION_SYNERGY[nation2][nation1] = FUSION_SYNERGY[nation1][nation2];
        });
      });

      const DISH_LORE_TEMPLATES = {
        generic: [
          'Legend whispers this dish was first conceived by a wandering philosopher on the {Pilgrimage_Trail}, inspired by the elemental balance they witnessed during a {Weather_Event}.',
          'A favorite among {role_plural} in the bustling markets of {nation_place}, its recipe a closely guarded secret passed down through generations, sometimes scribbled on {Secret_Medium}.',
          'Once a humble meal for simple folk in {Rural_Region}, it gained notoriety after being serendipitously served to a traveling {Dignitary_Type}, who declared it a masterpiece.',
          'The precise origins are debated by culinary historians at {Academic_Institution}, but all agree it captures the unique spirit of {nation_name} ingenuity and their relationship with {Natural_Feature}.',
          'Some say the recipe was discovered etched on an ancient {Artifact_Type}, a relic from a forgotten age of culinary artistry, perhaps dating back to the time of Avatar {Ancient_Avatar_Name}.',
          'This dish is often prepared during the {Seasonal_Festival} in {Nation_Capital}, believed to bring good fortune and foster community bonds over shared {Festival_Activity}.',
        ],
        byNation: {
          airNomads: [
            'Whispered to have been a meditation aid for monks at the {Air_Temple_Name} Air Temple, its recipe passed down through serene contemplation and harmonious living, often enjoyed during the {Time_Of_Day} meditation.',
            'Said to be a variation of a dish Avatar {Air_Avatar_Name} often requested during their airbending training with {Air_Monk_Mentor}, finding in it both sustenance and tranquility.',
            "The lightness and purity of this dish are symbolic of the Air Nomads' detachment from worldly burdens, a culinary expression of freedom and spiritual ascent, like a {Sky_Creature} taking flight.",
            "Oral tradition states that Guru {Air_Guru_Name} himself perfected this recipe while studying {Spiritual_Concept} in the {Mountain_Range} mountains, believing it to align the body's chi for deeper spiritual connection.",
            'Sky Bison herders would prepare a similar dish using foraged {Specific_Mountain_Herb} and {Wild_Nut_Type}, a simple yet nourishing meal under the vast, open sky near {Landmark_Air_Nomad}.',
          ],
          waterTribes: [
            "A traditional offering to the Moon and Ocean spirits during the {Lunar_Event} at the {Sacred_Water_Site}, this dish represents gratitude for the sea's bounty in the {Water_Tribe_Region}.",
            'Southern Water Tribe hunters, led by a renowned {Hunter_Title}, would prepare this hearty meal to share after a successful hunt for {Arctic_Animal}, its warmth a welcome comfort against the biting polar winds.',
            "Foggy Swamp Tribe mystics are said to infuse their version of this dish with unique {Swamp_Plant_Type} and {Rare_Swamp_Ingredient}, believing it enhances one's connection to the living world and the Great Banyan Tree.",
            'Northern Water Tribe healers, apprentices of {Healer_Master_Name}, sometimes prescribe a broth based on these ingredients for its restorative properties, a recipe passed from master to apprentice in the healing huts.',
            "Legend has it that the first Waterbenders learned to 'cook' with ice and steam from {Geothermal_Feature_Water}, and this dish is a distant echo of those primordial culinary techniques, refined by figures like {Legendary_Waterbender_Chef}.",
          ],
          earthKingdom: [
            "This robust dish was a staple for the builders of Ba Sing Se's great walls under the commission of {Historical_EK_Leader}, providing the strength and endurance needed for their monumental task.",
            "In the marketplaces of Omashu, vendors from the {Specific_District_Omashu} district jealously guard their family's unique spice blend for this regional specialty, a source of immense pride and fierce competition.",
            "Kyoshi Warriors are said to favor a version of this dish, taught by {Kyoshi_Warrior_Trainer}, for its balance of energy and fortitude, a meal fit for the island's protectors before their {Warrior_Ritual}.",
            'Sandbender tribes of the Si Wong Desert have a unique, preserved version of these ingredients, carried in {Travel_Container_Desert}, a testament to their resourcefulness in the harsh environment when trading with {Desert_Oasis_Town}.',
            "Farmers in the fertile plains of the {EK_Province_Name} celebrate the harvest of {Staple_Crop_EK} with this dish, a symbol of abundance and the earth's generosity, often part of a {Local_Harvest_Festival_Name}.",
          ],
          fireNation: [
            "Originally crafted for the coronation feast of Fire Lord {Fire_Lord_Name} by Royal Chef {FN_Chef_Name}, this delicacy was once reserved only for the royal family and high-ranking officials in Caldera City's {Royal_Palace_Wing}.",
            "Sun Warrior shamans, in the hidden city of {Sun_Warrior_City_Name}, would prepare a ritually similar dish before communing with the dragon masters {Dragon_Name1} and {Dragon_Name2}, believing its fiery essence pleased the ancient spirits. Some say it involves an ancestral infusion technique, channeling the fire's spirit directly into the ingredients.",
            'Ember Island chefs developed this recipe to tantalize the palates of vacationing nobles staying at {Ember_Island_Resort}, a perfect blend of spice, sweetness, and seaside freshness, often served during the {Ember_Island_Event}.',
            'The intense flavors are said to mirror the passionate spirit of the Fire Nation people, a culinary expression of their drive and ambition, as taught in the {FN_Academy_Name} curriculum on cultural cuisine.',
            'Blacksmiths and artisans in Fire Nation industrial towns like {FN_Industrial_Town} would enjoy a simpler, spicier version of this to fuel their demanding work by the forges that produce {FN_Manufactured_Good}.',
          ],
          unitedRepublic: [
            "Born in the bustling, diverse kitchens of Republic City's {Specific_Borough_URC}, this dish is a testament to the innovative spirit of culinary fusion that defines the metropolis, championed by chefs like {URC_Fusion_Chef_Name}.",
            'Pro-bending athletes, like the legendary {Pro_Bender_Team_Name}, often favor this dish for its energizing properties, a quick and satisfying meal between intense training sessions at the {Pro_Bending_Arena_Location}.',
            "Varrick Global Industries once tried to mass-produce a version of this as 'Varrick's {Adjective} {Dish_Type} Supreme!', with 'mixed' (and comically explosive) results, though the original artisan recipe from {Artisan_Shop_Name} remains beloved.",
            'This dish became popular in the noodle shops around Central Station, a favorite among travelers and city dwellers alike for its comforting yet exciting flavors, especially after a long {Mode_Of_Transport} journey.',
            "Future Industries' top engineers, under the guidance of {Asami_Or_Engineer_Name}, supposedly brainstormed some of their greatest inventions, including the {Invention_Name}, over shared bowls of this inspiring meal.",
          ],
          spiritWorld: [
            "This recipe is not 'cooked' but 'remembered' from the dreams of spirits, often appearing spontaneously near places of strong emotional resonance like {Spirit_World_Landmark_Emotional}. The preparation itself is akin to dream_weaving, coaxing flavors from pure thought and memory.",
            "It is said that only those who have {Lost_Or_Gained_Something_Spiritual} can truly perceive its subtle flavors, which change with the observer's own spirit.",
            'Ancient spirits like {Named_Spirit_Being} are rumored to offer this to mortals who wander into their domain, as a test of their heart or a gift of forgotten wisdom.',
            'The ingredients are not of the mortal realm but are manifestations of pure emotion or memory: the sweetness of first love ({Emotion_Sweet}), the bitterness of regret ({Emotion_Bitter}), the warmth of courage ({Emotion_Warm}).',
            'To consume this dish is to partake in a {Spiritual_Journey_Type}, often leading to visions or a deeper understanding of oneself and the interconnectedness of all things, like staring into {Reflective_Spirit_Surface}.',
          ],
        },
        byTheme: {
          Spiritual: [
            "Believed to be a recipe whispered by a benevolent spirit to a devout monk during a {Lengthy_Meditation_Period} at {Sacred_Site_Generic}. The preparation might involve ritualistic 'dream_weaving' of flavors or channeling spiritual energy.",
            'This dish is often prepared as an offering during rituals to appease or honor the spirits of {Honored_Entity}, especially during {Celestial_Event_Spiritual}.',
          ],
          Royal: [
            'A closely guarded recipe of the {Royal_Family_Name} dynasty, served only at state banquets to impress {Visiting_Dignitary_Type}.',
            'Legend says Avatar {Royal_Avatar_Name} once declared this the finest dish in all four nations during a visit to the {Royal_Capital_Generic} palace.',
          ],
          Rustic: [
            'A staple in the remote village of {Rustic_Village_Name}, made with ingredients foraged from the surrounding {Natural_Landscape_Rustic} and cooked over an open hearth.',
            'This recipe has been passed down for generations among {Rural_Profession_Plural}, a testament to their resilience and connection to the land.',
          ],
          Innovative: [
            'Developed in the experimental kitchens of {Innovative_City_Name} by the visionary chef {Innovator_Chef_Name}, this dish pushes the boundaries of traditional cuisine.',
            'Some say the secret lies in a unique {Technological_Process_Or_Device} developed at {Research_Institution_Innovative}, revolutionizing how {Core_Ingredient_Type} is prepared.',
          ],
          Street: [
            'This bustling market favorite, conceived by a clever street vendor in {nation_place}, became an instant sensation due to its bold flavors and portable nature.',
            'Legend has it this was the go-to fuel for early {Bender_Type} pro-benders, providing quick energy during intense matches in the back alleys of {Urban_Street_Area}.',
          ],
          Traveler: [
            'Designed for the long road, this dish can be prepared with minimal equipment and lasts for days, a true companion for wanderers traversing the {Travel_Route}.',
            'It‚Äôs said that {Legendary_Traveler} devised this recipe during their epic journey across the {Geographical_Feature}, using only what could be carried in a saddlebag.',
          ],
        },
        byIngredientHint: {
          'Moon Peach': [
            'Said to only ripen under the light of a specific lunar phase, granting serene dreams to those who consume it.',
          ],
          'Luminous Fungi Clusters': [
            'These fungi are said to grow only where a powerful spirit has passed, absorbing its residual energy and glowing with an inner light.',
          ],
          'Spirit Bloom Essence': [
            'This essence is said to capture the fleeting laughter of playful spirits, lending an otherworldly joy to any dish.',
          ],
          'Ghost Peppercorns': [
            'These nearly translucent peppercorns offer a warmth that feels more like a memory than a sensation, a phantom spice from a forgotten time.',
          ],
          'Sunstone Mangoes': [
            "Grown only on volcanic slopes kissed by the dawn sun, these mangoes are said to hold the warmth of a dragon's heart.",
          ],
          Emberberries: [
            'These rare berries smolder with a gentle heat, a favorite treat during Fire Nation solstice celebrations.',
          ],
          'Spiced Fire Lily Nectar': [
            "This nectar, derived from the rare Fire Lily that blooms only under specific astrological alignments, is believed to infuse dishes with a warrior's spirit and a sage's calm.",
          ],
        },
        _placeholders: {
          Generic_Controversy: [
            'Some traditionalists scoffed, calling it an affront to classic flavors, but younger generations embraced its daring spirit.',
            "Its potent aroma was said to either invigorate the senses or cause mild hallucinations, depending on the diner's constitution.",
            'While beloved by many, whispers persisted that its true recipe was lost to a forgotten conflict, making modern versions mere echoes.',
            'Some found its intensity overwhelming, while others declared it a revelation, sparking fierce culinary debates across the region.',
          ],
          Pilgrimage_Trail: [
            "Serpent's Pass",
            "Guru Pathik's route",
            "Avatar Roku's final journey path",
            'the ancient Air Nomad trading routes',
            "the Sun Warrior's secret path",
            'the Spirit Wilds border trail',
            'the Dragon Bone Path',
            "the Eastern Air Temple's hidden trails",
            'the Whispering Peaks ascent',
          ],
          Weather_Event: [
            'sudden monsoon',
            'fierce sandstorm',
            'gentle spirit fog',
            "Sozin's Comet's passing",
            'an unexpected aurora',
            'a rare eclipse',
            'the blossoming of the Spirit Lilies',
            'a meteor shower',
            'a powerful chi-storm',
            'a torrential downpour',
            'a freezing blizzard',
            "a dust devil's dance",
          ],
          role_plural: [
            'merchants',
            'travelers',
            'farmers',
            'elders',
            'warriors',
            'students',
            'artisans',
            'Dai Li agents (off-duty)',
            'monks',
            'healers',
            'storytellers',
            'spirit guides',
            'pro-benders',
            'fisherfolk',
            'scholars',
            'architects',
            'palace guards',
            'metalbenders',
            'fire sages',
            'swamp benders',
            "earth kings' advisors",
            'sky bison herders',
            'nomadic traders',
            'city engineers',
          ],
          nation_place: [
            "Ba Sing Se's Lower Ring",
            "Omashu's delivery system hub",
            'a Caldera City teahouse',
            "the Southern Air Temple's refectory",
            "the Northern Water Tribe's festival grounds",
            "Republic City's harbor district",
            'a remote Earth Kingdom village near Full Moon Bay',
            'an Ember Island beach shack',
            'a hidden Spirit Oasis',
            "a bustling street in Republic City's Lower Ring",
            "the Foggy Swamp's edge",
            "Kyoshi Island's village",
            'the Fire Nation Royal Palace kitchen',
            "Zaofu's industrial district",
            'Whale Tail Island',
            'the Western Air Temple ruins',
            'the Eastern Air Temple gardens',
          ],
          Secret_Medium: [
            'the back of a Pai Sho tile',
            'a coded message within a fan',
            'a song passed down through bards',
            'a pattern woven into a tapestry',
            'a whisper on the wind',
            'a sequence of hand gestures',
            'an ancient waterbending scroll',
            'etchings on a lost geode',
            'a secret passage in a mountain cave',
            'a spirit vine inscription',
            'the forgotten lines of a forgotten poem',
          ],
          Rural_Region: [
            'a quiet farming village in the Earth Kingdom plains',
            'a secluded Air Nomad mountain hermitage',
            'a small fishing outpost in the Water Tribes',
            'a Fire Nation colonial settlement',
            'the border of the Spirit Wilds',
            'the hidden valleys of the Foggy Swamp',
            'a remote coastal village',
            'the desert oasis of Si Wong',
            'the mist-shrouded valleys of the Earth Kingdom',
            'an isolated island commune',
          ],
          Dignitary_Type: [
            'Earth Kingdom governor',
            'Fire Nation general',
            'Water Tribe chieftain',
            'Air Nomad elder council member',
            'United Republic senator',
            'a renowned playwright',
            'a visiting Spirit Elder',
            'a traveling Avatar',
            'a respected merchant prince',
            'a famed philosopher',
            'a celebrated artist',
            'a master inventor',
            'a foreign dignitary',
            'a wise guru',
          ],
          Academic_Institution: [
            'Ba Sing Se University',
            'the Royal Fire Academy for Girls (archives section)',
            "Wan Shi Tong's Library (before it vanished)",
            'the Air Nomad historical archives',
            'the Zaofu Academy of Innovation',
            "the Northern Water Tribe's Sages' Council",
            'the Library of Omashu',
            "Republic City's Grand Archives",
            "the Sun Warrior's ancient scrolls",
          ],
          nation_name: [
            'the Air Nomads',
            'the Water Tribes',
            'the Earth Kingdom',
            'the Fire Nation',
            'the United Republic',
            'the Spirit Realm',
            'the Four Nations',
          ],
          Natural_Feature: [
            'the great volcanoes',
            'the vast oceans',
            'the unyielding mountains',
            'the ever-present sky',
            'the Spirit Wilds',
            'a shimmering waterfall',
            'a lush swamp',
            'the fertile plains',
            'a hidden hot spring',
            'a serene bamboo forest',
            'the Crystal Catacombs',
            'the Whispering Chasms',
            'the Great Divide',
            'the Boiling Sea',
          ],
          Artifact_Type: [
            'set of ancient Pai Sho tiles',
            'petrified scroll case',
            'geode containing inscribed crystals',
            'series of cave paintings',
            'a spirit-touched amulet',
            'a fragment of ancient pottery',
            'a carved bone relic',
            'a forgotten airbending staff',
            'a ceremonial bending scroll',
            'a piece of ancient metalbending armor',
            'a spirit-imbued chime',
            'a forgotten compass',
          ],
          Ancient_Avatar_Name: [
            'Szeto',
            "Yangchen's predecessor",
            'Salai',
            'Gun',
            'Wan (in spirit lore)',
            'Kuruk',
            'Kelsang',
            'Yee-li',
            'Kyoshi',
            'Roku',
          ],
          Seasonal_Festival: [
            'Winter Solstice celebration',
            'Avatar Day festivities',
            'Fire Days Festival',
            'Harvest Moon Festival',
            "Spirits' Eve",
            'Festival of the Flying Fish Kites',
            'Bloom of the Spirit Lights Festival',
            'the Cabbage Patch Festival',
            "the Ice Dodger's Feast",
            'the Great Earth Rumble',
            'the Dragon Dance Festival',
            "the Serpent's Tail Carnival",
            'the Lantern Rite',
            'the Festival of Whispering Winds',
          ],
          Nation_Capital: [
            'the Southern Air Temple (historically)',
            "Agna Qel'a (Northern Water Tribe capital)",
            'Ba Sing Se',
            'Caldera City',
            'Republic City',
            'a known spirit crossroads',
            'Omashu',
            'Zaofu',
            'Kyoshi Island village',
          ],
          Festival_Activity: [
            'storytelling',
            'traditional dances',
            'lantern lighting',
            'communal feasts',
            'bending displays',
            'spirit offerings',
            'firework displays',
            'competitive eating',
            'shared songs',
            'kite flying',
            'dragon boat races',
            'ice sculpting contests',
            'earth bending parades',
            'sky bison riding demonstrations',
          ],
          Air_Temple_Name: [
            'Southern',
            'Northern',
            'Eastern',
            'Western',
            'forgotten Sky Peak',
            'Whistling Mountain Hermitage',
            'Dragonbone Ridge',
            'Cloud Whisper Sanctuary',
            'Aero Plateau Temple',
          ],
          Time_Of_Day: [
            'sunrise',
            'midday',
            'sunset',
            'starlight',
            'the twilight hour',
            'dawn',
            'the deepest night',
            'the first light of morning',
            'the moment of quiet contemplation',
          ],
          Air_Avatar_Name: [
            'Yangchen',
            'Aang',
            'an unnamed predecessor',
            'Guru Laghima (as an enlightened master)',
            'Kelsang',
          ],
          Air_Monk_Mentor: [
            'Monk Gyatso',
            'Sister Iio',
            'an elder Sky Bison riding master',
            'a wise Abbess',
            'a compassionate Guru',
            'Monk Tashi',
            'Master Jinora',
            'Sifu Koyo',
          ],
          Sky_Creature: [
            'Sky Bison calf',
            'Dragon Moose',
            'Giant Condor Vulture',
            'a friendly Wind Spirit',
            'a flock of Winged Lemurs',
            'a rare Air Dragon',
            'a cloud-serpent',
            'a feathered sky-lizard',
            'a serene Wind Drake',
          ],
          Air_Guru_Name: [
            'Pathik',
            'Laghima',
            'Shoken',
            'a forgotten hermit',
            'a wise old Nun',
            'Guru Jinpa',
            'Guru Tseng',
          ],
          Spiritual_Concept: [
            'the nature of chi paths',
            'the illusion of separation',
            'the path to enlightenment',
            'the song of the universe',
            'the interconnectedness of all life',
            'the void',
            'the breath of creation',
            'the stillness within',
            'the dance of energy',
            'the harmony of elements',
            'the cycle of rebirth',
            'the oneness of being',
          ],
          Mountain_Range: [
            'Patola Mountain Range',
            'Kolau Mountain Range',
            'Red Lotus Cliffs (figuratively)',
            "the Serpent's Spine",
            'the Great Divide',
            'the Cloud Serpent Mountains',
            'the Northern Peaks',
            "the Dragon's Tooth Range",
            'the Whispering Mountains',
          ],
          Specific_Mountain_Herb: [
            'Cloud-kissed Sage',
            'Zephyr Mint',
            'Sunstone Marigold',
            'Whisperwind Petals',
            'Summit Thyme',
            'Skyflower Nectar',
            'Moonleaf',
            'Aura Root',
            'Spirit Blossom',
          ],
          Wild_Nut_Type: [
            'Cloud Pine Nuts',
            'Stone Acorns',
            'Highland Walnuts',
            'Skyberries',
            'Mountain Almonds',
            'Aerotree Pods',
            'Wind-blown Hazelnuts',
            'Cliffside Chestnuts',
          ],
          Landmark_Air_Nomad: [
            'Avatar Aang Memorial Island',
            'a hidden meditation cave',
            'the highest peak of Patola',
            'an ancient sky shrine',
            'the Whispering Chasms',
            'the Eye of the Storm',
            'the Golden Cloud Sanctuary',
            'the Cloud-Seeded Plateau',
          ],
          Lunar_Event: [
            'full moon high tide',
            "new moon's deep night",
            'the bi-annual Spirit Moon convergence',
            'the Night of Whispering Tides',
            'the Twin Moon Festival',
            'the ebb of the tides',
            'the Blood Moon phase',
            'the celestial dance of Yue',
          ],
          Sacred_Water_Site: [
            'Spirit Oasis',
            'a hidden iceberg shrine',
            'the source of a sacred river',
            'the Crystal Caves of the North',
            'the Great Waterfall of the South',
            'the Silent Fjord',
            'the glowing tide pools',
            'the Heart of the Ocean',
          ],
          Water_Tribe_Region: [
            "Northern Water Tribe's inner sanctum",
            "Southern Water Tribe's main village",
            'the heart of the Foggy Swamp',
            'the remote Ice Shelf settlements',
            'the Misty Fjords',
            'the Moonstone Shores',
            'a hidden grotto on Crescent Island',
            'the Eastern Sea Islands',
          ],
          Hunter_Title: [
            'Master Hunter',
            'Ice Stalker',
            'Seal Brother/Sister',
            'Guardian of the Frozen Wastes',
            'Tundra Tracker',
            'Deep Sea Angler',
            'Polar Bear Dog Handler',
            'Icewalker',
            'Whale-Shark Tamer',
          ],
          Arctic_Animal: [
            'Arctic Hippo',
            'Tiger Seal',
            'Giant Polar Bear Dog',
            'Moon Puffin',
            'Snow Leopard',
            'Penguin (Giant)',
            'Wolf-Shark',
            'Ice Weasel',
            'Sea Vulture',
          ],
          Swamp_Plant_Type: [
            'Vine Mint',
            'Glow_moss',
            'Spirit Water Lily',
            'Murkroot',
            'Whisper_reed',
            'Banyan Blossom',
            'Misty Fern',
            'Rooted Mushroom',
            'Bog Orchid',
          ],
          Rare_Swamp_Ingredient: [
            "petrified frog slime (don't ask)",
            'singing mudskipper eggs',
            'wisdom-granting roots (rumored)',
            'Banyan Tree sap',
            'glowing firefly dust',
            'spirit-touched swamp gas',
            'whispering moss',
            'ancient bog crystal',
            'deep-water fungus',
          ],
          Healer_Master_Name: [
            'Yagoda',
            'Kya (as a master)',
            'a legendary Foggy Swamp healer',
            'the Elder Shaman of the Mist',
            'Master Pakku (for ice therapy)',
            'Healer Kana',
            'Elder Hama (before she got weird)',
            'Healer Miko',
          ],
          Geothermal_Feature_Water: [
            'underwater volcanic vents',
            'ice_trapped hot springs',
            'spirit-warmed geysers',
            "the Boiling Sea's edge",
            'bubbling mud pots',
            'the geysers of the Western Isles',
            'the hot springs of the Southern Peaks',
            'the thermal vents of the Great Chasm',
          ],
          Legendary_Waterbender_Chef: [
            "Kuruk's personal cook",
            'the first bender to flash_freeze fruit',
            'a mythical swamp bender who cooked with fog',
            'the Ice Sculptor Chef',
            "Hama's apprentice (before she got weird)",
            'Master Yugoda (culinary arts)',
            'Chef Liling',
            'Chef Naktu',
          ],
          Historical_EK_Leader: [
            'the 52nd Earth King',
            'a powerful Earth Queen',
            'the founder of Omashu',
            'General Fong (in a culinary context)',
            'a revered Earthbending Master',
            'King Bumi',
            'President Raiko (for URC lore)',
            'Earth King Kuei',
          ],
          Specific_District_Omashu: [
            'Upper Market',
            'Lower Chute District',
            "Artisan's Quarter",
            'the Royal Gardens district',
            'the Spice Bazaar',
            "the Earthbender's Guild Hall",
            'the Delivery System Junction',
            'the Great Canyon market',
            'the Jade Quarter',
          ],
          Kyoshi_Warrior_Trainer: [
            "Suki's predecessor",
            'a veteran Kyoshi warrior',
            'Avatar Kyoshi herself (in spirit)',
            "the Island's Eldest Protector",
            'Master Yukari',
            'Headmistress Chiyo',
            'General Miyuki',
            'Mistress Kinu',
          ],
          Warrior_Ritual: [
            'pre_dawn training',
            'annual island defense drill',
            'initiation ceremony',
            'the Dance of the Fans',
            'the meditation of the immovable rock',
            'the trial of the cliff',
            'the sacred oath ceremony',
            'the stone-throwing contest',
            'the silent vigil',
          ],
          Travel_Container_Desert: [
            'cured sand shark stomach',
            'hollowed giant cactus',
            'clay_sealed gourds',
            'woven dune grass baskets',
            'a preserved Lizard-Lion bladder',
            'a sand_hardened leather pouch',
            "a desert_dweller's satchel",
            "a nomad's waterskin",
          ],
          Desert_Oasis_Town: [
            'Misty Palms Oasis',
            "Serpent's Pass Inn (if it were an oasis)",
            'a hidden sandbender trading post',
            'the Sunstone Wellspring',
            'the town of Gaoling',
            'the Shifting Sands Market',
            'Scorpion Springs',
            'Emerald Oasis',
          ],
          EK_Province_Name: [
            'Gaoling Province',
            'Holu Province',
            'the Chin Village region',
            'the Si Wong Plains',
            "the Serpent's Pass highlands",
            'the Yu Dao valley',
            'the Full Moon Bay area',
            "Huan's Sculpture Valley",
            'the Foggy Swamp borders',
          ],
          Staple_Crop_EK: [
            'rice',
            'cabbage',
            'tea leaves',
            'jennamite (jokingly)',
            'earth_grown tubers',
            'turnips',
            'ginseng root',
            'green beans',
            'tofu (Earth Kingdom style)',
            'omashu peaches',
            'mining vegetables',
          ],
          Local_Harvest_Festival_Name: [
            'Great Earth Dragon Festival',
            'Festival of the Generous Badger_Mole',
            'Moon Peach Harvest Fair',
            "King Bumi's Cabbage Day (local tradition)",
            'the Clay Pot Festival',
            'the Festival of the Flourishing Fields',
            'the Grand Omashu Market Fair',
            'the Rock Candy Festival',
          ],
          Fire_Lord_Name: [
            'Sozin',
            'Azulon',
            'Ozai',
            'Zuko',
            'an ancient Fire Lord',
            'Izumi',
            'Ryo',
            'Iroh I',
          ],
          FN_Chef_Name: [
            'Chef Satoru (fictional)',
            "the Fire Sages' cook",
            'a captured Earth Kingdom chef forced to innovate',
            'the Royal Volcanic Cuisine Master',
            "the Ember Island Players' private chef",
            'Master Ren',
            'Chef Shiro',
            'Chef Kanto',
          ],
          Royal_Palace_Wing: [
            'Western Air Temple (during Fire Nation occupation, ironically)',
            "the Fire Lord's private dining chambers",
            'the Royal Archives kitchen',
            'the Dragon Throne Banquet Hall',
            'the Obsidian Gallery',
            'the Eastern Pavilion',
            'the Imperial Gardens',
            'the Volcano View Dining Hall',
          ],
          Sun_Warrior_City_Name: [
            'the Hidden Sun Citadel',
            "Dragon's Peak Sanctuary",
            'the Eternal Flame Village',
            'the City of Dancing Flames',
            'the Burning Heart Temple',
            'the Obsidian Oasis',
            'the Sacred Fire Grove',
          ],
          Dragon_Name1: [
            'Ran',
            "Fang (Roku's Dragon)",
            "Druk (Zuko's Dragon)",
            'Glowy (fictional young dragon)',
            'Habanero (fictional)',
            'Scorch',
          ],
          Dragon_Name2: [
            'Shaw',
            "Sozin's personal dragon (unnamed)",
            'a young Sun Dragon',
            'Blaze (fictional young dragon)',
            'Scorch (fictional)',
            'Ignis',
          ],
          Ember_Island_Resort: [
            'The Royal Caldera Spa',
            "Lo and Li's Beach Bungalows (secretly)",
            "The Ember Island Players' Retreat",
            'The Fire Lily Hotel',
            'The Sunset Cliff Villas',
            'The Golden Shore Resort',
            'The Blazing Sands Inn',
          ],
          Ember_Island_Event: [
            'Summer Solstice Beach Party',
            "Fire Lord's Birthday Getaway",
            'the annual Volcano Surfing competition',
            'the Fire Flake Festival',
            'the Ember Island Talent Show',
            'the Burning Sands Regatta',
            'the Festival of Whispering Embers',
          ],
          FN_Academy_Name: [
            'Royal Fire Academy for Boys',
            'The School of Imperial Flame',
            'The Young Phoenix Military Institute',
            'The Caldera Culinary Institute',
            'The Dragon Dance Academy',
            'The Burning Fist Academy',
            'The Obsidian Arts School',
            'The Fire Lily Academy',
          ],
          FN_Industrial_Town: [
            'the Capital Shipyards district',
            'a coal mining town near the coast',
            "the Pohuai Stronghold's armory",
            'the Black Cliffs Foundry',
            'the Cinder Islands',
            'the Iron Mines of the West',
            "Combustion Man's old stomping grounds",
            'the Obsidian Mines of Zao',
          ],
          FN_Manufactured_Good: [
            'war machines',
            'refined steel',
            'obsidian glass',
            'Fire Nation propaganda posters',
            'intricate metalwork',
            'airships',
            'fireworks',
            'uniforms',
            'tanks',
            'bending-tech weapons',
            'luxury goods',
          ],
          Specific_Borough_URC: [
            'Dragon Flats Borough',
            'Harmony Tower District',
            'Little Ba Sing Se',
            'The Silk Road Marketplace',
            'Avatar Korra Park Food Stalls',
            'Central Station Plaza',
            'the Industrial District',
            'Air Temple Island (for non_Air Nomads)',
            'Pro-Bending District',
            'Future Industries Park',
          ],
          URC_Fusion_Chef_Name: [
            "Chef 'Fusion' Fong",
            'Madame Silk (a mysterious restaurateur)',
            'a former Pro_Bender turned cook',
            "Bolin's 'Mover Star' Cafe (hypothetical)",
            "Mako's Noodle Bar (also hypothetical)",
            'Chef Asami (hypothetical)',
            "Kai's Sky Noodle Stand",
            'Chef Tenzin (culinary experiments)',
            'Chef Hiroshi Sato (post-villainy, if applicable)',
          ],
          Pro_Bender_Team_Name: [
            'Fire Ferrets',
            'Wolfbats',
            'Red Sands Rabaroos',
            'Black Quarry Boar_q_pines',
            'Zaofu Metal Clan Crushers',
            "Lightning Bolt Zolt's Squad",
            'Triple Threat Triads (culinary branch)',
            'the Golden Drifters',
            'the Omashu Comet-Cats',
          ],
          Pro_Bending_Arena_Location: [
            'the main Republic City Arena',
            'a training gym in the industrial sector',
            'a secret underground pro-bending circuit',
            "Air Temple Island's training grounds (informal)",
            'Future Industries Arena',
            'the Dragon Flats Practice Ring',
            "Amon's hideout (ironically)",
            'the Harmonic Convergence Stadium',
          ],
          Adjective: [
            'Incredible',
            'Questionable',
            'World_Famous',
            'Explosive',
            'Harmonious',
            'Dynamic',
            'Spirited',
            'Delicious',
            'Controversial',
            'Revolutionary',
            'Electrifying',
            'Experimental',
            'Iconic',
            'Avant_Garde',
          ],
          Artisan_Shop_Name: [
            "'The Harmonious Bite' Cafe",
            "'Four Nations One Plate' Eatery",
            'a humble street food cart with a cult following',
            "Pabu's Snack Shack",
            "'The Bending Bowl'",
            'The Golden Dragon Noodle House',
            'Cabbage Corp Food Stand (pre_bankruptcy)',
            'The United Republic Tea Shop',
            "Momo's Treats",
          ],
          Mode_Of_Transport: [
            'Sato_mobile',
            'Airship',
            'Ocean Liner',
            'Train',
            'Future Industries Monorail',
            'ferry',
            'probending transport',
            'sky bison (if appropriate)',
            'zeppelin',
            'motorcycle',
            'metalbending vehicle',
          ],
          Asami_Or_Engineer_Name: [
            'Asami Sato',
            'Chief Engineer Hiroshi (pre_villainy, or post_redemption if applicable)',
            'a brilliant Cabbage Corp engineer (ironically)',
            'a Zaofu architect',
            'Bolin (as a mover star)',
            'Wonyong Keum (head of Future Industries culinary division)',
            'Lin Beifong (for her precise culinary tastes)',
          ],
          Invention_Name: [
            'the next generation Satomobile engine',
            'a more efficient power plant for the city',
            "a self-stirring noodle bowl (Varrick's idea)",
            'the Platinum Mech Suit prototype',
            'a chi-powered generator',
            'the spirit-energy conductor',
            'a sonic food processor',
            'a rapid-cooling device',
            'a geothermal oven',
          ],
          Spirit_World_Landmark_Emotional: [
            'a weeping willow tree by a forgotten pond',
            'the ruins of an ancient shrine',
            'a bridge between realities',
            'the Cave of Two Lovers (spirit side)',
            "the Banyan Grove Tree's roots",
            'the Fog of Lost Souls',
            'the Spirit Oasis at the Northern Water Tribe',
            "the Spirit World Library (Wan Shi Tong's)",
            'the Crystal Catacombs of the Spirit World',
            'the Whispering Falls',
            'a glowing spirit pool',
            "the Spirit Wilds' heart",
          ],
          Lost_Or_Gained_Something_Spiritual: [
            'lost their way',
            'found profound peace',
            'faced their greatest fear',
            'made a heartfelt sacrifice',
            'understood their true destiny',
            'merged with a spirit',
            'witnessed a vision',
            'embraced their bending',
            'overcame a great challenge',
            'found a lost love',
            'gained ancient wisdom',
            'confronted a dark past',
          ],
          Named_Spirit_Being: [
            'Hei Bai',
            'Wan Shi Tong',
            'Koh the Face Stealer (if you dare)',
            'the Mother of Faces',
            'a friendly Dragonfly Bunny Spirit',
            'the Painted Lady',
            'Tui and La (as a pair)',
            'Raava (in memory)',
            'Vaatu (in shadow)',
            'Aye_aye Spirit',
            "Sparky Sparky Boom Man's spirit (joke)",
            'General Old Iron',
            'Chao',
            "June's spirit",
            'the Cat Deer Spirit',
          ],
          Emotion_Sweet: [
            "the innocent joy of a child's laughter",
            'the comfort of a long_lost memory',
            'the bloom of a first crush',
            'the peace of deep slumber',
            'the warmth of a friendly gaze',
            'the hope of a new dawn',
            'the tranquility of a quiet moment',
            'the purity of first light',
          ],
          Emotion_Bitter: [
            'a silent tear shed in solitude',
            'the sting of betrayal',
            'the fading echo of a harsh word',
            'the sorrow of a forgotten promise',
            'the chill of despair',
            'the weight of regret',
            'the bite of injustice',
            'the sharp edge of truth',
          ],
          Emotion_Warm: [
            'the unwavering resolve of a protector',
            'the glow of shared understanding',
            'the fire of righteous anger',
            'the embrace of true friendship',
            'the comfort of home',
            'the strength of conviction',
            'the quiet joy of a reunion',
            'the fierce loyalty of a companion',
          ],
          Spiritual_Journey_Type: [
            "pilgrimage into one's own heart",
            'dance with shadows and light',
            'glimpse of the cosmic tapestry',
            'trek through the inner self',
            'a voyage through dreams',
            'a moment of pure enlightenment',
            'a discovery of inner peace',
            'a walk through timeless realms',
            'a contemplation of the void',
          ],
          Reflective_Spirit_Surface: [
            'a perfectly still spirit pool',
            'the multifaceted eye of a wisdom spirit',
            'a shimmering mirage in the spirit wilds',
            'the mirror of self_reflection',
            'the surface of a clear mountain spring',
            'a spirit_touched lake',
            'the polished shell of a spirit turtle',
            "the depths of a sky bison's eyes",
          ],
          Lengthy_Meditation_Period: [
            'a three_day trance',
            'a moon_cycle retreat',
            'a season of silent contemplation',
            'a hundred breaths',
            'a night under the aurora',
            'a year of seclusion',
            'a timeless moment',
            'a spiritual vigil',
            'an extended chi-block session',
          ],
          Sacred_Site_Generic: [
            'a hidden mountain monastery',
            'a sacred grove',
            'an ancient temple ruin',
            'a spirit_touched spring',
            'a hallowed banyan tree',
            'a secluded waterfall shrine',
            'a crystal cavern',
            'a forgotten altar',
            'a sunstone circle',
          ],
          Honored_Entity: [
            'ancestors',
            'nature spirits',
            'the moon and ocean',
            'the balance of the world',
            'the Four Elements',
            'the first benders',
            'the Avatar Lineage',
            'the ancient spirits of the forest',
            'the patrons of industry',
          ],
          Celestial_Event_Spiritual: [
            'a rare planetary alignment',
            'the passing of a spiritual comet',
            'the solstice',
            'a meteor shower',
            'the spirit bloom',
            'a solar eclipse',
            'a celestial convergence',
            'the Dance of the Fireflies',
            "the Aurora's Embrace",
          ],
          Royal_Family_Name: [
            "Earth King's lineage",
            "Fire Lord's dynasty",
            'the ancient Sun Warrior chiefs',
            'the Beifong clan',
            'the Royal House of Fire',
            'the Water Tribe Chieftain line',
            'the Royal House of Earth',
          ],
          Visiting_Dignitary_Type: [
            'an ambassador from a rival nation',
            'a powerful spiritual leader',
            'a celebrated artist',
            'a foreign dignitary',
            'a famous philosopher',
            'a renowned inventor',
            'a master architect',
            'a diplomatic envoy',
          ],
          Royal_Avatar_Name: [
            'Kyoshi (in her capacity as a stateswoman)',
            'Roku (navigating courtly life)',
            'Szeto (as a Fire Nation bureaucrat)',
            'Aang (as a diplomat)',
            'Korra (as a unifying force)',
            'Kuruk (as a statesman)',
            'Yangchen (as a spiritual leader)',
          ],
          Royal_Capital_Generic: [
            'Fire Nation Capital',
            'Ba Sing Se',
            "Agna Qel'a",
            'Zaofu',
            'Republic City (for royal functions)',
            'Omashu',
          ],
          Rustic_Village_Name: [
            'Pondlily Creek',
            'Stone Hollow',
            'Whisperwind Vale',
            'Flickerwick Hamlet',
            'Mud Gulch',
            'Opal Village',
            'Twin Falls Hamlet',
            'Willowbrook Community',
            'Cactus Ridge Outpost',
          ],
          Natural_Landscape_Rustic: [
            'deep woods',
            'rolling hills',
            'coastal cliffs',
            'fertile valleys',
            'tundra',
            'sun_drenched plains',
            'a tranquil riverside',
            'misty highlands',
            'dense bamboo forests',
            'sandy dunes',
          ],
          Rural_Profession_Plural: [
            'farmers',
            'shepherds',
            'fisherfolk',
            'woodcutters',
            'miners',
            'potters',
            'weavers',
            'basket makers',
            'herbalists',
            'carpenters',
            'hunters',
          ],
          Innovative_City_Name: [
            'Zaofu',
            "Republic City's tech district",
            'the Northern Air Temple (post_Korra reconstruction)',
            'Future Industries HQ',
            'New Omashu (as a tech hub)',
          ],
          Innovator_Chef_Name: [
            'Suyin Beifong (if she took up cooking)',
            'a rogue Future Industries scientist',
            'Varrick (with disastrous but interesting results)',
            'Hiroshi Sato (pre_villainy)',
            'Chef Jian (famous for bending innovations)',
            'Professor Zephyr',
            'Asami Sato (as a culinary engineer)',
          ],
          Technological_Process_Or_Device: [
            'sonic emulsifier',
            'geo_thermal oven',
            'chi-powered distiller',
            'magnetic induction plate',
            'hydro-pressure infuser',
            'spirit-energy condenser',
            'a specialized kinetic blender',
            'a plasma cutter (for ingredients)',
            'a molecular reconfigurator',
            'an atmospheric infuser',
          ],
          Research_Institution_Innovative: [
            "the Zaofu Metalbending Academy's R&D wing",
            'Future Industries Labs',
            "Cabbage Corp's secret experimental division",
            'Republic City Scientific Institute',
            'the Air Temple Island Botanical Gardens',
            "the Earth Kingdom's Geological Survey",
            "the Northern Water Tribe's Hydro-Technology Labs",
          ],
          Core_Ingredient_Type: [
            'vegetables',
            'grains',
            'meats',
            'even air currents (for Air Nomad tech)',
            'minerals',
            'seaweed',
            'fermented foods',
            'rare fungi',
            'synthetic protein',
            'algae-based components',
          ],
          Bender_Type: [
            'Earthbending',
            'Firebending',
            'Waterbending',
            'Airbending',
            'Metalbending',
            'Bloodbending (only in context of dark lore)',
            'Lavabending (rare)',
            'Energybending (rare)',
            'Lightningbending',
            'Combustionbending',
          ],
          Urban_Street_Area: [
            'Dragon Flats',
            'the factory district',
            'Chinatown',
            'the docks',
            'Pro_Bending Arena',
            'Republic City marketplace',
            'the bustling financial district',
            'the Lower Ring back alleys',
            'the Central Station plaza',
          ],
          Travel_Route: [
            'the Great Eastern Road',
            "the treacherous Serpent's Pass",
            'the Northern Sea Lanes',
            'the Misty Mountains',
            'the Southern Desert highway',
            'the Caldera coastline road',
            'the Spirit World Portal trails',
            'the ancient Silk Road',
            'the Nomadic Trails',
          ],
          Geographical_Feature: [
            'the Great Divide',
            'the Boiling Rock',
            "the Serpent's Pass",
            'the Endless Ocean',
            'the Si Wong Desert',
            'the Cloud Terraces',
            'the Crystal Catacombs',
            'the Whistling Canyon',
            "the Dragon's Head Peninsula",
            'the Polar Ice Caps',
            'the Great Banyan Grove',
          ],
        },
      };

      const DESCRIPTION_TEMPLATES = {
        base: [
          'The foundation is built upon {item_name}, providing a {dish_type_appropriate_canvas} for the flavors to unfold.',
          'At its core lies {item_name}, setting a {flavor_adjective} stage for the elements to come.',
          'This dish begins with the {grounded_texture} of {item_name}, offering a {dish_type_appropriate_start}.',
          'A rich canvas of {item_name} forms the soulful base of this creation, its {flavor_noun_phrase} a gentle introduction.',
          'The dish is anchored by {item_name}, its {texture_adjective} and {flavor_adjective} character laying a robust foundation.',
        ],
        primary: [
          'The heart of the dish features {item_name}, offering a {flavor_adjective} and {distinctive_quality} experience.',
          "Dominant notes from {item_name} take center stage, defining the dish's essential character.",
          '{item_name} serves as the primary element, its {unique_flavor_profile} and {flavor_noun_phrase} qualities shining through.',
          'Central to this culinary piece is {item_name}, bringing its {luscious_texture} and {flavor_adjective} essence to the forefront.',
          'The defining essence comes from {item_name}, whose {flavor_adjective} taste truly sets the tone.',
        ],
        accent: [
          'Striking accents are introduced by {item_name}, adding layers of {flavor_adjective} depth and intrigue.',
          'A surprising counterpoint from {item_name} elevates the composition with its {flavor_noun_phrase} touch.',
          'The palate is enlivened by {item_name}, which lends its {piquant_or_aromatic_quality} and {flavor_adjective} highlights.',
          'Subtle yet impactful, {item_name} weaves its {flavor_noun_phrase} throughout, creating delightful complexity.',
          'The flavor profile is enriched by {item_name}, offering a {flavor_adjective} twist.',
        ],
        seasoning: [
          'It is masterfully seasoned with {item_name}, its {flavor_noun_phrase} balancing and elevating all components.',
          'A careful application of {item_name} tunes the flavors to perfection, offering {a_sensation} and a {flavor_adjective} finish.',
          'The final balance is achieved through {item_name}, lending its {bright_or_deep_quality} and {flavor_adjective} character.',
          '{item_name} ties the elements together, its {flavor_noun_phrase} enhancing the overall harmony.',
          'The entire composition is brought to life by {item_name}, adding a {flavor_adjective} layer of taste.',
        ],
        garnish: [
          'Finally, a delicate flourish of {item_name} provides visual artistry and a final whisper of {flavor_noun_phrase}.',
          'The dish is crowned with {item_name}, adding a touch of {elegance_or_rusticity} and a hint of {texture_or_aroma} with its {flavor_noun_phrase}.',
          'A thoughtful scattering of {item_name} completes the presentation, its {visual_cue} and {flavor_noun_phrase} a feast for the senses.',
          'For the finishing touch, {item_name} lends its {subtle_flavor_essence} and aesthetic charm.',
          'The meal concludes with {item_name}, providing a {flavor_adjective} flourish and a final sensory note.',
        ],
      };

      function getDishTypeAppropriateBaseDesc(dishType, context) {
        const lightDishTypes = [
          'Beverage',
          'Nectar',
          'Dessert',
          'Appetizer',
          'Sauce/Condiment',
          'Salad',
        ];
        if (lightDishTypes.includes(dishType)) {
          return context === 'canvas'
            ? 'delicate canvas'
            : 'light and refreshing start';
        }
        return context === 'canvas'
          ? 'satisfying canvas'
          : 'hearty and welcoming start';
      }

      // DISH_TYPE_BLACKLIST_TAGS: Tags that are generally disallowed for certain dish types.
      const DISH_TYPE_BLACKLIST_TAGS = {
        Dessert: [
          'kimchi',
          'savory_scramble',
          'pickled',
          'fermented_savory',
          'pungent_spice',
          'strong_fish',
          'gamey_meat',
          'bitter_herb_dominant',
          'savory_broth_concentrate',
          'distinctly_savory_protein',
          'sour',
          'acidic',
          'umami',
        ],
        Nectar: [
          'kimchi',
          'savory_scramble',
          'pickled',
          'fermented_savory',
          'pungent_spice',
          'strong_fish',
          'gamey_meat',
          'bitter_herb_dominant',
          'savory_broth_concentrate',
          'distinctly_savory_protein',
          'heavy_grain',
          'starchy_vegetable_strong',
          'solid_food_component',
          'sour',
          'acidic',
          'umami',
        ],
        Beverage: [
          'kimchi',
          'savory_scramble',
          'pickled',
          'fermented_savory',
          'strong_fish',
          'gamey_meat',
          'savory_broth_concentrate',
          'distinctly_savory_protein',
          'heavy_grain_unprocessed',
          'starchy_vegetable_strong',
          'solid_food_component',
          'sour',
          'acidic',
          'umami',
        ],
        'Street Food': [
          'delicate',
          'ceremonial',
          'fine_dining',
          'fragile_garnish',
        ],
        Appetizer: [
          'heavy_grain',
          'gamey_meat',
          'starchy_vegetable_strong',
          'savory_broth_concentrate',
        ],
        Salad: ['heavy_grain', 'gamey_meat', 'starchy_vegetable_strong'],
      };
      // DISH_TYPE_BLACKLIST_INGREDIENT_NAMES: Specific ingredient names disallowed for certain dish types.
      const DISH_TYPE_BLACKLIST_INGREDIENT_NAMES = {
        Dessert: [
          'Kimchi_Spiced Tofu Scramble',
          'Common Root Vegetable',
          'Fermented Lotus Root Chips',
          'Kombu Kelp Strips',
          'Arctic Char',
          'Smoked Komodo Chicken Skewers',
          'Fermented Red Pepper Paste',
          'Basic Rice Vinegar',
          'Black Lava Salt',
        ],
        Nectar: [
          'Kimchi_Spiced Tofu Scramble',
          'Common Root Vegetable',
          'Fermented Lotus Root Chips',
          'Kombu Kelp Strips',
          'Arctic Char',
          'Smoked Komodo Chicken Skewers',
          'Fermented Red Pepper Paste',
          'Barley Tsampa',
          'Golden Terrace Rice',
          'Charred Yam Discs',
          'Tofu (Temple Made)',
          'Ginger_Soy Glazed Tofu Crumbles',
          'Basic Rice Vinegar',
          'Black Lava Salt',
        ],
        Beverage: [
          'Kimchi_Spiced Tofu Scramble',
          'Common Root Vegetable',
          'Fermented Lotus Root Chips',
          'Kombu Kelp Strips',
          'Arctic Char',
          'Smoked Komodo Chicken Skewers',
          'Fermented Red Pepper Paste',
          'Barley Tsampa',
          'Charred Yam Discs',
          'Ginger_Soy Glazed Tofu Crumbles',
          'Basic Rice Vinegar',
          'Black Lava Salt',
        ],
        'Street Food': [
          'Luminous Fungi Clusters',
          'Spirit Bloom Essence',
          'Ghost Peppercorns',
          'Silver Salt Crystals',
        ],
      };

      // TAG_SYNONYMS: For future normalization if needed. Not actively used for existing tags due to their current consistency.
      const TAG_SYNONYMS = {
        // "savory_scramble": ["savory_compatible", "protein_product"], // Example if tags varied
        // "starchy_vegetable_strong": ["vegetable", "starchy"]
      };

      let globalLoreHistory = new Set();
      const MAX_LORE_HISTORY = 3;

      const CANON_DATA = {
        airNomads: {
          // Doc: 'ingredients' holds categorized lists of ingredients for the Air Nomads.
          ingredients: {
            // Doc: 'dairy' for milk-based products.
            dairy: [
              {
                name: 'Sky Bison Yoghurt',
                type: 'dairy',
                rolePreference: ['primary', 'liquid', 'base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: true,
                tags: [
                  'creamy',
                  'fermented',
                  'air_nomad',
                  'staple',
                  'tangy',
                  'mild',
                  'vegetarian',
                  'dairy',
                  'sweet_compatible',
                  'nectar_base',
                  'dessert_base_ok',
                  'beverage_component',
                  'liquid_ish',
                  'sweet_sour_balance',
                ],
                rarity: 'common',
                flavorNotes: [
                  'creamy',
                  'tangy',
                  'mildly_sweet',
                  'refreshing',
                  'silken',
                  'yogurt-tang',
                  'cool-touch',
                ],
                loreHints: ['sky_bison', 'nomadic_spirit'],
              },
              {
                name: 'Butter (sky bison milk)',
                type: 'dairy',
                rolePreference: ['binder', 'seasoning'],
                canBeBase: false,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'fat',
                  'air_nomad',
                  'rich',
                  'vegetarian',
                  'dairy',
                  'sweet_compatible_binder',
                  'creamy',
                ],
                rarity: 'common',
                flavorNotes: [
                  'rich',
                  'creamy',
                  'nutty_undertone',
                  'smooth',
                  'melt-in-mouth',
                ],
                loreHints: ['sky_bison', 'monk_diet'],
              },
            ],
            // Doc: 'flavoringsHerbsSpices' for aromatic additions.
            flavoringsHerbsSpices: [
              {
                name: 'Lavender Buds',
                type: 'herb',
                rolePreference: ['accent', 'garnish', 'seasoning'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'floral',
                  'aromatic',
                  'air_nomad',
                  'delicate',
                  'calming',
                  'herb',
                  'sweet_compatible',
                  'sweet_herb',
                  'infusible_herb',
                  'beverage_component',
                  'fragile_garnish',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'floral',
                  'sweet_herbaceous',
                  'calming_aroma',
                  'gentle-perfume',
                  'airy-fragrance',
                ],
                loreHints: ['meditation', 'temple_garden'],
              },
              {
                name: 'Cracked Peppercorns',
                type: 'spice',
                rolePreference: ['seasoning'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'generic',
                  'pungent',
                  'spice',
                  'pungent_spice',
                  'savory_compatible',
                  'sharp',
                ],
                rarity: 'common',
                flavorNotes: [
                  'sharp_heat',
                  'woody',
                  'aromatic',
                  'biting-zing',
                  'earthy-spice',
                ],
                loreHints: ['monk_spice', 'universal'],
              },
              {
                name: "Air Sage's Herbal Mix",
                type: 'herb',
                rolePreference: ['seasoning', 'accent'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'herbal',
                  'aromatic',
                  'air_nomad',
                  'calming',
                  'medicinal',
                  'sweet_compatible',
                  'savory_compatible',
                  'infusible_herb',
                  'beverage_component',
                  'complex',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'complex_herbal',
                  'fresh_earthy',
                  'menthol_hint',
                  'cleansing',
                  'forest-fragrance',
                  'soothing',
                ],
                loreHints: ['monk_recipe', 'chi_balancing'],
              },
            ],
            // Doc: 'fruitsVegetablesFungi' for plant-based ingredients.
            fruitsVegetablesFungi: [
              {
                name: 'Moon Peach',
                type: 'fruit',
                rolePreference: ['primary', 'garnish', 'base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: true,
                tags: [
                  'sweet',
                  'juicy',
                  'air_nomad',
                  'delicate',
                  'stone_fruit',
                  'fruit',
                  'nectar_source',
                  'sweet_compatible',
                  'dessert_fruit',
                  'dessert_primary_ok',
                  'dessert_base_ok',
                  'beverage_component',
                  'fruit_puree_candidate',
                  'fragile_garnish',
                  'honeyed',
                ],
                rarity: 'common',
                flavorNotes: [
                  'honeyed_sweet',
                  'floral_aroma',
                  'velvety_texture',
                  'dream-like',
                  'succulent',
                  'luscious',
                ],
                loreHints: ['Moon Peach'],
              },
              {
                name: 'Tofu (Temple Made)',
                type: 'protein',
                rolePreference: ['primary', 'base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: true,
                tags: [
                  'soy',
                  'vegetarian',
                  'air_nomad',
                  'versatile',
                  'protein',
                  'can_be_sweetened_neutral',
                  'sweet_compatible',
                  'solid_food_component',
                  'absorbent_neutral',
                  'gentle_flavor',
                  'mild',
                ],
                rarity: 'common',
                flavorNotes: [
                  'neutral',
                  'absorbent',
                  'silken_or_firm',
                  'creamy-soft',
                  'mild-soy',
                  'yielding-texture',
                  'pure',
                ],
                loreHints: ['monk_staple', 'simple_living'],
              },
              {
                name: 'Charred Yam Discs',
                type: 'vegetable',
                rolePreference: ['base', 'primary'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'root_veg',
                  'earthy',
                  'sweet',
                  'rustic',
                  'vegetable',
                  'sweet_root_tubers',
                  'sweet_compatible',
                  'solid_food_component',
                  'portable_snack_form',
                  'street_food_base',
                  'starchy',
                ],
                rarity: 'common',
                flavorNotes: [
                  'sweet_earthy',
                  'smoky_char',
                  'tender_inside',
                  'caramelized',
                  'grounded',
                ],
                loreHints: ['farm_to_table', 'village_cooking'],
              },
            ],
            // Doc: 'grains' for staple grain products.
            grains: [
              {
                name: 'Barley Tsampa',
                type: 'grain',
                rolePreference: ['base'],
                canBeBase: true,
                weight: 'heavy',
                rawCompatible: false,
                tags: [
                  'staple',
                  'earthy',
                  'air_nomad',
                  'hearty',
                  'roasted_flour',
                  'grain',
                  'sweet_compatible',
                  'heavy_grain',
                  'solid_food_component',
                  'nutty',
                ],
                rarity: 'common',
                flavorNotes: [
                  'nutty',
                  'toasted',
                  'earthy_sweet',
                  'wholesome',
                  'robust',
                  'sustaining',
                ],
                loreHints: ['guru_pathik', 'travel_food'],
              },
              {
                name: 'Simple Rice',
                type: 'grain',
                rolePreference: ['base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'generic',
                  'grain',
                  'sweet_compatible',
                  'light_grain',
                  'can_be_sweetened_neutral',
                  'solid_food_component',
                ],
                rarity: 'common',
                flavorNotes: [
                  'neutral',
                  'fluffy',
                  'light',
                  'airy',
                  'absorbent',
                  'clean',
                ],
                loreHints: ['staple_food', 'versatile_grain'],
              },
            ],
            // Doc: 'other' for miscellaneous ingredients not fitting specific categories.
            other: [
              {
                name: 'Basic Rice Vinegar',
                type: 'vinegar',
                rolePreference: ['seasoning', 'liquid'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'generic',
                  'sour',
                  'acidic',
                  'vinegar',
                  'liquid_base_option',
                  'savory_compatible',
                ],
                rarity: 'common',
                flavorNotes: [
                  'sharp_tang',
                  'clean_sourness',
                  'mildly_sweet_hint',
                  'bright-acid',
                  'zesty',
                ],
                loreHints: ['universal'],
              },
              {
                name: 'Sea Salt Crystals',
                type: 'salt',
                rolePreference: ['seasoning'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'generic',
                  'mineral',
                  'salt',
                  'sweet_compatible_seasoning',
                  'savory_compatible',
                  'crystalline_crunch',
                ],
                rarity: 'common',
                flavorNotes: [
                  'clean_saltiness',
                  'briny_notes',
                  'crystalline_crunch',
                  'oceanic-hint',
                  'sharp-pop',
                ],
                loreHints: ['universal'],
              },
              {
                name: 'Common Root Vegetable',
                type: 'vegetable',
                rolePreference: ['primary', 'base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'generic',
                  'vegetable',
                  'root_veg',
                  'starchy_vegetable_strong',
                  'solid_food_component',
                  'earthy',
                  'mild',
                ],
                rarity: 'common',
                flavorNotes: [
                  'earthy',
                  'mild',
                  'starchy',
                  'grounded',
                  'nutritious',
                  'robust',
                ],
                loreHints: ['humble_fare', 'village_garden'],
              },
              {
                name: 'Seasonal Fruit',
                type: 'fruit',
                rolePreference: ['primary', 'garnish', 'accent'],
                canBeBase: true,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'generic',
                  'fruit',
                  'sweet',
                  'nectar_source',
                  'sweet_compatible',
                  'dessert_fruit',
                  'dessert_primary_ok',
                  'dessert_base_ok',
                  'beverage_component',
                  'fruit_puree_candidate',
                ],
                rarity: 'common',
                flavorNotes: [
                  'sweet',
                  'juicy',
                  'fresh',
                  'delicate_sugariness',
                  'vibrant',
                  'succulent',
                ],
                loreHints: ['market_find', 'nature_bounty'],
              },
              {
                name: 'Wild Herb Blend',
                type: 'herb',
                rolePreference: ['seasoning', 'accent'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'generic',
                  'herb',
                  'aromatic',
                  'infusible_herb',
                  'beverage_component',
                  'savory_compatible',
                  'complex',
                ],
                rarity: 'common',
                flavorNotes: [
                  'mixed_herbal',
                  'fresh_green',
                  'savory_notes',
                  'pungent-aroma',
                  'earthy-undertones',
                ],
                loreHints: ['foragers_mix', 'kitchen_garden_blend'],
              },
              {
                name: 'Neutral Cooking Oil',
                type: 'oil',
                rolePreference: ['binder'],
                canBeBase: false,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'generic',
                  'oil',
                  'fat',
                  'sweet_compatible_binder',
                  'savory_compatible_binder',
                ],
                rarity: 'common',
                flavorNotes: [
                  'neutral_flavor',
                  'smooth_texture',
                  'clean-finish',
                  'light-body',
                ],
                loreHints: ['cooking_staple', 'versatile_oil'],
              },
              {
                name: 'Clear Broth Base',
                type: 'liquid',
                rolePreference: ['base', 'liquid'],
                canBeBase: true,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'generic',
                  'liquid_ish',
                  'beverage_component',
                  'liquid_base',
                  'broth_potential',
                  'savory_compatible',
                  'soup_compatible',
                  'stew_compatible',
                  'neutral_base',
                  'clean',
                ],
                rarity: 'common',
                flavorNotes: [
                  'neutral_base',
                  'clean_broth',
                  'light-body',
                  'subtle-umami',
                  'pure',
                ],
                loreHints: ['universal_base'],
              },
            ],
          },
          cookingStyles: [
            {
              name: 'gentle steaming',
              tags: [
                'airNomadTradition',
                'steaming',
                'soupFriendly',
                'stewFriendly',
                'bakingFriendly',
              ],
            },
            {
              name: 'light baking',
              tags: ['airNomadTradition', 'baking', 'bakingFriendly'],
            },
            {
              name: 'minimal stir_frying',
              tags: ['airNomadTradition', 'stir_frying'],
            },
            { name: 'sun_drying', tags: ['airNomadTradition', 'drying'] },
            {
              name: 'air_whisking',
              tags: [
                'airNomadTradition',
                'uniqueAir',
                'lightDishOnly',
                'beverageFriendly',
                'dessertFriendly',
                'fluffy',
                'no_cook',
              ],
            },
            {
              name: 'infusion',
              tags: [
                'airNomadTradition',
                'infusion',
                'beverageFriendly',
                'soupFriendly',
                'stewFriendly',
                'no_cook',
              ],
            },
          ],
          adjectives: [
            'Sky Temple',
            'Meditative',
            'Gentle Wind',
            'Floating',
            'Enlightened',
            'Zephyr',
            'Harmonious',
            'Serene',
            'Pure',
            'Cloudborne',
            'Ascetic',
            'Whispering',
            'Zenith',
            'Soaring',
            'Tranquil',
          ],
          nameFormats: [
            {
              pattern: '{themeAdj} {nationAdj} {mainIngredient} {format}',
              slots: {
                themeAdj: ['Sacred', 'Celestial'],
                nationAdj: ['Skyborne', 'Zephyr'],
                mainIngredient: 'use_selected_main_ingredient',
                format: 'use_dish_format',
              },
            },
            {
              pattern:
                "Avatar {avatarName}'s {emotion} {mainIngredient} {format}",
              slots: {
                avatarName: ['Yangchen', 'Aang'],
                emotion: ['Serene', 'Joyful'],
                mainIngredient: 'use_selected_main_ingredient',
                format: 'use_dish_format',
              },
            },
            {
              pattern: '{mainIngredient} with Sky Bison Yoghurt',
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
            {
              pattern: 'Floating {mainIngredient} Clouds',
              slots: {
                mainIngredient: 'use_selected_main_ingredient',
                condition: (ings) =>
                  ings.some(
                    (i) =>
                      getIngredientTags(i).includes('fluffy') ||
                      getIngredientTags(i).includes('creamy') ||
                      getIngredientTags(i).includes('liquid_ish')
                  ),
              },
            },
            {
              pattern: 'Zephyr {mainIngredient} Dessert',
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
          ],
          famousMonks: ['Gyatso', 'Pathik', 'Yangchen'],
          platingNotes: [
            'Served with minimalist elegance on simple, unadorned pottery, often featuring a single, perfect edible flower or a delicate swirl of fruit puree. Colors are typically light and natural, emphasizing purity. Often, a spiral garnish evokes the ever_flowing wind, or ingredients are layered to suggest spiritual ascent.',
            'Arranged to evoke a sense of lightness and airiness, perhaps with ingredients seeming to float or spiral. Serveware is smooth, light_colored stone or pale wood, reflecting harmony with nature. Often, a spiral garnish evokes the ever_flowing wind, or ingredients are layered to suggest spiritual ascent.',
          ],
          nationDishTypeProfiles: {
            Dessert: {
              allowedTags: [
                'fruit',
                'sweet_compatible',
                'nectar_source',
                'light_grain',
                'sweet_root_tubers',
                'spiritual_essence',
                'calming_herb',
                'can_be_sweetened_neutral',
                'dairy',
                'floral',
                'creamy',
                'fluffy',
                'nutty',
              ],
              disallowedTags: [
                'pungent_spice',
                'distinctly_savory_protein',
                'savory_scramble',
                'kimchi',
                'sour',
                'acidic',
                'umami',
                'strong_fish',
                'gamey_meat',
              ],
            },
            Nectar: {
              allowedTags: [
                'fruit',
                'nectar_source',
                'sweet_compatible',
                'spiritual_essence',
                'floral',
                'dairy',
                'liquid_ish',
                'beverage_component',
                'infusible_herb',
                'creamy',
              ],
              disallowedTags: [
                'heavy_grain',
                'starchy_vegetable_strong',
                'savory_scramble',
                'kimchi',
                'solid_food_component',
                'sour',
                'acidic',
                'umami',
                'strong_fish',
                'gamey_meat',
              ],
            },
            Beverage: {
              allowedTags: [
                'fruit',
                'nectar_source',
                'sweet_compatible',
                'spiritual_essence',
                'floral',
                'dairy',
                'light_grain',
                'calming_herb',
                'infusible_herb',
                'liquid_ish',
                'beverage_component',
                'fruit_puree_candidate',
                'creamy',
                'clean',
              ],
              disallowedTags: [
                'heavy_grain',
                'starchy_vegetable_strong',
                'savory_scramble',
                'kimchi',
                'pungent_spice',
                'solid_food_component',
                'sour',
                'acidic',
                'umami',
                'strong_fish',
                'gamey_meat',
              ],
            },
            'Soup/Stew': {
              allowedTags: [
                'grain',
                'vegetable',
                'protein',
                'liquid_base',
                'liquid_ish',
                'broth_potential',
                'savory_compatible',
                'mild',
                'earthy',
                'clean',
              ],
              disallowedTags: [
                'strong_fish',
                'gamey_meat',
                'pungent_spice',
                'fiery',
              ],
            },
            'Main Course': {
              allowedTags: [
                'grain',
                'protein',
                'vegetable',
                'dairy',
                'herb',
                'mild',
                'earthy',
                'savory_compatible',
                'staple',
              ],
              disallowedTags: [
                'fiery',
                'strong_fish',
                'gamey_meat',
                'pungent_spice',
                'kimchi',
              ],
            },
            Snack: {
              allowedTags: [
                'fruit',
                'vegetable',
                'grain',
                'protein',
                'sweet_compatible',
                'savory_compatible',
                'portable_snack_form',
                'mild',
                'crispy',
                'nutty',
                'creamy',
              ],
              disallowedTags: [
                'fiery',
                'strong_fish',
                'gamey_meat',
                'pungent_spice',
                'kimchi',
              ],
            },
            Salad: {
              allowedTags: [
                'fruit',
                'vegetable',
                'protein',
                'herb',
                'light',
                'crisp',
                'fresh',
                'mild',
                'savory_compatible',
              ],
              disallowedTags: [
                'heavy_grain',
                'gamey_meat',
                'fiery',
                'starchy_vegetable_strong',
              ],
            },
          },
        },
        waterTribes: {
          ingredients: {
            animalProducts: [
              {
                name: 'Arctic Char',
                type: 'protein',
                rolePreference: ['primary'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: true,
                tags: [
                  'fish',
                  'seafood',
                  'water_tribe',
                  'oily',
                  'rich',
                  'staple',
                  'protein',
                  'strong_fish',
                  'solid_food_component',
                  'savory_compatible',
                  'flaky',
                ],
                rarity: 'common',
                flavorNotes: [
                  'rich_omega',
                  'flaky_texture',
                  'mildly_fishy',
                  'buttery',
                  'succulent',
                  'oceanic',
                ],
                loreHints: ['arctic_hunt', 'northern_lights'],
              },
              {
                name: 'Dried Seaweed Flakes',
                type: 'seaweed',
                rolePreference: ['seasoning', 'garnish'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'seaweed',
                  'umami',
                  'briny',
                  'water_tribe',
                  'savory_compatible',
                  'dried',
                  'crispy',
                ],
                rarity: 'common',
                flavorNotes: [
                  'umami_rich',
                  'briny_notes',
                  'crispy_texture',
                  'salty-snap',
                  'marine-fragrance',
                ],
                loreHints: ['ocean_harvest', 'travel_food'],
              },
            ],
            plants: [
              {
                name: 'Kombu Kelp Strips',
                type: 'vegetable',
                rolePreference: ['accent', 'primary'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'seaweed',
                  'umami',
                  'water_tribe',
                  'versatile',
                  'iodine_rich',
                  'vegetable',
                  'fermented_savory',
                  'briny',
                  'chewy',
                  'soup_compatible',
                ],
                rarity: 'common',
                flavorNotes: [
                  'briny',
                  'savory_depth',
                  'chewy_texture',
                  'subtle_sweetness',
                  'leathery-umami',
                  'oceanic-earth',
                ],
                loreHints: ['ocean_harvest', 'tidal_pools'],
              },
              {
                name: 'Sea Plums',
                type: 'fruit',
                rolePreference: ['accent', 'garnish', 'primary'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'fruit',
                  'tart',
                  'water_tribe',
                  'coastal',
                  'preserved',
                  'sweet_compatible',
                  'dessert_fruit',
                  'beverage_component',
                  'briny',
                  'juicy',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'briny_tart',
                  'juicy_pop',
                  'deep_purple',
                  'tangy-sweet',
                  'bursting-freshness',
                ],
                loreHints: ['coastal_foraging', 'winter_preserves'],
              },
            ],
            dairy: [
              {
                name: 'Seal Jerky Flavored Snow Cream',
                type: 'dairy',
                rolePreference: ['primary', 'base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'dairy_polar',
                  'sweet_compatible',
                  'water_tribe_dessert_novelty',
                  'savory_dessert_base',
                  'sweet_savory_balance',
                  'creamy',
                  'icy',
                  'no_cook',
                  'cold_prep',
                ],
                rarity: 'rare',
                flavorNotes: [
                  'creamy_sweet',
                  'faint_savory_smoke',
                  'icy_texture',
                  'unconventional',
                  'surprisingly-balanced',
                ],
                loreHints: ['winter_festival_treat', 'controversial_flavor'],
              },
            ],
          },
          cookingStyles: [
            {
              name: 'boiling',
              tags: ['waterTribeTradition', 'soupFriendly', 'stewFriendly'],
            },
            { name: 'smoking', tags: ['waterTribeTradition', 'smoking'] },
            { name: 'drying', tags: ['waterTribeTradition', 'drying'] },
            { name: 'fermenting', tags: ['waterTribeTradition', 'fermenting'] },
            {
              name: 'ice_chilling',
              tags: [
                'waterTribeTradition',
                'uniqueWater',
                'cold_prep',
                'beverageFriendly',
                'dessertFriendly',
                'no_cook',
              ],
            },
            {
              name: 'steaming',
              tags: ['waterTribeTradition', 'steaming', 'bakingFriendly'],
            },
          ],
          adjectives: [
            'Frozen Tundra',
            'Arctic Moon',
            'Ocean Spirit',
            "Tribal Hunter's",
            'Glacial River',
            'Coastal',
            'Moonlit Shore',
            'Deep Sea',
            'Icy Veil',
            'Polar',
            'Marine',
            'Flowing',
            'Resilient',
            'Brave',
            'Ancient-Water',
          ],
          nameFormats: [
            {
              pattern: '{nationAdj} {mainIngredient} Stew of the {geography}',
              slots: {
                nationAdj: ['Frozen Deep', "Aurora Watcher's"],
                mainIngredient: 'use_selected_main_ingredient',
                geography: ['Frozen Sea', 'Ice Floes'],
              },
            },
            {
              pattern: "Chieftain's {mainIngredient} Feast",
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
            {
              pattern: '{mainIngredient} with Sea Plums',
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
            {
              pattern: 'Glacial {mainIngredient} Bites',
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
            {
              pattern: "Aurora Watcher's {mainIngredient} {format}",
              slots: {
                mainIngredient: 'use_selected_main_ingredient',
                format: 'use_dish_format',
              },
            },
          ],
          platingNotes: [
            'Presented in sturdy, hand_carved wooden bowls or on slabs of polished ice for chilled dishes. Communal sharing is often emphasized with generous portions. Garnishes are hardy and practical: sprigs of tundra herbs, dried seaweed flakes, or preserved berries, reflecting the harsh beauty of the polar environment.',
            'Served on rough_hewn stone or in bowls resembling sea_worn pebbles, emphasizing the resilience of the tribes. Chilled preparations often sit atop carved ice blocks that slowly melt, adding to the sensory experience.',
          ],
          nationDishTypeProfiles: {
            Dessert: {
              allowedTags: [
                'fruit',
                'sweet_compatible',
                'preserved',
                'dairy_polar',
                'savory_dessert_base',
                'sweet_savory_balance',
                'icy',
                'no_cook',
                'cold_prep',
                'creamy',
              ],
              disallowedTags: [
                'strong_fish',
                'umami_dominant',
                'fermented_savory',
              ],
            },
            Beverage: {
              allowedTags: [
                'fruit',
                'sweet_compatible',
                'preserved',
                'dairy_polar',
                'liquid_ish',
                'beverage_component',
                'briny',
                'icy',
                'no_cook',
                'cold_prep',
                'creamy',
              ],
              disallowedTags: [
                'strong_fish',
                'solid_food_component',
                'fermented_savory',
              ],
            },
            Nectar: {
              allowedTags: [
                'fruit',
                'sweet_compatible',
                'preserved',
                'liquid_ish',
                'beverage_component',
                'briny',
                'icy',
                'no_cook',
                'cold_prep',
                'creamy',
              ],
              disallowedTags: [
                'strong_fish',
                'solid_food_component',
                'fermented_savory',
                'dairy_polar',
              ],
            },
            'Soup/Stew': {
              allowedTags: [
                'fish',
                'seafood',
                'water_tribe',
                'umami',
                'briny',
                'soup_compatible',
                'stew_compatible',
                'liquid_base',
                'liquid_ish',
                'broth_potential',
                'savory_compatible',
                'root_veg',
              ],
              disallowedTags: [],
            },
            'Main Course': {
              allowedTags: [
                'fish',
                'seafood',
                'protein',
                'vegetable',
                'umami',
                'briny',
                'savory_compatible',
              ],
              disallowedTags: ['sweet_compatible'],
            },
            Snack: {
              allowedTags: [
                'fish',
                'seafood',
                'dried',
                'portable_snack_form',
                'savory_compatible',
                'briny',
                'crispy',
              ],
              disallowedTags: ['sweet_compatible', 'fragile_garnish'],
            },
            Salad: {
              allowedTags: [
                'fish',
                'seafood',
                'vegetable',
                'seaweed',
                'briny',
                'fresh',
                'crisp',
                'savory_compatible',
              ],
              disallowedTags: [
                'heavy_grain',
                'gamey_meat',
                'fiery',
                'starchy_vegetable_strong',
              ],
            },
          },
        },
        earthKingdom: {
          ingredients: {
            grains: [
              {
                name: 'Golden Terrace Rice',
                type: 'grain',
                rolePreference: ['base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'staple',
                  'earth_kingdom',
                  'earthy',
                  'nutty',
                  'versatile',
                  'grain',
                  'sweet_compatible',
                  'light_grain',
                  'can_be_sweetened_neutral',
                  'solid_food_component',
                  'savory_compatible',
                  'soup_compatible',
                  'stew_compatible',
                  'fluffy',
                ],
                rarity: 'common',
                flavorNotes: [
                  'nutty',
                  'slightly_sweet',
                  'fluffy_texture',
                  'absorbent',
                  'golden-hue',
                  'aromatic-grain',
                ],
                loreHints: ['ba_sing_se', 'harvest_festival'],
              },
            ],
            fruitsVegetablesSeedsFungi: [
              {
                name: 'Fermented Lotus Root Chips',
                type: 'vegetable',
                rolePreference: ['primary', 'accent', 'garnish'],
                canBeBase: true,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'root_veg',
                  'crunchy',
                  'earth_kingdom',
                  'fermented',
                  'tangy',
                  'vegetable',
                  'fermented_savory',
                  'umami',
                  'portable_snack_form',
                  'street_food_snack',
                  'crispy',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'tangy_sour',
                  'crisp_texture',
                  'umami_hint',
                  'savory-crunch',
                  'pickled-earth',
                ],
                loreHints: ['ancient_preservation', 'earth_bender_snack'],
              },
              {
                name: 'Rock Candy Figs',
                type: 'fruit',
                rolePreference: ['accent', 'garnish'],
                canBeBase: false,
                weight: 'medium',
                rawCompatible: true,
                tags: [
                  'fruit',
                  'sweet',
                  'earth_kingdom',
                  'dessert',
                  'crystallized',
                  'sweet_compatible',
                  'dessert_fruit',
                  'chewy',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'intense_sweetness',
                  'chewy_texture',
                  'crystalline_coating',
                  'earthy-fig-flavor',
                  'geode-like',
                  'jewel-toned',
                ],
                loreHints: ['omashu_confection', 'geode_like_appearance'],
              },
              {
                name: 'Hearty Cabbage',
                type: 'vegetable',
                rolePreference: ['primary', 'base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'generic',
                  'vegetable',
                  'leafy_green',
                  'solid_food_component',
                  'savory_compatible',
                  'soup_compatible',
                  'stew_compatible',
                  'crisp',
                ],
                rarity: 'common',
                flavorNotes: [
                  'crisp_texture',
                  'mild_earthy',
                  'fresh-green',
                  'versatile',
                  'slightly-bitter',
                ],
                loreHints: ['cabbage_man_favorite', 'staple_vegetable'],
              },
            ],
            dairy: [
              {
                name: 'Sweetened Jennamite Curd',
                type: 'dairy',
                rolePreference: ['primary', 'base'],
                canBeBase: true,
                weight: 'light',
                rawCompatible: false,
                tags: [
                  'dairy_ek',
                  'sweet_compatible',
                  'earth_kingdom_dessert',
                  'creamy',
                  'mild',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'mildly_sweet',
                  'creamy_set',
                  'faint_earthy_note',
                  'smooth-texture',
                  'delicate-sweet',
                ],
                loreHints: ['jennamite_delicacy', 'upper_ring_treat'],
              },
            ],
            proteins: [
              {
                name: 'Moo_Cows Stew Meat',
                type: 'protein',
                rolePreference: ['primary'],
                canBeBase: true,
                weight: 'heavy',
                rawCompatible: false,
                tags: [
                  'meat',
                  'earth_kingdom',
                  'hearty',
                  'savory',
                  'protein',
                  'gamey_meat',
                  'solid_food_component',
                  'savory_compatible',
                  'stew_compatible',
                  'soup_compatible',
                  'tender',
                ],
                rarity: 'common',
                flavorNotes: [
                  'rich_savory',
                  'tender_braised',
                  'deep_umami',
                  'robust',
                  'succulent',
                  'warming',
                ],
                loreHints: ['farming_staple', 'village_feast'],
              },
            ],
          },
          cookingStyles: [
            {
              name: 'hearty roasting',
              tags: ['earthKingdomTradition', 'roasting'],
            },
            {
              name: 'skillful stir_frying',
              tags: [
                'earthKingdomTradition',
                'stir_frying',
                'street_food_cooking',
              ],
            },
            {
              name: 'extensive baking',
              tags: ['earthKingdomTradition', 'baking', 'bakingFriendly'],
            },
            {
              name: 'clay_baking',
              tags: [
                'earthKingdomTradition',
                'uniqueEarth',
                'slow_cooking',
                'bakingFriendly',
              ],
            },
            {
              name: 'noodle pulling',
              tags: ['earthKingdomTradition', 'noodle_prep'],
            },
            {
              name: 'deep_frying',
              tags: ['earthKingdomTradition', 'frying', 'street_food_cooking'],
            },
            {
              name: 'simmering',
              tags: ['earthKingdomTradition', 'soupFriendly', 'stewFriendly'],
            },
          ],
          adjectives: [
            'Earthen Heart',
            'Stone Fortress',
            'Ba Sing Se Imperial',
            'Jade Palace',
            "Terracotta Warrior's",
            'Mountain_Grown',
            'Grounded',
            'Resilient',
            'Stalwart',
            'Rich-Soil',
            'Deep-Earth',
            'Abundant',
            'Hearty',
          ],
          nameFormats: [
            {
              pattern: '{nationAdj} {mainIngredient} {format} from {region}',
              slots: {
                nationAdj: ['Ba Sing Se Grand', 'Omashu Mountain'],
                mainIngredient: 'use_selected_main_ingredient',
                format: 'use_dish_format',
                region: ['the Upper Ring', 'a Hidden Quarry'],
              },
            },
            {
              pattern: "Earth King's {mainIngredient} Delight",
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
            {
              pattern: '{mainIngredient} of the {region} Fields',
              slots: {
                mainIngredient: 'use_selected_main_ingredient',
                region: ['Gaoling', 'Chin Village'],
              },
            },
            {
              pattern: "Kyoshi Warrior's {mainIngredient} Bites",
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
          ],
          platingNotes: [
            'Served generously on sturdy earthenware or heavy pottery, symbolizing abundance and the solidity of the earth. Textures and natural colors are prominent. Often rustic yet artful, ingredients might be mounded or layered. Garnishes include roughly chopped herbs, toasted nuts, or a drizzle of rich, earthy sauce.',
            'Presented in robust, unadorned bowls or on rough_hewn wooden boards, reflecting the enduring strength of the Earth Kingdom. Portions are hearty and designed for sustenance, often garnished with fresh greens or a sprinkle of toasted seeds.',
          ],
          nationDishTypeProfiles: {
            Dessert: {
              allowedTags: [
                'fruit',
                'sweet_compatible',
                'crystallized',
                'grain',
                'sweet_root_tubers',
                'dairy_ek',
                'mild',
                'chewy',
                'creamy',
              ],
              disallowedTags: [
                'fermented_savory',
                'pungent_spice',
                'strong_fish',
                'umami',
              ],
            },
            'Street Food': {
              allowedTags: [
                'portable_snack_form',
                'street_food_base',
                'street_food_snack',
                'crispy',
                'savory_compatible',
                'sweet_compatible',
                'hearty',
              ],
              disallowedTags: ['fragile_garnish', 'delicate', 'fine_dining'],
            },
            'Soup/Stew': {
              allowedTags: [
                'grain',
                'vegetable',
                'meat',
                'root_veg',
                'solid_food_component',
                'savory_compatible',
                'soup_compatible',
                'stew_compatible',
                'liquid_base',
                'liquid_ish',
                'broth_potential',
                'umami',
              ],
              disallowedTags: [],
            },
            'Main Course': {
              allowedTags: [
                'grain',
                'protein',
                'vegetable',
                'earthy',
                'hearty',
                'savory_compatible',
              ],
              disallowedTags: ['fiery', 'delicate', 'floral'],
            },
            Snack: {
              allowedTags: [
                'grain',
                'vegetable',
                'protein',
                'crunchy',
                'portable_snack_form',
                'street_food_snack',
                'savory_compatible',
                'sweet_compatible',
                'chewy',
              ],
              disallowedTags: ['fragile_garnish', 'delicate', 'fiery'],
            },
            Salad: {
              allowedTags: [
                'vegetable',
                'grain',
                'protein',
                'fresh',
                'crisp',
                'earthy',
                'savory_compatible',
              ],
              disallowedTags: [
                'gamey_meat',
                'fiery',
                'starchy_vegetable_strong',
              ],
            },
          },
        },
        fireNation: {
          ingredients: {
            grains: [
              {
                name: "Dragon's Breath Infused Rice",
                type: 'grain',
                rolePreference: ['base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'spicy_hint',
                  'fire_nation',
                  'aromatic',
                  'staple',
                  'grain',
                  'sweet_compatible',
                  'light_grain',
                  'solid_food_component',
                  'savory_compatible',
                  'fragrant_spice',
                  'soup_compatible',
                  'stew_compatible',
                  'fluffy',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'fluffy_texture',
                  'subtle_smoky',
                  'warm_spice_aroma',
                  'saffron_color',
                  'fragrant',
                  'lightly-spiced',
                ],
                loreHints: ['volcanic_steam', 'sun_warrior_ritual'],
              },
              {
                name: 'Magma Mochi Cakes',
                type: 'grain_product',
                rolePreference: ['base', 'primary'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'mochi',
                  'sweet',
                  'chewy',
                  'fire_nation',
                  'dessert',
                  'grain',
                  'sweet_compatible',
                  'dessert_base_ok',
                  'dessert_primary_ok',
                  'warm_spice',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'subtly_sweet_rice',
                  'warm_spices_infused',
                  'soft_chewy_texture',
                  'molten-center',
                  'comforting',
                ],
                loreHints: [
                  'temple_offering_sweet',
                  'caldera_bakery_specialty',
                ],
              },
            ],
            fruitsVegetablesFungi: [
              {
                name: 'Ember Chili',
                type: 'spice',
                rolePreference: ['seasoning', 'accent'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'vegetable',
                  'chili',
                  'spicy',
                  'fiery',
                  'fire_nation',
                  'staple',
                  'versatile_heat',
                  'spice',
                  'pungent_spice',
                  'savory_compatible',
                ],
                rarity: 'common',
                flavorNotes: [
                  'varied_fiery_heat',
                  'smoky_undertones',
                  'fruity_notes_in_some',
                  'sharp_spice',
                  'blazing',
                  'tingling',
                ],
                loreHints: ['sozins_comet_pepper', 'spice_tolerance_test'],
              },
              {
                name: 'Sunstone Mangoes',
                type: 'fruit',
                rolePreference: ['primary', 'garnish', 'accent', 'base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: true,
                tags: [
                  'fruit',
                  'sweet_tart',
                  'fire_nation',
                  'dessert',
                  'tropical',
                  'nectar_source',
                  'sweet_compatible',
                  'dessert_fruit',
                  'dessert_primary_ok',
                  'beverage_component',
                  'fruit_puree_candidate',
                  'spicy_hint',
                  'juicy',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'intense_sweetness',
                  'tart_finish',
                  'faintly_spicy_aroma',
                  'delicate_sugariness',
                  'sun-drenched',
                  'vibrant-orange',
                ],
                loreHints: ['Sunstone Mangoes'],
              },
              {
                name: 'Emberberries',
                type: 'fruit',
                rolePreference: ['accent', 'garnish'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'fruit',
                  'berry',
                  'spicy_sweet',
                  'fire_nation',
                  'dessert',
                  'sweet_compatible',
                  'dessert_fruit',
                  'beverage_component',
                  'fiery',
                ],
                rarity: 'rare',
                flavorNotes: [
                  'burst_of_sweet_heat',
                  'tangy',
                  'vibrant_red',
                  'smoldering',
                  'juicy-pop',
                ],
                loreHints: ['Emberberries'],
              },
              {
                name: 'Fire Nettles (Blanched)',
                type: 'vegetable',
                rolePreference: ['accent', 'primary'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: false,
                tags: [
                  'vegetable',
                  'leafy_green',
                  'spicy_hint',
                  'fire_nation',
                  'savory_compatible',
                  'soup_compatible',
                  'stew_compatible',
                  'tender',
                  'earthy',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'earthy_green',
                  'faint_peppery_warmth',
                  'tender_texture',
                  'subtly-fiery',
                  'cleansing',
                ],
                loreHints: [
                  'foraged_near_volcanoes',
                  'requires_careful_preparation',
                ],
              },
            ],
            protein: [
              {
                name: 'Ginger_Soy Glazed Tofu Crumbles',
                type: 'protein',
                rolePreference: ['primary', 'accent'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'tofu',
                  'savory',
                  'fire_nation_influence',
                  'vegetarian',
                  'protein',
                  'distinctly_savory_protein',
                  'solid_food_component',
                  'umami',
                  'sweet_savory_balance',
                  'portable_snack_form',
                  'soup_compatible',
                  'stew_compatible',
                  'firm',
                  'sweet_savory',
                ],
                rarity: 'common',
                flavorNotes: [
                  'sweet_savory_glaze',
                  'umami_rich',
                  'firm_crumbly_texture',
                  'ginger_warmth',
                  'tangy-zing',
                  'sticky-sweet',
                ],
                loreHints: ['fusion_kitchen', 'modern_fn_cuisine'],
              },
              {
                name: 'Smoked Komodo Chicken Skewers',
                type: 'protein',
                rolePreference: ['primary'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'meat',
                  'poultry',
                  'smoky',
                  'spicy',
                  'fire_nation',
                  'protein',
                  'gamey_meat',
                  'solid_food_component',
                  'savory_compatible',
                  'skewerable_protein',
                  'street_food_base',
                  'stew_compatible',
                  'soup_compatible',
                  'tender',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'smoky_depth',
                  'chili_rubbed',
                  'tender_juicy',
                  'charred-exterior',
                  'fiery-kick',
                ],
                loreHints: ['fire_pit_cooked', 'warrior_feast_food'],
              },
            ],
            sweetenersAndSpices: [
              {
                name: 'Volcanic Honey Drizzle',
                type: 'sweetener',
                rolePreference: ['seasoning', 'accent', 'garnish', 'base'],
                canBeBase: true,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'sweetener',
                  'honey',
                  'fire_nation',
                  'dessert',
                  'spicy_undertone',
                  'sweet_compatible',
                  'nectar_base',
                  'dessert_base_ok',
                  'beverage_component',
                  'liquid_ish',
                  'warm_spice',
                  'glaze_compatible',
                  'rich',
                ],
                rarity: 'rare',
                flavorNotes: [
                  'rich_molasses_depth',
                  'warm_spice_finish',
                  'liquid_gold_appearance',
                  'viscous',
                  'deep-sweet',
                  'fiery-afterglow',
                ],
                loreHints: ['firebee_honey', 'ancient_recipe_sweetener'],
              },
              {
                name: 'Cindered Nuts',
                type: 'nut',
                rolePreference: ['garnish', 'accent'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'nut',
                  'smoky',
                  'crunchy',
                  'fire_nation',
                  'dessert_topping',
                  'sweet_compatible',
                  'savory_compatible',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'toasted_nutty',
                  'smoky_char_hint',
                  'savory_sweet_dusting',
                  'crispy-bite',
                  'ember-roasted',
                ],
                loreHints: ['fire_roasted_nuts', 'warrior_snack'],
              },
              {
                name: 'Spiced Fire Lily Nectar',
                type: 'liquid',
                rolePreference: ['liquid', 'accent', 'seasoning', 'base'],
                canBeBase: true,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'nectar',
                  'floral',
                  'spicy',
                  'sweet',
                  'fire_nation',
                  'dessert',
                  'beverage_component',
                  'nectar_source',
                  'nectar_base',
                  'sweet_compatible',
                  'spiritual_essence',
                  'sweet_spice',
                  'liquid_ish',
                  'vibrant',
                  'soup_compatible',
                  'stew_compatible',
                  'broth_potential',
                  'glaze_compatible',
                  'heady',
                ],
                rarity: 'rare',
                sourceNation: 'Fire Nation',
                sourceNationKey: 'fireNation',
                flavorNotes: [
                  'heady_floral_aroma',
                  'warming_cinnamon_clove',
                  'viscous_sweetness',
                  'exotic',
                  'sparkling',
                  'mystical',
                ],
                loreHints: [
                  'sacred_flower_essence',
                  'royal_confection_ingredient',
                  'Spiced Fire Lily Nectar',
                ],
              },
            ],
            other: [
              {
                name: 'Fermented Red Pepper Paste',
                type: 'condiment',
                rolePreference: ['binder', 'seasoning', 'accent'],
                canBeBase: false,
                weight: 'medium',
                rawCompatible: true,
                tags: [
                  'spicy',
                  'umami',
                  'fire_nation',
                  'gochujang_like',
                  'condiment',
                  'fermented_savory',
                  'savory_compatible',
                  'soup_compatible',
                  'stew_compatible',
                  'sweet_heat',
                  'deep',
                ],
                rarity: 'rare',
                flavorNotes: [
                  'deep_savory_spice',
                  'sweet_heat',
                  'fermented_complexity',
                  'bold-umami',
                  'fiery-kick',
                ],
                loreHints: ['secret_family_recipe', 'fire_sage_pantry'],
              },
              {
                name: 'Black Lava Salt',
                type: 'salt',
                rolePreference: ['seasoning', 'garnish'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'salt',
                  'mineral',
                  'smoky',
                  'fire_nation',
                  'sweet_compatible_seasoning',
                  'savory_compatible',
                  'dramatic',
                  'sharp',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'sharp_saltiness',
                  'subtle_sulfur_smoky',
                  'dramatic_black_color',
                  'volcanic-hint',
                  'crisp-crunch',
                ],
                loreHints: ['volcanic_salt_pans', 'finishing_salt'],
              },
            ],
          },
          cookingStyles: [
            {
              name: 'grilling over open flames',
              tags: ['fireNationTradition', 'grilling', 'street_food_cooking'],
            },
            {
              name: 'firebending_enhanced searing',
              tags: ['fireNationTradition', 'firebendingRequired', 'searing'],
            },
            {
              name: 'intense roasting',
              tags: ['fireNationTradition', 'roasting'],
            },
            {
              name: 'deep_frying (spiced batter)',
              tags: ['fireNationTradition', 'frying', 'street_food_cooking'],
            },
            { name: 'bold smoking', tags: ['fireNationTradition', 'smoking'] },
            {
              name: 'volcanic steam baking',
              tags: [
                'fireNationTradition',
                'uniqueFire',
                'steaming',
                'bakingFriendly',
              ],
            },
            {
              name: 'ancestral spirit_infusion (by Sages/monks)',
              tags: [
                'fireNationTradition',
                'spiritualFire',
                'rareTechnique',
                'infusion',
              ],
            },
            {
              name: 'glazing',
              tags: ['fireNationTradition', 'glazing', 'sweet_compatible'],
            },
          ],
          adjectives: [
            'Volcanic Peak',
            'Ember Island',
            'Inferno Kissed',
            "Spicy Dragon's Breath",
            "Sun Warrior's Ritual",
            'Fiery',
            'Blazing',
            'Searing',
            'Crimson',
            'Molten',
            'Ashen',
            'Roaring',
            'Imperial',
            'Passionate',
          ],
          nameFormats: [
            {
              pattern: '{nationAdj} {mainIngredient} of {culturalSymbol}',
              slots: {
                nationAdj: ["Fiery Soul's", 'Ember_Forged', 'Volcanic'],
                mainIngredient: 'use_selected_main_ingredient',
                culturalSymbol: [
                  'the Sun Warriors',
                  "Dragon's Peak",
                  'the Crimson Legion',
                ],
              },
            },
            {
              pattern: 'Blazing {mainIngredient} {format}',
              slots: {
                mainIngredient: 'use_selected_main_ingredient',
                format: 'use_dish_format',
              },
            },
            {
              pattern:
                '{mainIngredient} with {secondaryIngredient} Ember Glaze',
              slots: {
                mainIngredient: 'use_selected_main_ingredient',
                secondaryIngredient: 'use_selected_secondary_ingredient',
                condition: (ings) =>
                  ings.some(
                    (i) =>
                      getIngredientTags(i).includes('glaze_compatible') ||
                      (getIngredientType(i).includes('sweetener') &&
                        i.liquid_ish)
                  ),
              },
            },
            {
              pattern: "Fire Lord {fireLordName}'s {emotion} {mainIngredient}",
              slots: {
                fireLordName: ['Sozin', 'Zuko', 'Izumi'],
                emotion: ['Spiced', 'Imperial', 'Victorious'],
                mainIngredient: 'use_selected_main_ingredient',
              },
            },
          ],
          platingNotes: [
            'Presented with dramatic flair on dark, heavy plates (slate, obsidian_like ceramic), often featuring bold, contrasting colors like reds, oranges, and blacks. A lightly charred element is a common visual cue. Presentation might involve a final, dramatic flourish of flame if a firebender is near, or elements stacked to mimic Fire Nation rank and order.',
            "Garnishes are sharp and intense: slivered chilies, finely chopped scallions, a swirl of bright chili oil, or a sprinkle of black lava salt. Visual impact matches the flavor intensity. Often served in vibrant, geometric patterns, reflecting the Fire Nation's disciplined and powerful aesthetic.",
          ],
          famousMonks: [
            'Fire Sage Kaja',
            'Jeong Jeong (in his philosophical moments)',
            'Shyu',
          ],
          nationDishTypeProfiles: {
            Dessert: {
              allowedTags: [
                'fruit',
                'sweet_compatible',
                'spicy_sweet',
                'mochi',
                'sweetener',
                'floral',
                'nut',
                'grain',
                'dairy_fn',
                'light_grain',
                'warm_spice',
                'chewy',
                'glaze_compatible',
              ],
              disallowedTags: ['distinctly_savory_protein', 'fermented_savory'],
            },
            'Street Food': {
              allowedTags: [
                'portable_snack_form',
                'street_food_base',
                'skewerable_protein',
                'spicy',
                'smoky',
                'crunchy',
                'savory_compatible',
                'sweet_compatible',
                'fiery',
              ],
              disallowedTags: ['fragile_garnish', 'delicate', 'fine_dining'],
            },
            'Soup/Stew': {
              allowedTags: [
                'grain',
                'vegetable',
                'meat',
                'protein',
                'spice',
                'chili',
                'condiment',
                'umami',
                'spicy_hint',
                'fragrant_spice',
                'sweet_spice',
                'liquid_ish',
                'broth_potential',
                'soup_compatible',
                'stew_compatible',
                'savory_compatible',
              ],
              disallowedTags: [],
            },
            'Main Course': {
              allowedTags: [
                'grain',
                'protein',
                'vegetable',
                'spicy',
                'fiery',
                'smoky',
                'umami',
                'savory_compatible',
              ],
              disallowedTags: ['delicate', 'floral'],
            },
            Snack: {
              allowedTags: [
                'grain',
                'protein',
                'fruit',
                'nut',
                'spicy',
                'sweet',
                'smoky',
                'crunchy',
                'chewy',
                'portable_snack_form',
                'street_food_snack',
                'savory_compatible',
                'sweet_compatible',
                'fiery',
              ],
              disallowedTags: ['fragile_garnish', 'delicate'],
            },
            Salad: {
              allowedTags: [
                'vegetable',
                'fruit',
                'protein',
                'spicy_hint',
                'fresh',
                'crisp',
                'savory_compatible',
                'sweet_compatible',
              ],
              disallowedTags: [
                'heavy_grain',
                'gamey_meat',
                'starchy_vegetable_strong',
              ],
            },
          },
        },
        unitedRepublic: {
          ingredients: {
            general: [
              {
                name: 'Artisan Sourdough',
                type: 'grain',
                rolePreference: ['base'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'bread',
                  'united_republic',
                  'cafe_staple',
                  'grain',
                  'can_be_sweetened_neutral',
                  'solid_food_component',
                  'crispy_bread_component',
                  'savory_compatible',
                ],
                rarity: 'common',
                flavorNotes: [
                  'tangy_sour',
                  'chewy_crust',
                  'airy-crumb',
                  'rustic-aroma',
                ],
                loreHints: ['republic_city_bakery'],
              },
              {
                name: 'Republic City Noodles',
                type: 'grain',
                rolePreference: ['base', 'primary'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'noodle',
                  'united_republic',
                  'staple',
                  'versatile',
                  'grain',
                  'solid_food_component',
                  'savory_compatible',
                  'soup_compatible',
                  'stew_compatible',
                  'chewy',
                ],
                rarity: 'common',
                flavorNotes: [
                  'chewy_texture',
                  'neutral_absorbent',
                  'slurpable',
                  'satisfying',
                ],
                loreHints: ['city_staple', 'pro_bending_fuel'],
              },
            ],
            fusionElements: [
              {
                name: 'Kimchi_Spiced Tofu Scramble',
                type: 'protein',
                rolePreference: ['primary'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: false,
                tags: [
                  'fusion',
                  'breakfast',
                  'spicy',
                  'savory',
                  'vegetarian',
                  'united_republic',
                  'protein',
                  'kimchi',
                  'savory_scramble',
                  'distinctly_savory_protein',
                  'solid_food_component',
                  'umami',
                  'tangy',
                  'soup_compatible',
                  'stew_compatible',
                  'crunchy',
                ],
                rarity: 'uncommon',
                flavorNotes: [
                  'tangy_spicy',
                  'umami_rich',
                  'creamy_tofu',
                  'crunchy_kimchi',
                  'bold-flavor',
                  'fermented-kick',
                ],
                loreHints: ['fusion_kitchen', 'modern_rc_breakfast'],
              },
              {
                name: 'Crystalized Ginger Candy',
                type: 'sweetener',
                rolePreference: ['accent', 'garnish'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'candy',
                  'sweet',
                  'spicy',
                  'united_republic',
                  'dessert',
                  'sweetener',
                  'chewy',
                  'portable_snack_form',
                  'street_food_snack',
                ],
                rarity: 'common',
                flavorNotes: [
                  'intense_ginger_heat',
                  'crystallized_sweetness',
                  'chewy',
                  'warming-spice',
                  'zesty-sweet',
                ],
                loreHints: ['rc_confectionery', 'pick_me_up'],
              },
            ],
          },
          cookingStyles: [
            {
              name: 'fusion cuisine (primary)',
              tags: ['unitedRepublicModern', 'fusion'],
            },
            {
              name: 'modern street food vending',
              tags: ['unitedRepublicModern', 'street_food_cooking'],
            },
            {
              name: 'cafe baking',
              tags: ['unitedRepublicModern', 'baking', 'bakingFriendly'],
            },
            {
              name: 'cocktail mixology',
              tags: [
                'unitedRepublicModern',
                'beverageFocus',
                'beverageFriendly',
              ],
            },
            {
              name: 'electric appliance cooking',
              tags: ['unitedRepublicModern', 'techInfluence'],
            },
            {
              name: 'urban grilling',
              tags: ['unitedRepublicModern', 'grilling', 'street_food_cooking'],
            },
          ],
          adjectives: [
            'Republic City Metro',
            'Modern Fusion',
            "Avatar Korra's Era",
            'Pro_Bending Arena',
            'Technological Taste',
            'Cosmopolitan',
            'Vibrant',
            'Innovative',
            'Electric',
            'Metropolitan',
            'Dynamic',
            'Industrial',
          ],
          nameFormats: [
            {
              pattern:
                '{adj} {mainIngredient1}_{mainIngredient2} Fusion {format}',
              slots: {
                adj: ['Dynamic', 'Cross_Cultural'],
                mainIngredient1: 'use_selected_main_ingredient',
                mainIngredient2: 'use_selected_secondary_ingredient',
                format: 'use_dish_format',
              },
            },
            {
              pattern: 'Republic City {mainIngredient} Delight',
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
            {
              pattern: "Pro_Bender's {mainIngredient} Fuel",
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
            {
              pattern: "Varrick's {adj} {mainIngredient}",
              slots: {
                adj: ['Innovative', 'Questionable', 'Explosive'],
                mainIngredient: 'use_selected_main_ingredient',
              },
            },
          ],
          platingNotes: [
            'Modern, artistic, and eclectic presentation, ranging from minimalist chic to vibrant street food style. Deconstructed elements and surprising textural contrasts are common. Serveware might include sleek modern ceramics, bento_style boxes, or industrial_chic metal. Fusion dishes might visually highlight distinct components.',
            "Often served in reusable, stylish containers that reflect Republic City's modern aesthetic. The presentation emphasizes clean lines and vibrant colors, sometimes with an unexpected, playful element. Ideal for a quick, sophisticated meal on the go.",
          ],
          nationDishTypeProfiles: {
            Dessert: {
              allowedTags: [
                'fruit',
                'sweet_compatible',
                'fusion_sweet',
                'cafe_baking_ingredient',
                'dairy_urc',
                'can_be_sweetened_neutral',
                'candy',
                'chewy',
                'spicy_sweet',
              ],
              disallowedTags: ['kimchi', 'savory_scramble', 'fermented_savory'],
            },
            'Street Food': {
              allowedTags: [
                'portable_snack_form',
                'street_food_base',
                'skewerable_protein',
                'crispy',
                'savory_compatible',
                'sweet_compatible',
                'fusion',
                'umami',
                'spicy',
              ],
              disallowedTags: ['fragile_garnish', 'delicate', 'fine_dining'],
            },
            'Soup/Stew': {
              allowedTags: [
                'grain',
                'noodle',
                'protein',
                'fusion',
                'kimchi',
                'savory_scramble',
                'distinctly_savory_protein',
                'umami',
                'spicy',
                'soup_compatible',
                'stew_compatible',
                'savory_compatible',
                'liquid_base',
                'liquid_ish',
                'broth_potential',
              ],
              disallowedTags: [],
            },
            'Main Course': {
              allowedTags: [
                'grain',
                'noodle',
                'protein',
                'vegetable',
                'fusion',
                'umami',
                'spicy',
                'savory_compatible',
              ],
              disallowedTags: ['delicate', 'floral'],
            },
            Snack: {
              allowedTags: [
                'grain',
                'protein',
                'vegetable',
                'fruit',
                'candy',
                'portable_snack_form',
                'street_food_snack',
                'fusion',
                'savory_compatible',
                'sweet_compatible',
                'spicy',
                'crunchy',
                'chewy',
              ],
              disallowedTags: ['fragile_garnish', 'delicate'],
            },
            Salad: {
              allowedTags: [
                'vegetable',
                'fruit',
                'protein',
                'fusion',
                'fresh',
                'crisp',
                'savory_compatible',
                'sweet_compatible',
              ],
              disallowedTags: [
                'heavy_grain',
                'gamey_meat',
                'starchy_vegetable_strong',
              ],
            },
          },
        },
        spiritWorld: {
          ingredients: {
            general: [
              {
                name: 'Luminous Fungi Clusters',
                type: 'fungi',
                rolePreference: ['primary', 'garnish', 'base'],
                canBeBase: true,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'spirit_world',
                  'ethereal',
                  'glowing',
                  'mystical',
                  'umami_light',
                  'fungi',
                  'sweet_compatible',
                  'dessert_base_ok',
                  'spiritual_essence',
                  'beverage_component',
                  'delicate',
                  'shifting_texture',
                ],
                rarity: 'epic',
                flavorNotes: [
                  'delicate_umami',
                  'moonlight_taste',
                  'shifting_texture',
                  'faintly_sweet',
                  'otherworldly',
                  'translucent',
                  'pulsing',
                ],
                loreHints: ['Luminous Fungi Clusters'],
              },
            ],
            fruitsAndNectars: [
              {
                name: 'Moon_Touched Fruit Pulp',
                type: 'fruit_product',
                rolePreference: ['base', 'primary', 'liquid'],
                canBeBase: true,
                weight: 'medium',
                rawCompatible: true,
                tags: [
                  'spirit_world',
                  'ethereal',
                  'sweet',
                  'nectar_base',
                  'nectar_source',
                  'sweet_compatible',
                  'dessert_fruit',
                  'dessert_base_ok',
                  'spiritual_essence',
                  'beverage_component',
                  'liquid_ish',
                  'fruit_puree_candidate',
                  'delicate',
                ],
                rarity: 'rare',
                flavorNotes: [
                  'dream_like_sweetness',
                  'phosphorescent_hue',
                  'cool_texture',
                  'delicate_sugariness',
                  'glowing',
                  'ephemeral',
                  'chilled',
                ],
                loreHints: ['fruit_from_spirit_wilds', 'reflects_inner_light'],
              },
              {
                name: 'Spirit Bloom Essence',
                type: 'flavoring',
                rolePreference: ['accent', 'seasoning'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'spirit_world',
                  'floral',
                  'magical',
                  'essence',
                  'nectar_source',
                  'sweet_compatible',
                  'spiritual_essence',
                  'sweet_herb',
                  'beverage_component',
                  'liquid_ish',
                  'delicate',
                ],
                rarity: 'epic',
                flavorNotes: [
                  'otherworldly_perfume',
                  'enhances_chi',
                  'sparkling_sensation',
                  'unseen-aroma',
                  'ethereal-fragrance',
                ],
                loreHints: ['Spirit Bloom Essence'],
              },
            ],
            spicesAndSalts: [
              {
                name: 'Ghost Peppercorns',
                type: 'spice',
                rolePreference: ['seasoning', 'accent'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'spirit_world',
                  'spice',
                  'ethereal_heat',
                  'phantom_spice',
                  'sweet_compatible_spice',
                  'savory_compatible_spice',
                  'subtle',
                ],
                rarity: 'rare',
                flavorNotes: [
                  'fleeting_warmth',
                  'whisper_of_spice',
                  'cools_then_warms',
                  'ember_like_heat',
                  'unsettling',
                  'transparent-spice',
                ],
                loreHints: ['Ghost Peppercorns'],
              },
              {
                name: 'Silver Salt Crystals',
                type: 'salt',
                rolePreference: ['seasoning'],
                canBeBase: false,
                weight: 'light',
                rawCompatible: true,
                tags: [
                  'spirit_world',
                  'salt',
                  'clarifying',
                  'mineral',
                  'sweet_compatible_seasoning',
                  'savory_compatible_seasoning',
                  'subtle',
                  'crystalline_echo',
                ],
                rarity: 'rare',
                flavorNotes: [
                  'awakens_clarity',
                  'crystalline_echo',
                  'faint_shimmer',
                  'pure-salt',
                  'light-sparkle',
                ],
                loreHints: ['Silver Salt Crystals'],
              },
            ],
          },
          cookingStyles: [
            {
              name: 'naturally occurring/manifesting',
              tags: [
                'spiritWorldNature',
                'ethereal',
                'uniqueSpirit',
                'no_cook',
              ],
            },
            {
              name: 'ethereal transformation',
              tags: ['spiritWorldMagic', 'ethereal', 'uniqueSpirit', 'no_cook'],
            },
            {
              name: 'infusion with spiritual energy',
              tags: [
                'spiritWorldMagic',
                'ethereal',
                'uniqueSpirit',
                'infusion',
              ],
            },
            {
              name: 'emotion_reactive seasoning',
              tags: [
                'spiritWorldMagic',
                'ethereal',
                'uniqueSpirit',
                'mindTechnique',
                'no_cook',
              ],
            },
            {
              name: 'dream_weaving of flavors',
              tags: [
                'spiritWorldMagic',
                'ethereal',
                'uniqueSpirit',
                'mindTechnique',
                'no_cook',
              ],
            },
            {
              name: 'spirit_coaxing',
              tags: [
                'spiritWorldMagic',
                'ethereal',
                'uniqueSpirit',
                'infusion',
              ],
            },
          ],
          adjectives: [
            'Spirit Grove',
            'Luminous Path',
            "Whispering Woods'",
            'Otherworldly Bloom',
            'Mystical Dew',
            'Ephemeral',
            'Glimmering',
            'Dream_like',
            'Celestial',
            'Phantom',
            'Aetheric',
            'Shifting',
            'Ancestral',
            'Echoing',
          ],
          nameFormats: [
            {
              pattern: '{adj} {mainIngredient} Nectar of {spirit_location}',
              slots: {
                adj: ['Glimmering', 'Ephemeral', 'Moon_Kissed'],
                mainIngredient: 'use_selected_main_ingredient',
                spirit_location: [
                  'the Spirit Wilds',
                  'a Forgotten Shrine',
                  'the Whispering Falls',
                ],
              },
            },
            {
              pattern: "Dreamer's {mainIngredient} {format}",
              slots: {
                mainIngredient: 'use_selected_main_ingredient',
                format: 'use_dish_format',
              },
            },
            {
              pattern: '{emotion} of the {named_spirit_being}',
              slots: {
                emotion: ['Tears', 'Laughter', 'Whispers'],
                named_spirit_being: 'use_named_spirit_being',
              },
            },
            {
              pattern: 'Spirit_Touched {mainIngredient} Blessing',
              slots: { mainIngredient: 'use_selected_main_ingredient' },
            },
          ],
          platingNotes: [
            "Naturally beautiful and seemingly effortless presentation, as if the dish arranged itself. Ingredients may glow faintly or shimmer with an internal light, perhaps served in levitating shell bowls or on polished river stones that hum with energy. Served on moss, polished river stones, large iridescent leaves, or in cups made of woven light or solidified moonlight. The aesthetic is otherworldly and dreamlike, often incorporating bioluminescent flora or swirling mists that respond to the diner's spirit.",
            'Presentation is an art form, often involving naturally glowing elements or serving vessels that seem to defy physics. Colors are ethereal, shifting subtly with the light, and ingredients might appear to suspend in air or water, creating an otherworldly, dreamlike visual experience.',
          ],
          nationDishTypeProfiles: {
            Dessert: {
              allowedTags: [
                'ethereal',
                'sweet',
                'fruit',
                'nectar_source',
                'spiritual_essence',
                'fungi',
                'liquid_ish',
                'delicate',
                'subtle',
                'floral',
                'creamy',
              ],
              disallowedTags: [
                'pungent_spice',
                'savory_scramble',
                'strong_fish',
              ],
            },
            Nectar: {
              allowedTags: [
                'ethereal',
                'sweet',
                'fruit',
                'nectar_source',
                'spiritual_essence',
                'fungi',
                'liquid_ish',
                'delicate',
                'subtle',
                'beverage_component',
                'infusible_herb',
                'creamy',
              ],
              disallowedTags: [
                'solid_food_component',
                'pungent_spice',
                'savory_scramble',
                'strong_fish',
              ],
            },
            Beverage: {
              allowedTags: [
                'ethereal',
                'sweet',
                'fruit',
                'nectar_source',
                'spiritual_essence',
                'fungi',
                'liquid_ish',
                'delicate',
                'subtle',
                'beverage_component',
                'infusible_herb',
                'creamy',
              ],
              disallowedTags: [
                'solid_food_component',
                'pungent_spice',
                'savory_scramble',
                'strong_fish',
              ],
            },
            'Main Course': {
              allowedTags: [
                'ethereal',
                'umami_light',
                'delicate',
                'subtle',
                'fungi',
                'fruit',
                'protein',
                'sweet_compatible',
                'savory_compatible',
              ],
              disallowedTags: [
                'fiery',
                'strong_fish',
                'gamey_meat',
                'pungent_spice',
                'heavy_grain',
                'starchy_vegetable_strong',
              ],
            },
            Snack: {
              allowedTags: [
                'ethereal',
                'sweet',
                'fruit',
                'fungi',
                'delicate',
                'subtle',
                'portable_snack_form',
              ],
              disallowedTags: [
                'fiery',
                'strong_fish',
                'gamey_meat',
                'pungent_spice',
                'heavy_grain',
                'starchy_vegetable_strong',
              ],
            },
            Salad: {
              allowedTags: [
                'ethereal',
                'fresh',
                'crisp',
                'delicate',
                'fungi',
                'fruit',
                'vegetable',
              ],
              disallowedTags: [
                'fiery',
                'strong_fish',
                'gamey_meat',
                'pungent_spice',
                'heavy_grain',
                'starchy_vegetable_strong',
              ],
            },
          },
        },
        baseComponents: {
          grains: [
            'Rice Noodles',
            'Wheat Noodles',
            'Buckwheat Noodles',
            'Rice Paper Wrappers',
            'Steamed Buns',
            'Dumpling Wrappers',
            'Flatbread',
            'Savory Pancakes',
            'Porridge Base (Congee_like)',
            'Millet',
            'Quinoa (Ancient Variety)',
            'Spelt Flour',
          ],
          vegetable_bases: [
            'Shredded Cabbage',
            'Mashed Taro Root',
            'Lotus Root Slices (Raw/Steamed)',
            'Bamboo Shoots (Prepared)',
            'Seaweed Sheets (Nori_like)',
            'Squash Puree',
            'Mushroom Caps (Large, for stuffing)',
          ],
          fruit_bases_dessert: [
            'Pureed Mango',
            'Coconut Cream Base',
            'Lychee Jelly',
            'Berry Compote (Thickened)',
            'Fruit Leather (as a wrap/layer)',
          ],
          protein_bases: [
            'Pressed Tofu Blocks',
            'Seitan (Wheat Gluten)',
            'Minced Meat/Fish (for patties/stuffing)',
          ],
          liquid_bases: [
            'Vegetable Broth',
            'Mushroom Broth',
            'Clear Dashi_like Broth',
            'Coconut Milk',
            'Fruit Nectar Base',
            'Herbal Tea Infusion (Unsweetened)',
          ],
        },
        flavorProfiles: {
          savory: [
            'Umami_Rich Soy Sauce',
            'Fermented Bean Paste (Miso_like)',
            'Toasted Sesame Oil',
            'Ginger_Garlic Paste',
            'Spicy Chili Crisp',
            'Pickled Vegetable Brine',
            'Smoked Paprika',
            'Mushroom Powder',
            'Nutritional Yeast (Cheesy/Nutty)',
          ],
          sweet: [
            'Raw Honey',
            'Date Syrup',
            'Molasses',
            'Palm Sugar',
            'Fruit Reduction Glaze',
            'Sweet Bean Paste (Anko_like)',
            'Candied Ginger',
            'Vanilla_like Bean Extract',
            'Rosewater/Orange Blossom Water',
          ],
          spicy: [
            'Fresh Chilies (various heat levels)',
            'Dried Chili Flakes',
            'Sichuan_Peppercorn_like Spice (Numbing Heat)',
            'Hot Mustard Paste',
            'Wasabi_like Root Paste',
            'Pepper Oil Infusion',
          ],
          sour_tangy: [
            'Rice Vinegar',
            'Black Vinegar',
            'Pickled Plum Juice',
            'Tamarind Paste',
            'Citrus Zest/Juice (Yuzu_like, Pomelo)',
            'Fermented Rice Wine (for cooking)',
          ],
          aromatic_herbal: [
            'Fresh Mint',
            'Cilantro',
            'Thai Basil',
            'Lemongrass Stalks',
            'Star Anise',
            'Cinnamon Bark',
            'Cardamom Pods',
            'Dried Seaweed Flakes (Furikake_like)',
            'Edible Flowers (e.g., Chrysanthemum, Osmanthus)',
          ],
        },
        cookingMethodsByDishType: {
          'Main Course': [
            'stir_frying',
            'roasting',
            'grilling',
            'braising',
            'bakingFriendly',
            'steaming',
            'searing',
            'simmering',
            'infusion',
          ],
          'Side Dish': [
            'steaming',
            'light_stir_frying',
            'pickling',
            'blanching',
            'marinating',
            'roasting',
            'frying',
          ],
          Snack: [
            'frying',
            'bakingFriendly',
            'drying',
            'skewering',
            'grilling',
            'rolling',
            'deep_frying',
            'quick_stir_frying',
            'wrapping',
            'steaming',
          ],
          Dessert: [
            'bakingFriendly',
            'chilling/freezing',
            'steaming',
            'fruit carving',
            'syrup infusion',
            'no_cook',
            'air_whisking',
            'glazing',
            'infusion',
            'cold_prep',
          ],
          Beverage: [
            'brewing',
            'infusion',
            'juicing',
            'blending',
            'fermenting',
            'ice_chilling',
            'air_whisking',
            'no_cook',
            'cold_prep',
          ],
          'Soup/Stew': ['simmering', 'boiling', 'slow_cooking', 'infusion'],
          Salad: [
            'tossing',
            'marinating',
            'raw assembly',
            'light_grilling',
            'chilling',
            'no_cook',
          ],
          'Sauce/Condiment': [
            'reducing',
            'blending',
            'fermenting',
            'emulsifying',
            'infusion',
            'no_cook',
          ],
          'Street Food': [
            'grilling',
            'deep_frying',
            'steaming',
            'quick_stir_frying',
            'wrapping',
            'skewering',
            'frying',
            'roasting',
            'bakingFriendly',
          ],
          'Festival Dish': [
            'large_batch_roasting/stewing',
            'decorative_baking',
            'communal_grilling',
            'symbolic_ingredient_preparation',
            'bakingFriendly',
          ],
          Appetizer: [
            'delicate_frying',
            'chilling',
            'marinating',
            'skewering',
            'wrapping',
            'steaming',
            'no_cook',
          ],
          'Bread/Pastry': [
            'bakingFriendly',
            'steaming',
            'frying',
            'proofing/fermenting_dough',
          ],
          Nectar: [
            'infusion',
            'blending',
            'gentle_simmering',
            'ethereal_coaxing',
            'ice_chilling',
            'air_whisking',
            'no_cook',
            'cold_prep',
          ],
        },
        themes: {
          Spiritual: {
            adj: ['Spirit_Touched', 'Luminous Soul'],
            conceptMod:
              'infused with a subtle spiritual energy, transcending the mundane. The preparation often involves elements of mindfulness or ancient rituals.',
            plating:
              'minimalist, natural elements, perhaps a single edible flower or a scattering of symbolic seeds. Served with a gentle, glowing aura.',
            loreHints: ['meditation', 'spirit_communion'],
            loreSourceTag: 'spiritual_theme',
          },
          Royal: {
            adj: ["Regal Dragon's", 'Imperial Phoenix Crest'],
            conceptMod:
              'fit for the highest royalty, showcasing opulent ingredients and meticulous preparation. It speaks of power, legacy, and refined taste.',
            plating:
              'elaborate, often with intricate carvings, edible gold leaf, or highly precise arrangements. Serveware is typically fine porcelain or polished precious metals.',
            loreHints: ['coronation', 'royal_chef'],
            loreSourceTag: 'royal_theme',
          },
          Rustic: {
            adj: ['Farmstead', 'Village Hearth'],
            conceptMod:
              'unpretentious, hearty, and wholesome, celebrating the natural flavors of locally sourced ingredients, often featuring preserved or foraged items. It embodies comfort and community.',
            plating:
              'simple, on wooden boards, handmade pottery, or even a clean banana leaf. Generous portions, garnished with fresh, roughly chopped herbs or a sprinkle of toasted grains.',
            loreHints: [
              'farm_to_table',
              'village_elder_recipe',
              'humble_origins',
            ],
            loreSourceTag: 'rustic_theme',
          },
          Innovative: {
            adj: ['Future Tech', 'Zaofu Avant_Garde'],
            conceptMod:
              'a modern, perhaps even experimental dish utilizing new techniques or unusual ingredient combinations, reflecting progress and ingenuity. It challenges traditional palates.',
            plating:
              'deconstructed, with molecular gastronomy influences, surprising textures and presentations, possibly involving sleek metal or crystal serveware (Zaofu style).',
            loreHints: ['zaofu_creation', 'inventors_fuel'],
            loreSourceTag: 'innovative_theme',
          },
          Street: {
            adj: ['Bustling Market', 'Alleyway'],
            conceptMod:
              "a bustling market favorite, designed for quick consumption and bold, memorable flavors. It embodies the vibrant energy and diverse tastes of the city's thoroughfares.",
            plating:
              'portable, easy_to_eat formats such as skewers, wraps, cones, or sturdy bowls, emphasizing convenience and immediate enjoyment. Often garnished simply for visual appeal on the go.',
            loreHints: ['street_vendor', 'fast_fuel', 'market_favorite'],
            loreSourceTag: 'street_theme',
          },
          Traveler: {
            adj: ["Wanderer's", "Trailblazer's"],
            conceptMod:
              'a robust and versatile meal, ideal for sustenance during long journeys across varied landscapes. It emphasizes portability, preservation, and nourishing ingredients.',
            plating:
              'practical and sturdy, often in wrapped forms (leaf or paper), packed for transport, or served in simple, durable containers. The focus is on utility and preserving freshness.',
            loreHints: ["wanderer's_fare", 'expedition_staple'],
            loreSourceTag: 'traveler_theme',
          },
        },
        genericAdjectives: [
          'Hearty',
          'Delicate',
          'Crispy',
          'Savory',
          'Sweet',
          'Zesty',
          'Aromatic',
          'Vibrant',
          'Mellow',
          'Robust',
          'Tangy',
          'Spirited',
          'Earthy',
          'Fiery',
          'Cooling',
          'Nourishing',
          'Exquisite',
          'Rustic',
          'Wholesome',
          'Inventive',
          'Forgotten',
          'Ancient',
          'Elemental',
          'Luscious',
          'Rich',
          'Subtle',
          'Pure',
          'Bright',
          'Grounded',
          'Refreshing',
          'Intense',
          'Complex',
          'Balanced',
          'Crisp',
          'Fluffy',
          'Tender',
          'Nutty',
          'Buttery',
          'Smooth',
          'Succulent',
          'Golden',
          'Velvety',
          'Juicy',
          'Fragrant',
          'Piquant',
          'Briny',
          'Misty',
          'Glimmering',
          'Sun-Kissed',
          'Moonlit',
          'Shadowed',
          'Whispered',
          'Venerable',
          'Lively',
          'Aqueous',
          'Arboreal',
          'Subterranean',
          'Aetherial',
          'Radiant',
          'Comforting',
          'Invigorating',
          'Pungent',
          'Glazed',
          'Infused',
          'Sizzling',
          'Steaming',
          'Ethereal',
        ],
        genericDishNouns: [
          'Delight',
          'Feast',
          'Surprise',
          'Medley',
          'Creation',
          'Special',
          'Bowl',
          'Plate',
          'Bites',
          'Strips',
          'Cakes',
          'Rolls',
          'Pockets',
          'Concoction',
          'Essence',
          'Journey',
          'Harmony',
          'Revelation',
          'Symphony',
          'Tribute',
          'Nectar',
          'Stew',
          'Tart',
          'Pie',
          'Wrap',
          'Skewer',
          'Crumbles',
          'Cracks',
          'Infusion',
          'Puree',
          'Elixir',
          'Crumble',
          'Clouds',
          'Pudding',
          'Custard',
          'Sorbet',
          'Jelly',
          'Dream',
          'Whisper',
          'Vapor',
          'Sparkle',
          'Glow',
          'Offering',
          'Bloom',
          'Harvest',
          'Melody',
          'Secret',
          'Vision',
          'Temptation',
        ],
      };
      // END OF FULL CANON_DATA

      const CULINARY_CONNECTORS = [
        'Then,',
        'Following this,',
        'Next,',
        'To complement this,',
        'Adding another layer,',
        'Subsequently,',
        'Building upon that,',
        'Furthermore,',
        'In continuation,',
        'Moreover,',
        'To enhance this,',
        'Progressing the flavors,',
        'The journey continues as',
        'Additionally,',
        'Finally,',
        'In contrast,',
        'Afterward,',
        'Leading into,',
        'Culminating in,',
      ];

      // --- Validation and Filtering Helpers ---
      /**
       * Checks if an ingredient is "sweet-compatible".
       * @param {object} ingredient
       * @returns {boolean}
       */
      function isSweetIngredient(ingredient) {
        if (!ingredient || typeof ingredient !== 'object') return false;
        const tags = getIngredientTags(ingredient);
        const type = getIngredientType(ingredient);
        return (
          tags.includes('sweet_compatible') ||
          ['fruit', 'sweetener', 'nectar_source', 'dairy'].includes(type) ||
          (type.includes('grain') &&
            tags.includes('light_grain') &&
            tags.includes('can_be_sweetened_neutral')) || // Use .includes for types
          tags.includes('can_be_sweetened_neutral') ||
          tags.includes('spiritual_essence') ||
          tags.includes('floral') ||
          tags.includes('dessert_base_ok') ||
          tags.includes('nectar_base') ||
          tags.includes('liquid_ish')
        );
      }

      /**
       * Describes the flavor of an ingredient, optionally avoiding redundant descriptors.
       * @param {object} item The ingredient object.
       * @param {string} context The context of the description (e.g., "concept", "journey_intro").
       * @param {string} dishType The current dish type.
       * @param {Set<string>} usedDescriptors A set to track descriptors already used in a larger phrase.
       * @returns {string} A descriptive string for the ingredient's flavor.
       */
      function describeFlavorOfItem(
        item,
        context = 'default',
        dishType = 'Main Course',
        usedDescriptors = new Set()
      ) {
        if (item === undefined || item === null) {
          return 'a mysterious essence';
        }
        if (typeof item !== 'object') {
          const displayNameFromNameFunc = getIngredientName(item, true);
          return `the essence of ${displayNameFromNameFunc || 'an unknown item'}`;
        }

        const displayName = getIngredientName(item, true);

        const notes = getIngredientFlavorNotes(item);
        const tags = getIngredientTags(item);
        let primaryFlavorCandidate = 'distinctive';

        const genericFlavorTerms = [
          'unique',
          'notable',
          'characteristic',
          'particular',
          'special',
          'individual',
          'distinctive',
          'versatile',
          'mild',
          'gentle',
          'delightful',
          'appealing',
          'savoury',
          'rich',
          'intense',
          'complex',
          'subtle',
        ];
        const bannedTagsFromPrimaryFlavor = [
          'fruit',
          'vegetable',
          'meat',
          'dairy',
          'grain',
          'herb',
          'spice',
          'oil',
          'condiment',
          'garnish',
          'base',
          'primary',
          'accent',
          'seasoning',
          'staple',
          'common',
          'uncommon',
          'rare',
          'epic',
          'mythic',
          'vegetarian',
          'vegan',
          'generic',
          'component',
          'other',
          'liquid',
          'fat',
          'protein',
          'root_veg',
          'leafy_green',
          'stone_fruit',
          'soy',
          'roasted_flour',
          'nut_milk',
          'sprout',
          'berry',
          'squash',
          'salt',
          'vinegar',
          'sweet_root_tubers',
          'nectar_source',
          'nectar_base',
          'sweet_compatible',
          'grain_product',
          'dessert_fruit',
          'light_grain',
          'heavy_grain',
          'can_be_sweetened_neutral',
          'sweet_compatible_binder',
          'sweet_compatible_spice',
          'sweet_compatible_seasoning',
          'pungent_spice',
          'distinctly_savory_protein',
          'savory_scramble',
          'kimchi',
          'fermented_savory',
          'strong_fish',
          'gamey_meat',
          'bitter_herb_dominant',
          'savory_broth_concentrate',
          'starchy_vegetable_strong',
          'solid_food_component',
          'liquid_ish',
          'infusible_herb',
          'beverage_component',
          'fruit_puree_candidate',
          'crispy_bread_component',
          'savory_dessert_base',
          'sweet_sour_balance',
          'sweet_savory_balance',
          'portable_snack_form',
          'street_food_base',
          'street_food_snack',
          'skewerable_protein',
          'fragile_garnish',
          'delicate',
          'ceremonial',
          'fine_dining',
          'fragrant_spice',
          'warm_spice',
          'chewy',
          'icy',
          'briny',
          'juicy',
          'dried',
          'glowing',
          'mystical',
          'umami_light',
          'ethereal',
          'vibrant',
          'dramatic',
          'absorbent_neutral',
          'gentle_flavor',
          'soup_compatible',
          'stew_compatible',
          'glaze_compatible',
          'fusion',
          'uniqueAir',
          'uniqueWater',
          'uniqueEarth',
          'uniqueFire',
          'uniqueSpirit',
          'cold_prep',
          'no_cook',
          'noodle_prep',
          'slow_cooking',
          'spiritualFire',
          'rareTechnique',
          'lightDishOnly',
          'mindTechnique',
          'techInfluence',
          'cafe_staple',
          'breakfast',
          'tropical',
          'coastal',
          'preserved',
          'crystallized',
          'dairy_polar',
          'dairy_ek',
          'dairy_fn',
          'dairy_urc',
          'gochujang_like',
          'iodine_rich',
          'skewerable_protein',
          'wrap_filler',
          'sweet_sour_balance',
          'sweet_savory_balance',
        ].map((t) => t.toLowerCase());

        let potentialFlavors = notes.filter(
          (n) =>
            n &&
            n !== 'neutral' &&
            n !== 'neutral_base' &&
            !genericFlavorTerms.includes(n.toLowerCase())
        );

        if (potentialFlavors.length === 0) {
          potentialFlavors = tags.filter(
            (t) =>
              t &&
              !bannedTagsFromPrimaryFlavor.includes(t.toLowerCase()) &&
              !t.includes('_nation') &&
              !t.includes('_tribe') &&
              !t.includes('_world') &&
              !t.includes('food') &&
              !t.includes('influence') &&
              !t.includes('component') &&
              !t.includes('base') &&
              !t.includes('product') &&
              !t.includes('_ok') &&
              !t.includes('_herb') &&
              !t.includes('_spice') &&
              !t.includes('_seasoning') &&
              !t.includes('spiritual_essence') &&
              !t.includes('compatible') &&
              !genericFlavorTerms.includes(t.toLowerCase())
          );
        }

        let primaryFlavor = (
          potentialFlavors.length > 0 ? potentialFlavors[0] : 'distinctive'
        ).split('_')[0];

        if (
          usedDescriptors.has(primaryFlavor.toLowerCase()) ||
          genericFlavorTerms.includes(primaryFlavor.toLowerCase())
        ) {
          let alternative = potentialFlavors.find(
            (f) =>
              !usedDescriptors.has(f.toLowerCase()) &&
              !genericFlavorTerms.includes(f.toLowerCase()) &&
              f !== 'neutral' &&
              f !== 'neutral_base'
          );
          if (alternative) {
            primaryFlavor = alternative.split('_')[0];
          } else {
            primaryFlavor =
              getRandomElement(
                genericFlavorTerms.filter((gft) => !usedDescriptors.has(gft))
              ) || 'unique';
          }
        }

        if (
          ['Beverage', 'Nectar', 'Dessert', 'Salad'].includes(dishType) &&
          (primaryFlavor.toLowerCase() === 'hearty' ||
            primaryFlavor.toLowerCase() === 'robust' ||
            primaryFlavor.toLowerCase() === 'deep')
        ) {
          primaryFlavor = getRandomElement([
            'light',
            'delicate',
            'refreshing',
            'bright',
          ]);
        }

        if (
          primaryFlavor === 'delicate' &&
          (tags.includes('strong_fish') ||
            tags.includes('gamey_meat') ||
            tags.includes('pungent_spice'))
        ) {
          primaryFlavor = getRandomElement(['bold', 'intense', 'vibrant']);
        }

        if (primaryFlavor !== 'neutral' && primaryFlavor !== 'neutral_base') {
          usedDescriptors.add(primaryFlavor.toLowerCase());
        }

        const adjectives = {
          spicy: [
            'fiery',
            'zesty',
            'warming',
            'piquant',
            'scorching',
            'tingling',
            'hot-kissed',
            'blazing',
          ],
          sweet: [
            'honeyed',
            'sugary',
            'luscious',
            'nectar-like',
            'candied',
            'caramelized',
            'fragrant-sweet',
            'delicate-sweet',
          ],
          sour: [
            'tart',
            'tangy',
            'bright',
            'citrusy',
            'zingy',
            'acidic',
            'sharp-sour',
          ],
          umami: [
            'savory',
            'rich',
            'brothy',
            'deep',
            'earthy-umami',
            'meaty-umami',
            'fermented-umami',
          ],
          floral: [
            'aromatic',
            'petal-like',
            'fragrant',
            'perfumed',
            'blooming',
            'subtle-floral',
          ],
          creamy: [
            'velvety',
            'smooth',
            'silken',
            'rich-cream',
            'luscious-texture',
            'melt-in-mouth',
          ],
          earthy: [
            'rustic',
            'grounded',
            'rooty',
            'loamy',
            'deep-earth',
            'forest-floor',
            'mineral-rich',
          ],
          smoky: [
            'charred',
            'embers_kissed',
            'toasted',
            'campfire-scented',
            'wood-fired',
            'ashy',
          ],
          briny: [
            'oceanic',
            'sea_kissed',
            'salty',
            'marine',
            'tidal',
            'fresh-brine',
          ],
          light: [
            'ethereal',
            'delicate',
            'airy',
            'floating',
            'subtle',
            'feather-light',
          ],
          crispy: [
            'crunchy',
            'crackling',
            'brittle',
            'snappy',
            'shattering',
            'crisp-fried',
          ],
          fresh: [
            'vibrant',
            'clean',
            'bright',
            'garden-fresh',
            'dewy',
            'newly-picked',
          ],
          chewy: [
            'resilient',
            'satisfying',
            'tender-chew',
            'hearty-bite',
            'elastic',
          ],
          mild: [
            'subtle',
            'gentle',
            'nuanced',
            'delicate-flavor',
            'unassuming',
            'soft',
          ],
          sharp: ['piquant', 'crisp', 'intense', 'biting', 'clear', 'incisive'],
          appealing: [
            'delightful',
            'inviting',
            'tempting',
            'attractive',
            'enticing',
          ],
          vibrant: [
            'lively',
            'radiant',
            'colorful',
            'bright-hued',
            'energetic',
          ],
          luscious: ['sumptuous', 'succulent', 'opulent', 'rich-bodied'],
          fragrant: ['aromatic', 'perfumed', 'redolent'],
          glowing: ['radiant', 'luminous', 'incandescent', 'shimmering'],
          ethereal: [
            'otherworldly',
            'dream-like',
            'celestial',
            'phantom',
            'transcendent',
          ],
          nutty: [
            'toasted',
            'earthy',
            'roasted-nut',
            'buttery-nut',
            'praline-like',
          ],
          pure: ['unblemished', 'pristine', 'unadulterated', 'clean-tasting'],
          cool: ['refreshing', 'chilled', 'icy', 'minty', 'bracing'],
          grounded: ['firm', 'solid', 'stable', 'rooted'],
          tender: ['succulent', 'soft', 'yielding', 'delicate-flesh'],
          fluffy: ['airy', 'light', 'cloud-like', 'downy'],
          buttery: ['smooth', 'rich', 'velvety', 'melted'],
          oily: ['unctuous', 'rich', 'smooth-mouthfeel', 'slippery'],
          sweet_tart: ['balanced', 'bright', 'contrasting', 'harmonious'],
          honeyed: ['nectarous', 'rich', 'golden', 'syrupy'],
          viscous: ['thick', 'syrupy', 'gooey', 'dense'],
        };

        let specificFlavorAdj = primaryFlavor.replace(/_/g, ' ');
        if (adjectives[primaryFlavor]) {
          specificFlavorAdj =
            getRandomElement(
              adjectives[primaryFlavor].filter(
                (d) => !usedDescriptors.has(d.toLowerCase())
              )
            ) || specificFlavorAdj;
        }
        usedDescriptors.add(specificFlavorAdj.toLowerCase());

        if (context === 'template_simple_flavor_adj') {
          return specificFlavorAdj;
        }
        if (context === 'template_simple_flavor_noun') {
          let nounForm = '';
          switch (primaryFlavor.toLowerCase()) {
            case 'sweet':
              nounForm = 'sweetness';
              break;
            case 'spicy':
              nounForm = 'spicy kick';
              break;
            case 'sour':
              nounForm = 'tangy note';
              break;
            case 'tart':
              nounForm = 'refreshing tartness';
              break;
            case 'umami':
              nounForm = 'savory depth';
              break;
            case 'savory':
              nounForm = 'rich savoriness';
              break;
            case 'sharp':
              nounForm = 'sharp note';
              break;
            case 'bitter':
              nounForm = 'bitter hint';
              break;
            case 'earthy':
              nounForm = 'earthy tone';
              break;
            case 'creamy':
              nounForm = 'rich creaminess';
              break;
            case 'velvety':
              nounForm = 'velvety smoothness';
              break;
            case 'floral':
              nounForm = 'aromatic bloom';
              break;
            case 'smoky':
              nounForm = 'smoky whisper';
              break;
            case 'briny':
              nounForm = 'oceanic tang';
              break;
            case 'light':
              nounForm = 'lightness';
              break;
            case 'crispy':
              nounForm = 'delightful crisp';
              break;
            case 'fresh':
              nounForm = 'bright freshness';
              break;
            case 'chewy':
              nounForm = 'satisfying chewiness';
              break;
            case 'mild':
              nounForm = 'subtle character';
              break;
            case 'vibrant':
              nounForm = 'vibrant quality';
              break;
            case 'luscious':
              nounForm = 'luscious texture';
              break;
            case 'fragrant':
              nounForm = 'fragrant aroma';
              break;
            case 'glowing':
              nounForm = 'ethereal glow';
              break;
            case 'ethereal':
              nounForm = 'otherworldly essence';
              break;
            case 'appealing':
              nounForm = 'appealing look';
              break;
            case 'nutty':
              nounForm = 'nutty character';
              break;
            case 'pure':
              nounForm = 'pure essence';
              break;
            case 'cool':
              nounForm = 'cooling sensation';
              break;
            case 'grounded':
              nounForm = 'grounded quality';
              break;
            case 'tender':
              nounForm = 'tender quality';
              break;
            case 'fluffy':
              nounForm = 'fluffy texture';
              break;
            case 'buttery':
              nounForm = 'buttery richness';
              break;
            case 'oily':
              nounForm = 'oily richness';
              break;
            case 'sweet_tart':
              nounForm = 'sweet_tart balance';
              break;
            case 'honeyed':
              nounForm = 'honeyed notes';
              break;
            case 'viscous':
              nounForm = 'viscous sweetness';
              break;
            default:
              const type = getIngredientType(item);
              if (type.includes('fruit')) nounForm = 'fruity essence';
              else if (type.includes('herb')) nounForm = 'herbal note';
              else if (type.includes('spice')) nounForm = 'spicy hint';
              else if (type.includes('vegetable'))
                nounForm = 'vegetal character';
              else if (type.includes('dairy')) nounForm = 'creamy quality';
              else nounForm = 'unique character';
              break;
          }
          usedDescriptors.add(nounForm.toLowerCase());
          return nounForm;
        }

        let prefix = '';
        const vowels = 'aeiou';
        const firstWordOfFlavor = specificFlavorAdj.split(' ')[0].toLowerCase();
        if (
          context === 'journey_intro' ||
          context === 'journey_core' ||
          context === 'journey_aftertaste' ||
          context === 'concept' ||
          context === 'template'
        ) {
          prefix =
            vowels.includes(firstWordOfFlavor[0]) &&
            !firstWordOfFlavor.startsWith('uni') &&
            !firstWordOfFlavor.startsWith('eu')
              ? 'an '
              : 'a ';
        }

        let specificDesc = '';
        switch (primaryFlavor.toLowerCase()) {
          case 'spicy':
            specificDesc = getRandomElement([
              'zesty punch',
              'tingling warmth',
              'spirited kick',
              'ember_like heat',
              'fiery embrace',
            ]);
            break;
          case 'sweet':
            specificDesc = getRandomElement([
              'gentle sweetness',
              'honeyed notes',
              'delicate sugariness',
              'luscious sweetness',
            ]);
            break;
          case 'sour':
          case 'tart':
            specificDesc = getRandomElement([
              'bright acidity',
              'zesty tang',
              'refreshing tartness',
              'piquant sourness',
            ]);
            break;
          case 'smoky':
          case 'charred':
            specificDesc = getRandomElement([
              'wisp of smoke',
              'smoldering depth',
              'charred aroma',
              'earthy char',
            ]);
            break;
          case 'creamy':
          case 'velvety':
            specificDesc = getRandomElement([
              'velvety smoothness',
              'rich creaminess',
              'luscious texture',
              'silken body',
            ]);
            break;
          case 'earthy':
            if (['Beverage', 'Nectar', 'Dessert', 'Salad'].includes(dishType))
              specificDesc = getRandomElement([
                'subtle earthiness',
                'gentle grounding note',
              ]);
            else
              specificDesc = getRandomElement([
                'grounded earthiness',
                'rustic depth',
                'hearty savor',
              ]);
            break;
          case 'umami':
          case 'savory':
            specificDesc = getRandomElement([
              'deep umami',
              'savory richness',
              'satisfying depth',
              'robust savor',
            ]);
            break;
          case 'floral':
          case 'perfume':
            specificDesc = getRandomElement([
              'delicate floral perfume',
              'aromatic bloom',
              'subtle petal notes',
              'fragrant essence',
            ]);
            break;
          case 'briny':
          case 'oceanic':
            specificDesc = getRandomElement([
              'fresh oceanic tang',
              'bracing salinity',
              'taste of the sea caves',
              'marine freshness',
            ]);
            break;
          case 'light':
            specificDesc = getRandomElement([
              'ethereal lightness',
              'airy quality',
              'delicate touch',
            ]);
            break;
          case 'crispy':
            specificDesc = getRandomElement([
              'satisfying crunch',
              'crisp texture',
              'crackling sensation',
            ]);
            break;
          case 'fresh':
            specificDesc = getRandomElement([
              'vibrant freshness',
              'clean zest',
              'bright notes',
            ]);
            break;
          case 'chewy':
            specificDesc = getRandomElement([
              'pleasant chewiness',
              'resilient texture',
            ]);
            break;
          case 'mild':
            specificDesc = getRandomElement([
              'subtle character',
              'gentle flavor',
            ]);
            break;
          case 'vibrant':
            specificDesc = getRandomElement([
              'vibrant character',
              'lively notes',
            ]);
            break;
          case 'luscious':
            specificDesc = getRandomElement([
              'luscious texture',
              'sumptuous feel',
            ]);
            break;
          case 'glowing':
            specificDesc = getRandomElement(['ethereal glow', 'radiant light']);
            break;
          case 'ethereal':
            specificDesc = getRandomElement([
              'otherworldly essence',
              'dream_like quality',
            ]);
            break;
          case 'nutty':
            specificDesc = getRandomElement([
              'nutty character',
              'roasted nuttiness',
            ]);
            break;
          case 'pure':
            specificDesc = getRandomElement(['pure essence', 'clean taste']);
            break;
          case 'cool':
            specificDesc = getRandomElement([
              'cooling sensation',
              'refreshing chill',
            ]);
            break;
          case 'grounded':
            specificDesc = getRandomElement([
              'grounded quality',
              'solid presence',
            ]);
            break;
          case 'tender':
            specificDesc = getRandomElement([
              'tender texture',
              'succulent mouthfeel',
            ]);
            break;
          case 'fluffy':
            specificDesc = getRandomElement([
              'fluffy texture',
              'airy lightness',
            ]);
            break;
          case 'buttery':
            specificDesc = getRandomElement([
              'buttery richness',
              'smooth flavor',
            ]);
            break;
          case 'oily':
            specificDesc = getRandomElement([
              'oily richness',
              'smooth mouthfeel',
            ]);
            break;
          case 'sweet_tart':
            specificDesc = getRandomElement([
              'sweet_tart balance',
              'bright contrast',
            ]);
            break;
          case 'honeyed':
            specificDesc = getRandomElement([
              'honeyed notes',
              'golden sweetness',
            ]);
            break;
          case 'viscous':
            specificDesc = getRandomElement([
              'viscous sweetness',
              'syrupy texture',
            ]);
            break;
          case 'particular':
            specificDesc = getRandomElement([
              'particular character',
              'specific essence',
            ]);
            break;
          case 'sharp':
            specificDesc = getRandomElement([
              'sharp character',
              'crisp bite',
              'piquant quality',
            ]);
            break;
          case 'appealing':
            specificDesc = getRandomElement([
              'appealing look',
              'inviting appearance',
            ]);
            break;
          default:
            specificDesc = `${specificFlavorAdj} character`;
        }

        if (usedDescriptors.has(specificDesc.toLowerCase())) {
          const categoryAdjectives = adjectives[primaryFlavor] || [];
          const newSpecificDesc =
            getRandomElement(
              categoryAdjectives.filter(
                (d) => !usedDescriptors.has(d.toLowerCase())
              )
            ) || null;
          if (newSpecificDesc) {
            specificDesc = newSpecificDesc;
          } else {
            const genericFallback =
              getRandomElement(
                genericFlavorTerms.filter((gft) => !usedDescriptors.has(gft))
              ) || 'unique';
            usedDescriptors.add(genericFallback.toLowerCase());
            return `${prefix}${genericFallback} character from ${displayName}`;
          }
        }

        usedDescriptors.add(specificDesc.toLowerCase());
        return `${prefix}${specificDesc} from ${displayName}`;
      }

      /**
       * Validates if an ingredient is suitable for a given role and dish type, incorporating blacklists and nation profiles.
       * @param {object} ingredient The ingredient object.
       * @param {string} role The role (e.g., "base", "primary"). Can be 'any' for general dish type checks.
       * @param {string} dishType The dish type (e.g., "Dessert", "Soup/Stew").
       * @param {string[]} nationKeys The keys of the selected nations to check nationDishTypeProfiles.
       * @returns {boolean} True if the ingredient is valid, false otherwise.
       */
      function isValidIngredientForDishType(
        ingredient,
        role,
        dishType,
        nationKeys = []
      ) {
        if (!ingredient || typeof ingredient !== 'object') return false;
        const ingTags = getIngredientTags(ingredient);
        const ingType = getIngredientType(ingredient); // Extracted here for use in this function
        const ingName = getIngredientName(ingredient);
        const savoryDishTypes = [
          'Main Course',
          'Side Dish',
          'Soup/Stew',
          'Salad',
          'Street Food',
          'Festival Dish',
          'Appetizer',
        ];

        // 1. Check against general dish type blacklists (names and tags)
        const blacklistedTagsForDish = DISH_TYPE_BLACKLIST_TAGS[dishType] || [];
        const blacklistedNamesForDish =
          DISH_TYPE_BLACKLIST_INGREDIENT_NAMES[dishType] || [];

        // Allow neutral cooking oil as a binder for desserts even if it's on a blacklist, if it's explicitly sweet_compatible_binder
        if (
          blacklistedNamesForDish.includes(ingName) &&
          !(
            dishType === 'Dessert' &&
            ingName === 'Neutral Cooking Oil' &&
            ingTags.includes('sweet_compatible_binder')
          )
        ) {
          return false;
        }
        if (blacklistedTagsForDish.some((tag) => ingTags.includes(tag))) {
          return false;
        }

        // 2. Check against nation-specific dish type profiles (allowed/disallowed)
        const primaryNationKeyForProfile =
          nationKeys && nationKeys.length > 0 ? nationKeys[0] : null;
        if (
          primaryNationKeyForProfile &&
          CANON_DATA[primaryNationKeyForProfile] &&
          CANON_DATA[primaryNationKeyForProfile].nationDishTypeProfiles &&
          CANON_DATA[primaryNationKeyForProfile].nationDishTypeProfiles[
            dishType
          ]
        ) {
          const profile =
            CANON_DATA[primaryNationKeyForProfile].nationDishTypeProfiles[
              dishType
            ];

          if (profile.allowedTags && profile.allowedTags.length > 0) {
            // Ingredient must have at least one allowed tag, or be a versatile generic
            const hasAllowedTag = ingTags.some((tag) =>
              profile.allowedTags.includes(tag)
            );
            const isVersatileGeneric =
              ingTags.includes('generic') ||
              ingTags.includes('savory_compatible') ||
              ingTags.includes('sweet_compatible') ||
              ingTags.includes('can_be_sweetened_neutral');
            if (
              !hasAllowedTag &&
              !isVersatileGeneric &&
              ingType !== 'salt' &&
              ingType !== 'oil' &&
              ingType !== 'vinegar'
            ) {
              return false;
            }
          }
          if (profile.disallowedTags && profile.disallowedTags.length > 0) {
            if (ingTags.some((tag) => profile.disallowedTags.includes(tag))) {
              return false;
            }
          }
        }

        // 3. Role-specific suitability checks (only if role is not 'any')
        if (role !== 'any') {
          const ingWeight = getIngredientWeight(ingredient); // Also extracted here for use in this function
          const canBeBase = getCanBeBase(ingredient); // Extracted here

          if (['Dessert', 'Nectar', 'Beverage'].includes(dishType)) {
            if (
              (role === 'base' || role === 'primary') &&
              !isSweetIngredient(ingredient)
            )
              return false;
            if (role === 'seasoning') {
              // Ensure seasoning is sweet-compatible or a neutral/universal seasoning like salt/oil/generic herb/spice
              if (
                !(
                  isSweetIngredient(ingredient) ||
                  ingType.includes('spice') ||
                  ingType.includes('herb') ||
                  ingType.includes('sweetener') ||
                  ingType.includes('flavoring') ||
                  ingTags.includes('sweet_spice') ||
                  ingTags.includes('sweet_herb') ||
                  ingTags.includes('sweet_compatible_seasoning') ||
                  ingTags.includes('sweet_compatible_binder') ||
                  ingType.includes('salt') ||
                  ingType.includes('oil')
                )
              )
                return false;
            }
            if (
              role === 'garnish' &&
              ingType.includes('vegetable') &&
              !ingTags.includes('sweet_root_tubers') &&
              !ingTags.includes('edible_flower_petal') &&
              !isSweetIngredient(ingredient)
            )
              return false; // Use .includes for types
            if (
              ['Beverage', 'Nectar'].includes(dishType) &&
              !ingTags.includes('beverage_component') &&
              ![
                'spice',
                'herb',
                'sweetener',
                'salt',
                'flavoring',
                'fruit',
              ].some((t) => ingType.includes(t))
            )
              return false; // Use .includes for types
          } else if (savoryDishTypes.includes(dishType)) {
            // Savory Dish Logic
            if (
              (role === 'base' || role === 'primary') &&
              !ingTags.includes('savory_compatible') &&
              !isSweetIngredient(ingredient)
            )
              return false; // Allow sweet-savory balance primary if also savory compatible
            if (
              role === 'seasoning' &&
              !ingTags.includes('savory_compatible') &&
              !ingTags.includes('sweet_compatible_seasoning')
            )
              return false; // allow sweet seasonings if also savory compatible
          }

          // Structural Role Logic (based on general expectations for roles)
          if (role === 'base') {
            if (
              ['Beverage', 'Nectar'].includes(dishType) &&
              !ingTags.includes('liquid_ish') &&
              !ingTags.includes('fruit_puree_candidate') &&
              !ingTags.includes('infusible_herb')
            )
              return false;
            if (
              dishType === 'Soup/Stew' &&
              !ingTags.includes('liquid_base') &&
              !ingTags.includes('liquid_ish') &&
              !ingTags.includes('broth_potential')
            )
              return false;
            if (
              dishType === 'Salad' &&
              ingType.includes('grain') &&
              ingName.includes('sourdough') &&
              !ingTags.includes('crispy_bread_component')
            )
              return false; // Use .includes for types
          }

          // Street Food Specifics
          if (dishType === 'Street Food') {
            if (
              ['base', 'primary'].includes(role) &&
              !ingTags.some((t) =>
                [
                  'portable_snack_form',
                  'street_food_base',
                  'skewerable_protein',
                  'wrap_filler',
                ].includes(t)
              )
            )
              return false;
            if (
              ['accent', 'garnish'].includes(role) &&
              ingTags.some((t) =>
                [
                  'delicate',
                  'fragile_garnish',
                  'fine_dining',
                  'ceremonial',
                ].includes(t)
              )
            )
              return false;
          }
        }
        return true; // Default to true if no specific rule makes it valid
      }

      /**
       * Performs a basic schema validation for a CANON_DATA ingredient item.
       * Logs errors if required properties are missing.
       * @param {object} item The ingredient object to validate.
       * @returns {boolean} True if valid, false otherwise.
       */
      function validateCanonDataItem(item) {
        if (!item || typeof item !== 'object') {
          console.error(
            'Schema Validation Error: Item is null or not an object.',
            item
          );
          return false;
        }
        const requiredProps = [
          'name',
          'type',
          'rolePreference',
          'canBeBase',
          'tags',
          'rarity',
          'flavorNotes',
        ];
        let isValid = true;
        for (const prop of requiredProps) {
          if (item[prop] === undefined || item[prop] === null) {
            console.warn(
              `Schema Validation Warning: Ingredient "${item.name || 'Unnamed'}" is missing required property: "${prop}"`
            );
            // For critical properties, might return false or add a placeholder
            if (prop === 'name' || prop === 'type' || prop === 'tags') {
              isValid = false;
            }
          }
        }
        if (!Array.isArray(item.rolePreference)) {
          console.warn(
            `Schema Validation Warning: Ingredient "${item.name}" has non_array rolePreference.`
          );
          item.rolePreference = []; // Coerce to array for safety
        }
        if (!Array.isArray(item.tags)) {
          console.warn(
            `Schema Validation Warning: Ingredient "${item.name}" has non_array tags.`
          );
          item.tags = []; // Coerce to array for safety
        }
        return isValid;
      }

      /**
       * Cleans redundant phrases and corrects articles in a given text.
       * @param {string} text The text to clean.
       * @returns {string} The cleaned text.
       */
      function cleanRedundantPhrases(text) {
        if (typeof text !== 'string') return text;
        let cleanedText = text;

        const vowels = 'aeiou'; // Define vowels for the whole function

        cleanedText = cleanedText.replace(
          /\b(an)\s+([uU][nN][iI][qQ][uU][eE]|[uU][nN][iI][FfSsTtCc]|[eE][uU])/g,
          'a $2'
        );
        cleanedText = cleanedText.replace(/\b(a|an)\s+\1\b/gi, '$1');

        // Fixed: Inlined the vowel sound check directly into the callback
        cleanedText = cleanedText.replace(
          /\b(a|an) +([a-zA-Z\{][\w\{]*)/gi,
          (match, article, word) => {
            const firstLetter = word[0].toLowerCase();
            const isVowelSound =
              vowels.includes(firstLetter) &&
              !word.toLowerCase().startsWith('uni') &&
              !word.toLowerCase().startsWith('eu') &&
              !word.toLowerCase().startsWith('one');

            if (article.toLowerCase() === 'a' && isVowelSound) {
              return `an ${word}`;
            } else if (article.toLowerCase() === 'an' && !isVowelSound) {
              return `a ${word}`;
            }
            return match;
          }
        );

        // Specific redundant phrases (can expand as needed)
        cleanedText = cleanedText.replace(
          /its (a|an) (\w+ [\w_'-]+) and (its|the) (a|an)? \2/gi,
          'its $2'
        );
        cleanedText = cleanedText.replace(
          /its (a|an) (\w+ [\w_'-]+) and \2/gi,
          'its $2'
        );
        cleanedText = cleanedText.replace(
          /its (a|an) (\w+) character/gi,
          'its $2 character'
        );
        cleanedText = cleanedText.replace(
          /its (a|an) (\w+) essence/gi,
          'its $2 essence'
        );
        cleanedText = cleanedText.replace(
          /\bof an? ancient set of an? ancient\b/gi,
          'of a set of ancient'
        );
        cleanedText = cleanedText.replace(/\b(\w+)\s+\1\b/gi, '$1');
        cleanedText = cleanedText.replace(
          /a touch of an elegant touch/gi,
          'an elegant touch'
        );

        return cleanedText.replace(/\s+/g, ' ').trim();
      }

      /**
       * Collects all available ingredients from selected nations, applies initial filters,
       * and ensures generic fallback ingredients are present.
       * @param {string[]} nationKeys The keys of the selected nations.
       * @param {string} dishType The current dish type.
       * @param {string} themeVal The selected theme value.
       * @returns {object} An object containing the filtered ingredient objects, selected nations data, keys, and display names.
       */
      function collectAndFilterAvailableIngredients(
        nationKeys,
        dishType,
        themeVal
      ) {
        let availableIngredientObjects = [];
        const nationValueToKey = (val) => {
          const lowerVal = val.toLowerCase();
          if (lowerVal.includes('air')) return 'airNomads';
          if (lowerVal.includes('water')) return 'waterTribes';
          if (lowerVal.includes('earth')) return 'earthKingdom';
          if (lowerVal.includes('fire')) return 'fireNation';
          if (lowerVal.includes('united republic')) return 'unitedRepublic';
          if (lowerVal.includes('spirit world')) return 'spiritWorld';
          return lowerVal.replace(/\s+/g, '');
        };

        const selectedNationsData = [];
        let finalNationKeys = []; // Store actual keys used
        let nationDisplayNames = []; // Store actual display names used

        if (nationKeys && nationKeys.length > 0) {
          nationKeys.forEach((nationName) => {
            const key = nationValueToKey(nationName);
            if (CANON_DATA[key] && typeof CANON_DATA[key] === 'object') {
              selectedNationsData.push(CANON_DATA[key]);
              finalNationKeys.push(key);
              nationDisplayNames.push(nationName);
            }
          });
        }

        // Fallback to a random nation if none were selected or valid
        if (selectedNationsData.length === 0) {
          const allValidNationKeys = Object.keys(CANON_DATA).filter(
            (k) =>
              CANON_DATA[k] &&
              CANON_DATA[k].ingredients &&
              Object.keys(CANON_DATA[k].ingredients).length > 0 &&
              Array.isArray(CANON_DATA[k].adjectives) &&
              ![
                'baseComponents',
                'flavorProfiles',
                'cookingMethodsByDishType',
                'themes',
                'genericAdjectives',
                'genericDishNouns',
              ].includes(k)
          );
          const randomNationKey = getRandomElement(
            allValidNationKeys.length > 0
              ? allValidNationKeys
              : ['earthKingdom']
          );

          if (randomNationKey && CANON_DATA[randomNationKey]) {
            selectedNationsData.push(CANON_DATA[randomNationKey]);
            finalNationKeys.push(randomNationKey);
            const nationMap = {
              airNomads: 'Air Nomads',
              waterTribes: 'Water Tribes',
              earthKingdom: 'Earth Kingdom',
              fireNation: 'Fire Nation',
              unitedRepublic: 'United Republic',
              spiritWorld: 'Spirit World',
            };
            nationDisplayNames.push(
              nationMap[randomNationKey] ||
                randomNationKey.charAt(0).toUpperCase() +
                  randomNationKey.slice(1)
            );
          } else {
            // Absolute fallback if somehow no valid nations can be determined
            selectedNationsData.push(CANON_DATA.earthKingdom);
            finalNationKeys.push('earthKingdom');
            nationDisplayNames.push('Earth Kingdom');
            console.error(
              'CRITICAL FALLBACK: Defaulted to Earth Kingdom as no valid nation could be determined.'
            );
          }
        }

        selectedNationsData.forEach((nationData, index) => {
          const currentNationKey = finalNationKeys[index];
          const currentNationDisplayName = nationDisplayNames[index];
          Object.values(nationData.ingredients).forEach((categoryArray) => {
            if (Array.isArray(categoryArray)) {
              categoryArray.forEach((item) => {
                // Validate each item from CANON_DATA
                if (validateCanonDataItem(item)) {
                  availableIngredientObjects.push({
                    ...item,
                    sourceNation: item.sourceNation || currentNationDisplayName,
                    sourceNationKey: item.sourceNationKey || currentNationKey,
                  });
                } else {
                  console.warn(
                    `Skipping invalid ingredient from CANON_DATA: ${item ? item.name : 'Unknown'}`
                  );
                }
              });
            }
          });
        });

        // Ensure generic fallback ingredients are always available
        const ensureGenericIfNeeded = (
          typeNeeded,
          rolePrefs,
          canBase,
          isRaw,
          nameOverride = null,
          tags = [],
          flavorNotes = ['neutral']
        ) => {
          const genericSourceName = 'Generic Supply';
          const genericSourceKey = 'generic';
          // Check if any ingredient of this type already exists
          if (
            !availableIngredientObjects.some(
              (ing) =>
                getIngredientType(ing).includes(typeNeeded) ||
                (nameOverride && getIngredientName(ing) === nameOverride)
            )
          ) {
            // Use .includes for types
            const genericSourcePool = CANON_DATA.airNomads.ingredients; // Use Air Nomads for base generics
            const exampleItem = Object.values(genericSourcePool)
              .flat()
              .find(
                (ing) =>
                  typeof ing === 'object' &&
                  ing.name &&
                  getIngredientType(ing).includes(typeNeeded) &&
                  (canBase === null || getCanBeBase(ing) === canBase) // Use .includes for types
              );
            let ingName =
              nameOverride ||
              (exampleItem
                ? `Generic ${getIngredientName(exampleItem, true)}`
                : `Generic ${typeNeeded.charAt(0).toUpperCase() + typeNeeded.slice(1)}`);
            const allTags = ['generic', typeNeeded, ...tags];
            if (exampleItem)
              allTags.push(
                ...getIngredientTags(exampleItem).filter(
                  (t) =>
                    !t.includes('air_nomad') &&
                    !t.includes('generic') &&
                    !t.includes(typeNeeded)
                )
              ); // Use .includes for types

            const newGeneric = {
              name: ingName,
              type: typeNeeded,
              rolePreference: rolePrefs,
              canBeBase: !!canBase,
              weight: 'medium',
              rawCompatible: !!isRaw,
              tags: [...new Set(allTags)],
              rarity: 'common',
              flavorNotes: flavorNotes,
              loreHints: [],
              sourceNation: genericSourceName,
              sourceNationKey: genericSourceKey,
            };
            if (
              exampleItem &&
              exampleItem.flavorNotes &&
              exampleItem.flavorNotes.length > 0 &&
              flavorNotes.includes('neutral')
            ) {
              newGeneric.flavorNotes = getIngredientFlavorNotes(exampleItem);
            }
            availableIngredientObjects.push(newGeneric);
          }
        };

        // Add essential generic ingredients if not already present
        ensureGenericIfNeeded(
          'grain',
          ['base'],
          true,
          false,
          'Simple Rice',
          [
            'sweet_compatible',
            'light_grain',
            'can_be_sweetened_neutral',
            'solid_food_component',
            'savory_compatible',
          ],
          ['neutral', 'fluffy']
        );
        ensureGenericIfNeeded(
          'vegetable',
          ['primary', 'base'],
          true,
          false,
          'Common Root Vegetable',
          [
            'starchy_vegetable_strong',
            'solid_food_component',
            'earthy',
            'mild',
          ],
          ['earthy', 'mild', 'starchy']
        );
        ensureGenericIfNeeded(
          'fruit',
          ['primary', 'garnish', 'base'],
          true,
          true,
          'Seasonal Fruit',
          [
            'sweet_compatible',
            'dessert_fruit',
            'nectar_source',
            'dessert_primary_ok',
            'dessert_base_ok',
            'beverage_component',
            'fruit_puree_candidate',
          ],
          ['sweet', 'juicy', 'fresh']
        );
        ensureGenericIfNeeded(
          'spice',
          ['seasoning'],
          false,
          true,
          'Cracked Peppercorns',
          ['pungent_spice', 'savory_compatible'],
          ['sharp_heat', 'woody', 'aromatic']
        );
        ensureGenericIfNeeded(
          'salt',
          ['seasoning'],
          false,
          true,
          'Sea Salt Crystals',
          ['sweet_compatible_seasoning', 'savory_compatible'],
          ['clean_saltiness', 'briny_notes']
        );
        ensureGenericIfNeeded(
          'oil',
          ['binder'],
          false,
          false,
          'Neutral Cooking Oil',
          ['sweet_compatible_binder', 'savory_compatible_binder'],
          ['neutral_flavor']
        );
        ensureGenericIfNeeded(
          'herb',
          ['seasoning', 'accent'],
          false,
          true,
          'Wild Herb Blend',
          [
            'aromatic',
            'infusible_herb',
            'beverage_component',
            'savory_compatible',
          ],
          ['mixed_herbal', 'fresh_green']
        );
        ensureGenericIfNeeded(
          'liquid',
          ['base', 'liquid'],
          true,
          true,
          'Clear Broth Base',
          [
            'generic_liquid',
            'liquid_base',
            'liquid_ish',
            'beverage_component',
            'broth_potential',
            'savory_compatible',
            'soup_compatible',
            'stew_compatible',
            'neutral_base',
          ],
          ['neutral_base']
        );

        // Apply dish type specific filters
        let filteredIngredients = availableIngredientObjects.filter((ing) => {
          // Use the centralized validation function for the initial filtering
          return isValidIngredientForDishType(
            ing,
            'any',
            dishType,
            finalNationKeys
          );
        });

        // Special handling for sweet dishes if no sweet ingredients remain after filtering
        if (
          ['Dessert', 'Nectar', 'Beverage'].includes(dishType) &&
          !filteredIngredients.some((ing) => isSweetIngredient(ing))
        ) {
          let sweetFallback =
            availableIngredientObjects.find(
              (f) => f && f.name === 'Seasonal Fruit' && isSweetIngredient(f)
            ) ||
            availableIngredientObjects.find(
              (f) => f && f.type.includes('fruit') && isSweetIngredient(f)
            ); // Use .includes for types
          if (
            sweetFallback &&
            !filteredIngredients.some(
              (f) => getIngredientName(f) === getIngredientName(sweetFallback)
            )
          ) {
            filteredIngredients.push({
              ...sweetFallback,
              sourceNation: 'Forced Sweet Fallback',
              sourceNationKey: 'forced_sweet',
            });
          } else if (!sweetFallback) {
            // If even Seasonal Fruit isn't available for some reason, add a generic sweet placeholder
            console.warn(
              `No sweet ingredients found for ${dishType}, adding generic sweet placeholder.`
            );
            filteredIngredients.push({
              name: 'Sweet Essence',
              type: 'fruit',
              rolePreference: ['primary', 'base'],
              canBeBase: true,
              tags: [
                'generic',
                'sweet_compatible',
                'dessert_fruit',
                'placeholder',
                'liquid_ish',
              ],
              rarity: 'common',
              flavorNotes: ['sweet'],
              sourceNation: 'Absolute Dessert Fallback',
              sourceNationKey: 'dessert_fallback',
            });
          }
        }
        // Special handling for Street Food if theme isn't Street (to ensure less delicate ingredients)
        else if (dishType === 'Street Food' && themeVal !== 'Street') {
          filteredIngredients = filteredIngredients.filter((ing) => {
            const ingTags = getIngredientTags(ing);
            return (
              !ingTags.includes('delicate') &&
              !ingTags.includes('fine_dining') &&
              !ingTags.includes('fragile_garnish') &&
              !ingTags.includes('ceremonial')
            );
          });
        }

        // Remove duplicates based on name (if any slipped through or were added as generics)
        filteredIngredients = [
          ...new Map(
            filteredIngredients.map((item) => [getIngredientName(item), item])
          ).values(),
        ];

        if (filteredIngredients.length === 0) {
          console.error(
            `CRITICAL: No ingredients left for ${dishType}. This will likely cause errors. Adding emergency placeholder.`
          );
          // Emergency fallback for critical cases (e.g., all ingredients filtered out)
          filteredIngredients.push({
            name: 'Mystic Essence',
            type: 'liquid',
            rolePreference: ['base', 'liquid'],
            canBeBase: true,
            tags: [
              'generic',
              'liquid_ish',
              'beverage_component',
              'liquid_base',
              'sweet_compatible',
              'savory_compatible',
            ],
            rarity: 'common',
            flavorNotes: ['pure', 'neutral_base'],
            sourceNation: 'Emergency Fallback',
            sourceNationKey: 'emergency',
          });
        }

        return {
          availableIngredientObjects: filteredIngredients,
          selectedNationsData,
          finalNationKeys,
          nationDisplayNames,
        };
      }

      /**
       * Selects an ingredient for a specific role from a list of candidates,
       * prioritizing unrepresented nations and avoiding duplicates.
       * @param {string} role The role to fill.
       * @param {object[]} candidates The list of ingredient candidates.
       * @param {Set<string>} currentDishIngredientsTracker Set of ingredient names already in the dish.
       * @param {string[]} nationKeys All selected nation keys.
       * @param {object} nationContribution Object tracking how many ingredients each nation has contributed.
       * @returns {object|undefined} The selected ingredient, or undefined if none found.
       */
      function selectIngredientByRoleFromCandidates(
        role,
        candidates,
        currentDishIngredientsTracker,
        nationKeys,
        nationContribution
      ) {
        let itemToAdd = undefined;

        // Filter out ingredients already in the dish (unless they are rare/epic)
        let filteredCandidates = candidates.filter((ing) => {
          const ingName = getIngredientName(ing);
          if (currentDishIngredientsTracker.has(ingName)) {
            const rarity = getIngredientRarity(ing);
            // Allow very rare/epic ingredients to potentially be used multiple times if logic needs it,
            // but generally prefer unique common/uncommon ones.
            if (
              rarity === 'common' ||
              rarity === 'uncommon' ||
              rarity === 'rare'
            ) {
              return false;
            }
          }
          return true;
        });

        if (filteredCandidates.length === 0) {
          // No unique candidates found, return undefined to signal fallback needed
          return undefined;
        }

        // Prioritize nations that haven't contributed yet
        const unrepresentedNations = nationKeys.filter(
          (nk) => nationContribution[nk] === 0
        );
        if (nationKeys.length > 1 && unrepresentedNations.length > 0) {
          const targetNationKey = getRandomElement(unrepresentedNations);
          let nationSpecificCandidates = filteredCandidates.filter(
            (c) => c.sourceNationKey === targetNationKey
          );
          if (nationSpecificCandidates.length > 0) {
            itemToAdd = getRandomElement(nationSpecificCandidates);
          }
        }

        // If no nation-specific candidate was found, or no specific nation to prioritize,
        // select from the general filtered candidates, preferring the primary nation if available.
        if (!itemToAdd) {
          let primaryNationKey =
            nationKeys && nationKeys.length > 0 ? nationKeys[0] : null;
          let primaryNationCandidatesList = filteredCandidates.filter(
            (c) => c.sourceNationKey === primaryNationKey
          );
          itemToAdd = getRandomElement(
            primaryNationCandidatesList.length > 0
              ? primaryNationCandidatesList
              : filteredCandidates
          );
        }

        return itemToAdd;
      }

      function generateAndDisplayDish(
        dishType,
        nationNamesInput,
        baseFormat,
        themeVal
      ) {
        let generatedName = 'Generated Dish Name';
        let generatedConcept = 'A delightful dish from the world of Avatar.';
        let allSelectedIngredients = [];
        let generatedNotes =
          'Prepared with elemental mastery and a dash of spirit.';
        let generatedLore = '';
        let usedDishDescriptors = new Set();
        let currentDishIngredientsTracker = new Set(); // Tracks names of ingredients already selected for the dish

        // Declare notes-related variables at the top scope
        let notesParts = [];
        let swFlavorJourney = ''; // This is now a function-scoped variable

        // Determine nation keys and display names
        const {
          availableIngredientObjects,
          selectedNationsData,
          finalNationKeys,
          nationDisplayNames,
        } = collectAndFilterAvailableIngredients(
          nationNamesInput,
          dishType,
          themeVal
        );

        const MINIMUM_REQUIRED_ROLES_COUNT = {
          base: 1,
          primary: 1,
          seasoning: 1,
          accent: 1,
          garnish:
            dishType === 'Beverage' ||
            dishType === 'Sauce/Condiment' ||
            dishType === 'Nectar'
              ? 0
              : 1,
        };
        const rolesToFillCounts = { ...MINIMUM_REQUIRED_ROLES_COUNT };

        // Adjust role counts based on dish type
        if (
          [
            'Beverage',
            'Nectar',
            baseFormat === 'Nectar' || dishType === 'Sauce/Condiment',
          ].includes(dishType)
        ) {
          rolesToFillCounts.primary = getRandomInt(0, 1); // Optional primary for drinks/sauces
          rolesToFillCounts.accent = getRandomInt(1, 2);
          rolesToFillCounts.seasoning = getRandomInt(0, 1);
          rolesToFillCounts.garnish = getRandomInt(0, 1);
        } else if (dishType === 'Salad' || dishType === 'Side Dish') {
          rolesToFillCounts.garnish = getRandomInt(0, 1);
        } else if (dishType === 'Dessert') {
          rolesToFillCounts.primary = 1;
          rolesToFillCounts.accent = getRandomInt(1, 2);
          rolesToFillCounts.seasoning = getRandomInt(0, 1);
          rolesToFillCounts.garnish =
            rolesToFillCounts.garnish > 0 ? 1 : Math.random() > 0.2 ? 1 : 0;
        } // Street Food garnish is already handled by default min/max.

        let nationContribution = {};
        finalNationKeys.forEach((key) => (nationContribution[key] = 0));

        // Main ingredient selection loop
        for (const role in rolesToFillCounts) {
          let needed = rolesToFillCounts[role];
          while (needed > 0) {
            // Filter candidates based on role suitability and dish type validity
            let candidates = availableIngredientObjects.filter((ing) => {
              // Extract properties for each ingredient *inside* the filter callback
              const ingTags = getIngredientTags(ing);
              const ingType = getIngredientType(ing);
              const canBeBase = getCanBeBase(ing);
              const ingWeight = getIngredientWeight(ing);
              const rolePrefs = getIngredientRolePreference(ing);

              if (
                !isValidIngredientForDishType(
                  ing,
                  role,
                  dishType,
                  finalNationKeys
                )
              )
                return false;

              // Check role preference or if it's a valid fallback for the role
              if (rolePrefs.includes(role)) return true;
              if (
                role === 'base' &&
                canBeBase &&
                (ingType.includes('grain') ||
                  ingType.includes('protein') ||
                  (ingType.includes('vegetable') && ingWeight !== 'light') ||
                  ingType.includes('fruit') ||
                  ingType.includes('dairy') ||
                  ingType.includes('product') ||
                  ingTags.includes('liquid_ish') ||
                  ingTags.includes('liquid_base'))
              )
                return true; // Use .includes for types
              if (
                role === 'primary' &&
                (canBeBase ||
                  [
                    'protein',
                    'vegetable',
                    'fruit',
                    'fungi',
                    'dairy',
                    'grain_product',
                    'seafood',
                    'fish',
                  ].some((t) => ingType.includes(t)))
              )
                return true; // Use .includes for types
              if (
                role === 'seasoning' &&
                [
                  'spice',
                  'herb',
                  'salt',
                  'vinegar',
                  'oil',
                  'sweetener',
                  'condiment',
                  'flavoring',
                  'liquid',
                ].some((t) => ingType.includes(t))
              )
                return true; // Use .includes for types
              if (
                (role === 'accent' &&
                  [
                    'condiment',
                    'herb',
                    'fruit',
                    'spice',
                    'nut',
                    'flavoring',
                    'sweetener',
                    'liquid',
                  ].some((t) => ingType.includes(t))) ||
                getIngredientFlavorNotes(ing).some((fn) =>
                  [
                    'fiery',
                    'umami',
                    'tangy',
                    'floral',
                    'spicy',
                    'ethereal',
                  ].includes(fn.split('_')[0])
                )
              )
                return true; // Use .includes for types
              if (
                role === 'garnish' &&
                (ingType.includes('herb') ||
                  ingTags.includes('petal') ||
                  ingWeight === 'light' ||
                  getIngredientRarity(ing) === 'rare' ||
                  ingType.includes('fruit') ||
                  ingType.includes('nut') ||
                  ingType.includes('fungi') ||
                  (ingType.includes('vegetable') &&
                    ingTags.includes('edible_flower_petal')))
              )
                return true; // Use .includes for types

              return false;
            });

            // Further filter for specific roles (e.g., base needs liquid for soup)
            if (role === 'base') {
              if (['Dessert', 'Nectar', 'Beverage'].includes(dishType)) {
                candidates = candidates.filter(isSweetIngredient);
              } else if (dishType === 'Soup/Stew') {
                candidates = candidates.filter((ing) =>
                  getIngredientTags(ing).some((t) =>
                    ['liquid_base', 'liquid_ish', 'broth_potential'].includes(t)
                  )
                );
              } else {
                // Savory non-soup/stew, prefer typical bases
                const preferredSavoryBases = candidates.filter(
                  (ing) =>
                    getIngredientType(ing).includes('vegetable') ||
                    getIngredientType(ing).includes('grain') ||
                    getIngredientType(ing).includes('protein')
                ); // Use .includes for types
                if (preferredSavoryBases.length > 0)
                  candidates = preferredSavoryBases;
              }
            }
            if (
              role === 'primary' &&
              ['Dessert', 'Nectar', 'Beverage'].includes(dishType)
            ) {
              candidates = candidates.filter(isSweetIngredient);
            }

            // Select an ingredient using the helper
            let itemToAdd = selectIngredientByRoleFromCandidates(
              role,
              candidates,
              currentDishIngredientsTracker,
              finalNationKeys,
              nationContribution
            );

            // Fallback if no suitable item was found by preference
            if (!itemToAdd) {
              // Broader fallback logic, prioritizing common items of suitable type
              let fallbackPool = availableIngredientObjects.filter(
                (ing) =>
                  !currentDishIngredientsTracker.has(getIngredientName(ing)) &&
                  isValidIngredientForDishType(
                    ing,
                    role,
                    dishType,
                    finalNationKeys
                  )
              );
              // Filter by role type suitability (e.g., only liquid for soup base)
              if (role === 'base')
                fallbackPool = fallbackPool.filter(getCanBeBase);
              else if (role === 'primary')
                fallbackPool = fallbackPool.filter(
                  (ing) =>
                    !['spice', 'salt', 'oil', 'vinegar'].some((t) =>
                      getIngredientType(ing).includes(t)
                    )
                ); // Use .includes for types

              itemToAdd = getRandomElement(fallbackPool);
            }

            if (itemToAdd && typeof itemToAdd === 'object') {
              itemToAdd.role = role;
              allSelectedIngredients.push(itemToAdd);
              currentDishIngredientsTracker.add(getIngredientName(itemToAdd));
              if (finalNationKeys.includes(itemToAdd.sourceNationKey)) {
                nationContribution[itemToAdd.sourceNationKey]++;
              }
            } else {
              console.error(
                `COULD NOT FILL ROLE: ${role} even with broad fallback. Adding placeholder.`
              );
              const placeholderIng = {
                name: `Essential ${role.charAt(0).toUpperCase() + role.slice(1)} Element`,
                role: role,
                type: 'unknown',
                flavorNotes: ['missing'],
                tags: ['placeholder'],
                sourceNation: 'Placeholder System',
                sourceNationKey: 'placeholder',
              };
              allSelectedIngredients.push(placeholderIng);
            }
            needed--;
          }
        }

        // Ensure that a dessert/nectar/beverage has sweet primary/base if missing due to edge cases
        if (['Dessert', 'Nectar', 'Beverage'].includes(dishType)) {
          if (
            !allSelectedIngredients.some(
              (i) => i && i.role === 'base' && isSweetIngredient(i)
            )
          ) {
            let dessertBaseFallback = getRandomElement(
              availableIngredientObjects.filter(
                (i) =>
                  i &&
                  getCanBeBase(i) &&
                  isSweetIngredient(i) &&
                  isValidIngredientForDishType(
                    i,
                    'base',
                    dishType,
                    finalNationKeys
                  ) &&
                  !allSelectedIngredients.some(
                    (asi) =>
                      asi && getIngredientName(asi) === getIngredientName(i)
                  )
              )
            );
            if (!dessertBaseFallback) {
              const sf = availableIngredientObjects.find(
                (i) => i && i.name === 'Seasonal Fruit'
              );
              if (
                sf &&
                isSweetIngredient(sf) &&
                isValidIngredientForDishType(
                  sf,
                  'base',
                  dishType,
                  finalNationKeys
                )
              )
                dessertBaseFallback = { ...sf };
              else
                dessertBaseFallback = {
                  name: 'Sweet Foundation',
                  role: 'base',
                  type: 'fruit',
                  flavorNotes: ['sweet'],
                  tags: [
                    'generic',
                    'sweet_compatible',
                    'dessert_fruit',
                    'placeholder',
                    'liquid_ish',
                  ],
                  sourceNation: 'Dessert Fallback',
                  sourceNationKey: 'dessert_fallback',
                };
            }
            if (
              dessertBaseFallback &&
              !allSelectedIngredients.some(
                (i) =>
                  i &&
                  getIngredientName(i) ===
                    getIngredientName(dessertBaseFallback) &&
                  i.role === 'base'
              )
            ) {
              dessertBaseFallback.role = 'base';
              allSelectedIngredients.push(dessertBaseFallback);
            }
          }
          if (
            !allSelectedIngredients.some(
              (i) => i && i.role === 'primary' && isSweetIngredient(i)
            )
          ) {
            let dessertPrimFallback = getRandomElement(
              availableIngredientObjects.filter(
                (i) =>
                  i &&
                  isSweetIngredient(i) &&
                  isValidIngredientForDishType(
                    i,
                    'primary',
                    dishType,
                    finalNationKeys
                  ) &&
                  !allSelectedIngredients.some(
                    (asi) =>
                      asi && getIngredientName(asi) === getIngredientName(i)
                  )
              )
            );
            if (!dessertPrimFallback) {
              const sf = availableIngredientObjects.find(
                (i) => i && i.name === 'Seasonal Fruit'
              );
              if (
                sf &&
                isSweetIngredient(sf) &&
                isValidIngredientForDishType(
                  sf,
                  'primary',
                  dishType,
                  finalNationKeys
                )
              )
                dessertPrimFallback = { ...sf };
              else
                dessertPrimFallback = {
                  name: 'Sweet Core',
                  role: 'primary',
                  type: 'fruit',
                  flavorNotes: ['sweet'],
                  tags: [
                    'generic',
                    'sweet_compatible',
                    'dessert_fruit',
                    'placeholder',
                  ],
                  sourceNation: 'Dessert Fallback',
                  sourceNationKey: 'dessert_fallback',
                };
            }
            if (
              dessertPrimFallback &&
              !allSelectedIngredients.some(
                (i) =>
                  i &&
                  getIngredientName(i) ===
                    getIngredientName(dessertPrimFallback) &&
                  i.role === 'primary'
              )
            ) {
              dessertPrimFallback.role = 'primary';
              allSelectedIngredients.push(dessertPrimFallback);
            }
          }
        } else {
          if (
            !allSelectedIngredients.some((i) => i && i.role === 'base') &&
            rolesToFillCounts.base > 0
          ) {
            let baseFallback =
              getRandomElement(
                availableIngredientObjects.filter(
                  (i) =>
                    i &&
                    getCanBeBase(i) &&
                    isValidIngredientForDishType(
                      i,
                      'base',
                      dishType,
                      finalNationKeys
                    ) &&
                    !allSelectedIngredients.some(
                      (asi) =>
                        asi && getIngredientName(asi) === getIngredientName(i)
                    )
                )
              ) ||
              getRandomElement(
                availableIngredientObjects.filter(
                  (i) =>
                    i &&
                    getIngredientType(i).includes('grain') &&
                    isValidIngredientForDishType(
                      i,
                      'base',
                      dishType,
                      finalNationKeys
                    ) &&
                    !allSelectedIngredients.some(
                      (asi) =>
                        asi && getIngredientName(asi) === getIngredientName(i)
                    )
                )
              ); // Use .includes for types
            if (baseFallback) {
              baseFallback.role = 'base';
              allSelectedIngredients.push(baseFallback);
            } else {
              allSelectedIngredients.push({
                name: 'Mysterious Foundation',
                role: 'base',
                type: 'other',
                flavorNotes: ['neutral_base'],
                tags: ['generic', 'placeholder'],
                sourceNation: 'Absolute Fallback',
                sourceNationKey: 'fallback',
              });
            }
          }
          if (
            !allSelectedIngredients.some((i) => i && i.role === 'primary') &&
            rolesToFillCounts.primary > 0
          ) {
            let primaryFallback = getRandomElement(
              availableIngredientObjects.filter(
                (i) =>
                  i &&
                  !['spice', 'salt', 'oil', 'vinegar'].some((t) =>
                    getIngredientType(i).includes(t)
                  ) &&
                  isValidIngredientForDishType(
                    i,
                    'primary',
                    dishType,
                    finalNationKeys
                  ) &&
                  !allSelectedIngredients.some(
                    (asi) =>
                      asi && getIngredientName(asi) === getIngredientName(i)
                  )
              )
            ); // Use .includes for types
            if (primaryFallback) {
              primaryFallback.role = 'primary';
              allSelectedIngredients.push(primaryFallback);
            } else {
              allSelectedIngredients.push({
                name: 'Core Essence',
                role: 'primary',
                type: 'other',
                flavorNotes: ['distinctive'],
                tags: ['generic', 'placeholder'],
                sourceNation: 'Absolute Fallback',
                sourceNationKey: 'fallback',
              });
            }
          }
        }

        // Final cleanup of ingredients: Ensure actual representation of nations in dish display
        let finalNationDisplayNames = [...nationDisplayNames];
        if (finalNationKeys.length > 1) {
          // Only adjust if multiple nations were initially selected
          let representedNationKeys = new Set();
          allSelectedIngredients.forEach((ing) => {
            if (
              ing.sourceNationKey &&
              finalNationKeys.includes(ing.sourceNationKey)
            ) {
              representedNationKeys.add(ing.sourceNationKey);
            }
          });
          let actuallyRepresentedDisplayNames = [];
          finalNationKeys.forEach((nk, idx) => {
            if (representedNationKeys.has(nk)) {
              actuallyRepresentedDisplayNames.push(nationDisplayNames[idx]);
            }
          });
          // If some nations were selected but none of their ingredients made it into the dish,
          // simplify the display name list to just the ones that are actually represented.
          // Or if no selected nations are represented but initial selection was made, use the first one.
          if (
            actuallyRepresentedDisplayNames.length > 0 &&
            actuallyRepresentedDisplayNames.length < nationDisplayNames.length
          ) {
            finalNationDisplayNames = actuallyRepresentedDisplayNames;
          } else if (
            actuallyRepresentedDisplayNames.length === 0 &&
            nationDisplayNames.length > 0
          ) {
            finalNationDisplayNames = [nationDisplayNames[0]]; // Fallback to first selected nation's name if no actual ingredients are from chosen nations
          }
          // Otherwise, finalNationDisplayNames already holds the correct list
        }

        generatedName = generateStructuredName(
          selectedNationsData,
          allSelectedIngredients,
          dishType,
          baseFormat,
          CANON_DATA.themes[themeVal],
          finalNationKeys,
          finalNationDisplayNames
        );
        if (
          generatedName.includes('Glimmering Moon_Touched Fruit Pulp Nectar')
        ) {
          const mainSubstantiveForName = allSelectedIngredients.find(
            (i) => i.role === 'primary' || i.role === 'base'
          ) ||
            allSelectedIngredients.find(
              (i) => !getIngredientTags(i).includes('placeholder')
            ) || { name: 'Mystery Essence' };
          let defaultNameStart = `${CANON_DATA.themes[themeVal] && Array.isArray(CANON_DATA.themes[themeVal].adj) && CANON_DATA.themes[themeVal].adj.length > 0 ? getRandomElement(CANON_DATA.themes[themeVal].adj) : finalNationDisplayNames.length > 0 && CANON_DATA[finalNationKeys[0]] && Array.isArray(CANON_DATA[finalNationKeys[0]].adjectives) && CANON_DATA[finalNationKeys[0]].adjectives.length > 0 ? getRandomElement(CANON_DATA[finalNationKeys[0]].adjectives) : finalNationDisplayNames.length > 0 ? finalNationDisplayNames[0].split(' ')[0] : getRandomElement(CANON_DATA.genericAdjectives)}`;
          generatedName = `${defaultNameStart || 'Ancient'} ${getIngredientName(mainSubstantiveForName, true).split(' (')[0]} ${baseFormat || dishType}`;
          generatedName = generatedName
            .replace(
              /undefined|\{undefined\}|Generic /gi,
              getRandomElement(['Ancient', 'Lost', 'Forgotten', 'Simple', '']) +
                ' '
            )
            .replace(/\s+/g, ' ')
            .trim();
        }
        // Re-evaluate name for redundant phrases after full generation
        generatedName = cleanRedundantPhrases(generatedName);

        let conceptParts = [];
        const firstNationDisplayNameForConcept =
          finalNationDisplayNames && finalNationDisplayNames.length > 0
            ? finalNationDisplayNames[0]
            : 'an unknown land';

        if (
          generatedName.includes('Glimmering Moon_Touched Fruit Pulp Nectar')
        ) {
          // Specific lore for this rare dish
          conceptParts.push(
            'A rare Spirit World delicacy, whispered to be born from forgotten prayers and ripened memory, found only by those who seek solace or remembrance in the echoing silence of a forgotten shrine. Its preparation is akin to dream_weaving, coaxing flavors from pure thought and memory.'
          );
        } else {
          let actualNationsString = finalNationDisplayNames.join(' and ');
          if (
            finalNationDisplayNames.length === 0 &&
            nationDisplayNames.length > 0
          ) {
            actualNationsString = nationDisplayNames.join(
              ' or perhaps inspired by the general spirit of '
            );
          } else if (finalNationDisplayNames.length === 0) {
            actualNationsString = 'the elemental world';
          }
          if (finalNationDisplayNames.length === 1)
            actualNationsString = finalNationDisplayNames[0];

          let dishCategory = dishType.toLowerCase();
          if (
            dishType === 'Street Food' &&
            (baseFormat === 'Wrap/Roll' || baseFormat === 'Skewered')
          ) {
            dishCategory = `${baseFormat.toLowerCase()} street food`;
          } else if (
            dishType === 'Street Food' &&
            baseFormat === 'Patties/Fritters'
          ) {
            dishCategory = 'street food fritters';
          } else if (dishType === 'Street Food') {
            dishCategory = 'street food';
          }
          if (
            baseFormat &&
            dishType.toLowerCase() !== baseFormat.toLowerCase()
          ) {
            dishCategory = `${baseFormat.toLowerCase()} ${dishType.toLowerCase()}`;
          }

          conceptParts.push(
            `A ${dishCategory} creation that embodies the distinctive spirit of ${actualNationsString}.`
          );

          const currentThemeData =
            themeVal && CANON_DATA.themes[themeVal]
              ? { ...CANON_DATA.themes[themeVal], themeKey: themeVal }
              : null;
          if (currentThemeData && currentThemeData.conceptMod) {
            conceptParts.push(currentThemeData.conceptMod);
          } else if (themeVal) {
            const themeDescs = {
              Spiritual:
                'It is infused with a subtle spiritual energy, transcending the mundane.',
              Royal:
                'It is fit for the highest royalty, showcasing opulent ingredients and meticulous preparation.',
              Rustic:
                'It is unpretentious, hearty, and wholesome, celebrating the natural flavors of locally sourced ingredients.',
              Innovative:
                'It is a modern, perhaps even experimental dish utilizing new techniques or unusual ingredient combinations.',
              Street:
                "It is a bustling market favorite, designed for quick consumption and bold, memorable flavors. It embodies the vibrant energy and diverse tastes of the city's thoroughfares.",
              Traveler:
                'It is a robust and versatile meal, ideal for sustenance during long journeys across varied landscapes.',
            };
            if (themeDescs[themeVal]) conceptParts.push(themeDescs[themeVal]);
          }

          if (finalNationDisplayNames.length > 1) {
            const key1Index = nationDisplayNames.indexOf(
              finalNationDisplayNames[0]
            );
            const key2Index =
              finalNationDisplayNames.length > 1
                ? nationDisplayNames.indexOf(finalNationDisplayNames[1])
                : -1;
            const synergyKey1 =
              key1Index !== -1 ? finalNationKeys[key1Index] : null;
            const synergyKey2 =
              key2Index !== -1 ? finalNationKeys[key2Index] : null;

            if (
              synergyKey1 &&
              synergyKey2 &&
              FUSION_SYNERGY[finalNationDisplayNames[0]] &&
              FUSION_SYNERGY[finalNationDisplayNames[0]][
                finalNationDisplayNames[1]
              ]
            ) {
              conceptParts.push(
                FUSION_SYNERGY[finalNationDisplayNames[0]][
                  finalNationDisplayNames[1]
                ]
              );
            } else if (finalNationDisplayNames.length > 1) {
              conceptParts.push(
                `This dish represents a fascinating fusion, blending the culinary philosophies of ${finalNationDisplayNames[0]} and ${finalNationDisplayNames[1]}.`
              );
            }
          }

          const keyFlavorIngredientsForConcept = allSelectedIngredients
            .filter(
              (ing) =>
                (ing.role === 'primary' ||
                  ing.role === 'accent' ||
                  (ing.role === 'seasoning' &&
                    !getIngredientType(ing).includes('salt') &&
                    !getIngredientName(ing).toLowerCase().includes('oil'))) &&
                !getIngredientTags(ing).includes('placeholder')
            )
            .slice(0, 3); // Use .includes for types
          if (keyFlavorIngredientsForConcept.length > 0) {
            conceptParts.push(
              `Its soul is defined by the interplay of ${keyFlavorIngredientsForConcept.map((ing) => describeFlavorOfItem(ing, 'concept', dishType, usedDishDescriptors)).join(', ')}${allSelectedIngredients.filter((i) => !getIngredientTags(i).includes('placeholder')).length > 3 ? ', and other subtle, complementary essences that form a rich sensory experience.' : '.'}`
            );
          }
          conceptParts.push(
            getRandomElement([
              'A true taste of the Avatar world!',
              'An unforgettable culinary experience.',
              'A dish that tells its own story.',
              'A symphony for the senses.',
            ])
          );
        }
        generatedConcept = conceptParts.join(' ');

        let relevantCookingStyles = [];
        finalNationKeys.forEach((nk) => {
          if (CANON_DATA[nk] && CANON_DATA[nk].cookingStyles) {
            relevantCookingStyles.push(...CANON_DATA[nk].cookingStyles);
          }
        });
        relevantCookingStyles = [
          ...new Map(relevantCookingStyles.map((s) => [s.name, s])).values(),
        ]; // Deduplicate

        let suitableStyles = relevantCookingStyles.filter((style) => {
          if (!style || !style.name || !Array.isArray(style.tags)) return false;
          if (CANON_DATA.cookingMethodsByDishType[dishType]) {
            if (
              !CANON_DATA.cookingMethodsByDishType[dishType].some((dtc) =>
                style.tags.includes(dtc)
              )
            ) {
              return false;
            }
          }

          const clashesWithIngredients = allSelectedIngredients.some((ing) => {
            const ingTags = getIngredientTags(ing);
            if (
              ingTags.includes('no_cook') &&
              !style.tags.includes('no_cook') &&
              !style.tags.includes('cold_prep') &&
              !style.tags.includes('infusion') &&
              !style.tags.includes('beverageFriendly') &&
              !style.tags.includes('saladFriendly')
            ) {
              return true;
            }
            if (
              ingTags.includes('cold_prep') &&
              !style.tags.includes('cold_prep') &&
              (style.name.includes('baking') ||
                style.name.includes('roasting') ||
                style.name.includes('frying') ||
                style.name.includes('searing') ||
                style.name.includes('grilling') ||
                style.name.includes('simmering') ||
                style.name.includes('boiling') ||
                style.name.includes('steaming'))
            ) {
              return true;
            }
            if (
              getIngredientType(ing).includes('liquid') &&
              style.tags.includes('drying') &&
              !(
                getIngredientName(ing).toLowerCase().includes('nectar') ||
                getIngredientName(ing).toLowerCase().includes('fruit pulp')
              )
            ) {
              // Use .includes for types
              return true;
            }
            return false;
          });
          if (clashesWithIngredients) {
            return false;
          }
          return true;
        });

        const hasGlazeCompatible = allSelectedIngredients.some((i) =>
          getIngredientTags(i).includes('glaze_compatible')
        );
        if (
          hasGlazeCompatible &&
          suitableStyles.some((s) => s.tags.includes('glazing'))
        ) {
          suitableStyles.sort((a, b) => {
            if (a.tags.includes('glazing') && !b.tags.includes('glazing'))
              return -1;
            if (!a.tags.includes('glazing') && b.tags.includes('glazing'))
              return 1;
            return 0;
          });
        }

        let mainCookStyleForNotesObj;
        if (suitableStyles.length > 0) {
          mainCookStyleForNotesObj = getRandomElement(suitableStyles);
        } else {
          mainCookStyleForNotesObj = getRandomElement([
            { name: 'traditional preparation', tags: ['fallback_style'] },
            { name: 'careful assembly', tags: ['fallback_style'] },
            { name: 'mindful crafting', tags: ['fallback_style'] },
            { name: 'gentle infusing', tags: ['fallback_style'] },
            { name: 'elemental crafting', tags: ['fallback_style'] },
          ]);
        }
        let mainCookStyleForNotes = mainCookStyleForNotesObj.name;

        if (
          generatedName.includes('Glimmering Moon_Touched Fruit Pulp Nectar')
        ) {
          const fruitPulp = allSelectedIngredients.find(
            (i) =>
              getIngredientName(i, true).includes('Fruit Pulp') ||
              getIngredientName(i, true).includes('Seasonal Fruit')
          ) || { name: 'Moon_touched Mango Pulp' };
          const essence = allSelectedIngredients.find((i) =>
            getIngredientName(i, true).includes('Essence')
          ) || { name: 'Spirit Bloom Essence' };
          const peppercorns = allSelectedIngredients.find((i) =>
            getIngredientName(i, true).includes('Peppercorns')
          ) || { name: 'Ghost Peppercorns' };
          const salt = allSelectedIngredients.find((i) =>
            getIngredientName(i, true).includes('Salt Crystals')
          ) || { name: 'Silver Salt Crystals' };
          mainCookStyleForNotes = 'ethereal coaxing';
          generatedNotes = `This ethereal creation infuses ${getIngredientName(fruitPulp, true)} with ${getIngredientName(essence, true)}, often involving ${mainCookStyleForNotes} the flavors from memory and moonlight, sometimes over a root_infused steam bath. Cracked ${getIngredientName(peppercorns, true)} spark a fleeting warmth, while a whisper of ${getIngredientName(salt, true)} awakens clarity in every drop. Served in a levitating glass blossom, petals closed, which unfold as the nectar cools‚Äîrevealing the fruit's fading reflection.`;
        } else if (
          finalNationDisplayNames.includes('Spirit World') &&
          finalNationDisplayNames.length === 1 &&
          (dishType === 'Dessert' ||
            dishType === 'Beverage' ||
            dishType === 'Nectar')
        ) {
          // All notes pushed to notesParts directly
          notesParts.push(
            `This ethereal creation is less 'made' and more '${mainCookStyleForNotes}' from the very fabric of the Spirit World.`
          );
          const baseIng = allSelectedIngredients.find(
            (i) =>
              i &&
              i.role === 'base' &&
              !getIngredientTags(i).includes('placeholder')
          );
          const primaryIng = allSelectedIngredients.find(
            (i) =>
              i &&
              i.role === 'primary' &&
              !getIngredientTags(i).includes('placeholder')
          );
          const accentIngs = allSelectedIngredients.filter(
            (i) =>
              i &&
              i.role === 'accent' &&
              !getIngredientTags(i).includes('placeholder')
          );

          if (primaryIng) {
            notesParts.push(
              `At its heart is the luminous ${getIngredientName(primaryIng, true)}, perhaps gathered from ${getRandomElement(['moon_drenched groves', 'singing crystal caves', 'gardens where memories bloom'])}.`
            );
          } else if (baseIng) {
            notesParts.push(
              `Its foundation is ${getIngredientName(baseIng, true)}, an ingredient that seems to hum with a gentle, otherworldly energy.`
            );
          }

          if (accentIngs.length > 0) {
            const accentDesc = accentIngs
              .map((ing) => {
                let desc = getIngredientName(ing, true);
                if (desc.includes('Essence'))
                  return `a few drops of ${desc}, carrying whispers of forgotten starlight`;
                if (desc.includes('Fungi'))
                  return `shavings of ${desc}, glowing with soft, pulsing light`;
                return `a touch of ${desc}, resonating with ${getRandomElement(['ancient joy', 'peaceful sorrow', 'playful curiosity'])}`;
              })
              .join(', and ');
            notesParts.push(`It is often enhanced with ${accentDesc}.`);
          }

          swFlavorJourney =
            'The flavor is an ever_shifting experience, tasting of starlight, forgotten dreams, and the quiet hum of the universe itself.'; // populate function-scoped var
          const journeyIngs = allSelectedIngredients.filter(
            (i) => i && !getIngredientTags(i).includes('placeholder')
          );
          if (journeyIngs.length >= 2) {
            const introIng =
              journeyIngs.find(
                (i) =>
                  i.role === 'garnish' ||
                  i.role === 'accent' ||
                  getIngredientWeight(i) === 'light' ||
                  getIngredientTags(i).includes('floral') ||
                  getIngredientTags(i).includes('fresh') ||
                  getIngredientTags(i).includes('delicate')
              ) || journeyIngs[0];
            const coreIng =
              journeyIngs.find(
                (i) => i.role === 'primary' || i.role === 'base'
              ) || (journeyIngs.length > 1 ? journeyIngs[1] : journeyIngs[0]);
            const aftertasteIng =
              journeyIngs.find(
                (i) =>
                  i.role === 'seasoning' ||
                  (i.role === 'accent' &&
                    getIngredientName(i) !== getIngredientName(introIng) &&
                    (getIngredientTags(i).includes('spicy') ||
                      getIngredientTags(i).includes('sour') ||
                      getIngredientTags(i).includes('bitter') ||
                      getIngredientTags(i).includes('cool')))
              ) ||
              (journeyIngs.length > 2
                ? journeyIngs[2]
                : journeyIngs.length > 1
                  ? journeyIngs[journeyIngs.length - 1]
                  : journeyIngs[0]);

            const distinctJourneyIngs = [
              introIng,
              coreIng,
              aftertasteIng,
            ].filter(
              (value, index, self) =>
                value &&
                typeof value === 'object' &&
                self.findIndex(
                  (v) =>
                    v &&
                    typeof v === 'object' &&
                    getIngredientName(v) === getIngredientName(value)
                ) === index
            );

            if (distinctJourneyIngs.length >= 2) {
              const firstFlavor = describeFlavorOfItem(
                distinctJourneyIngs[0],
                'journey_intro',
                dishType,
                usedDishDescriptors
              );
              const secondFlavor = describeFlavorOfItem(
                distinctJourneyIngs[1],
                'journey_core',
                dishType,
                usedDishDescriptors
              );
              if (
                distinctJourneyIngs.length >= 3 &&
                distinctJourneyIngs[2] &&
                getIngredientName(distinctJourneyIngs[2]) !==
                  getIngredientName(distinctJourneyIngs[0]) &&
                getIngredientName(distinctJourneyIngs[2]) !==
                  getIngredientName(distinctJourneyIngs[1])
              ) {
                const thirdFlavor = describeFlavorOfItem(
                  distinctJourneyIngs[2],
                  'journey_aftertaste',
                  dishType,
                  usedDishDescriptors
                );
                let journeyTemplate = getRandomElement(
                  FLAVOR_JOURNEYS.templates
                );
                swFlavorJourney = journeyTemplate
                  .replace('{intro}', firstFlavor)
                  .replace('{core}', secondFlavor)
                  .replace('{aftertaste}', thirdFlavor);
              } else {
                swFlavorJourney = `The experience centers on ${firstFlavor}, beautifully supported by ${secondFlavor}.`;
              }
            } else if (distinctJourneyIngs.length === 1) {
              swFlavorJourney = `The flavor experience highlights the ${describeFlavorOfItem(distinctJourneyIngs[0], 'template_simple_flavor_noun', dishType, usedDishDescriptors)} of ${getIngredientName(distinctJourneyIngs[0], true)}.`;
            }
          }
          notesParts.push(swFlavorJourney); // Push to notesParts
          let swPlating =
            CANON_DATA.spiritWorld &&
            Array.isArray(CANON_DATA.spiritWorld.platingNotes)
              ? getRandomElement(CANON_DATA.spiritWorld.platingNotes)
              : 'Presentation is an art form, often involving naturally glowing elements or serving vessels that seem to defy physics.';
          notesParts.push(swPlating || 'Served with ethereal grace.'); // Push to notesParts
        } else {
          // This is the general case for non-Spirit World/non-Glimmering Nectar dishes
          let prepIntro = `This dish is brought to life through ${mainCookStyleForNotes} techniques, honoring the traditions of ${finalNationDisplayNames.join(' and ')}.`;
          if (finalNationDisplayNames.length === 1)
            prepIntro = prepIntro.replace(
              'the traditions of',
              'the tradition of'
            );

          if (
            dishType === 'Soup/Stew' &&
            !allSelectedIngredients.some(
              (ing) =>
                getIngredientTags(ing).includes('liquid_base') ||
                getIngredientTags(ing).includes('liquid_ish') ||
                getIngredientTags(ing).includes('broth_potential')
            )
          ) {
            prepIntro = `While traditionally a '${dishType.toLowerCase()}', this creation takes on the character of a hearty, concentrated ${baseFormat || 'medley'} due to its robust ingredients and preparation via ${mainCookStyleForNotes}. It respectfully honors the traditions of ${finalNationDisplayNames.join(' and ')}.`;
          } else if (
            dishType === 'Beverage' &&
            !allSelectedIngredients.some(
              (ing) =>
                getIngredientTags(ing).includes('liquid_ish') ||
                getIngredientTags(ing).includes('beverage_component')
            ) &&
            !mainCookStyleForNotesObj.tags.includes('beverageFriendly')
          ) {
            prepIntro = `Though unusual for a '${dishType.toLowerCase()}', this rich concoction is created through ${mainCookStyleForNotes} techniques, reflecting the adventurous traditions of ${finalNationDisplayNames.join(' and ')}.`;
          }

          const rolesPresentOrderForNotes = [
            'base',
            'primary',
            'accent',
            'seasoning',
            'garnish',
          ];
          let roleDescriptionPartsForNotes = [];
          let lastConnector = '';

          rolesPresentOrderForNotes.forEach((role) => {
            const ingredientsInRole = allSelectedIngredients.filter(
              (ing) =>
                ing &&
                ing.role === role &&
                !getIngredientTags(ing).includes('placeholder')
            );
            if (
              ingredientsInRole.length > 0 &&
              DESCRIPTION_TEMPLATES[role] &&
              Array.isArray(DESCRIPTION_TEMPLATES[role])
            ) {
              const template = getRandomElement(DESCRIPTION_TEMPLATES[role]);
              const itemNames = ingredientsInRole
                .map((ing) => getIngredientName(ing, true))
                .join(' and ');
              const firstItem = ingredientsInRole[0];

              if (typeof template === 'string') {
                let part = interpolateTemplate(template, {
                  item_name: itemNames,
                  flavor_adjective: firstItem
                    ? describeFlavorOfItem(
                        firstItem,
                        'template_simple_flavor_adj',
                        dishType,
                        usedDishDescriptors
                      )
                    : 'unique',
                  flavor_noun_phrase: firstItem
                    ? describeFlavorOfItem(
                        firstItem,
                        'template_simple_flavor_noun',
                        dishType,
                        usedDishDescriptors
                      )
                    : 'a unique quality',
                  grounded_texture:
                    firstItem &&
                    getIngredientTags(firstItem).includes('root_veg')
                      ? 'earthy solidity'
                      : firstItem &&
                          getIngredientTags(firstItem).includes('grain')
                        ? 'hearty texture'
                        : firstItem &&
                            getIngredientTags(firstItem).includes('creamy')
                          ? 'creamy base'
                          : 'welcoming presence',
                  dish_type_appropriate_canvas: getDishTypeAppropriateBaseDesc(
                    dishType,
                    'canvas'
                  ),
                  dish_type_appropriate_start: getDishTypeAppropriateBaseDesc(
                    dishType,
                    'start'
                  ),
                  distinctive_quality:
                    firstItem && getIngredientRarity(firstItem) !== 'common'
                      ? 'rare character'
                      : firstItem &&
                          getIngredientFlavorNotes(firstItem).length > 0
                        ? getIngredientFlavorNotes(firstItem)[0].split('_')[0] +
                          ' essence'
                        : 'notable presence',
                  unique_flavor_profile: firstItem
                    ? describeFlavorOfItem(
                        firstItem,
                        'concept',
                        dishType,
                        usedDishDescriptors
                      )
                        .replace(
                          `from ${getIngredientName(firstItem, true)}`,
                          ''
                        )
                        .trim()
                    : 'its special taste',
                  piquant_or_aromatic_quality:
                    firstItem &&
                    (getIngredientType(firstItem).includes('spice') ||
                      getIngredientTags(firstItem).includes('aromatic'))
                      ? getIngredientTags(firstItem).includes('aromatic')
                        ? 'aromatic lift'
                        : 'piquant kick'
                      : 'distinctive note', // Use .includes for types
                  a_sensation:
                    firstItem &&
                    getIngredientFlavorNotes(firstItem).some((n) =>
                      n.includes('heat')
                    )
                      ? 'a warming sensation'
                      : firstItem &&
                          getIngredientFlavorNotes(firstItem).some((n) =>
                            n.includes('cool')
                          )
                        ? 'a cooling touch'
                        : 'a delightful sensation',
                  bright_or_deep_quality:
                    firstItem && getIngredientWeight(firstItem) === 'light'
                      ? 'bright accent'
                      : 'deep resonance',
                  elegance_or_rusticity:
                    firstItem &&
                    getIngredientRarity(firstItem) !== 'common' &&
                    !getIngredientTags(firstItem).includes('street_food_snack')
                      ? 'an elegant touch'
                      : 'a rustic charm',
                  texture_or_aroma:
                    firstItem &&
                    getIngredientTags(firstItem).includes('crunchy')
                      ? 'a textural highlight'
                      : firstItem &&
                          getIngredientTags(firstItem).includes('aromatic')
                        ? 'an aromatic whisper'
                        : 'a final note',
                  visual_cue:
                    firstItem &&
                    getIngredientTags(firstItem).includes('glowing')
                      ? 'ethereal glow'
                      : firstItem &&
                          getIngredientTags(firstItem).some((t) =>
                            [
                              'vibrant_red',
                              'deep_purple',
                              'saffron_color',
                              'dramatic',
                            ].includes(t)
                          )
                        ? 'vibrant color'
                        : 'appealing look',
                  subtle_flavor_essence: firstItem
                    ? describeFlavorOfItem(
                        firstItem,
                        'template_simple_flavor_noun',
                        dishType,
                        usedDishDescriptors
                      )
                    : 'its subtle character',
                  luscious_texture:
                    firstItem &&
                    getIngredientFlavorNotes(firstItem).some(
                      (n) => n.includes('creamy') || n.includes('velvety')
                    )
                      ? getRandomElement([
                          'luscious texture',
                          'creamy richness',
                        ])
                      : 'its delightful texture',
                  texture_adjective:
                    firstItem && getIngredientTags(firstItem).includes('chewy')
                      ? 'chewy'
                      : firstItem &&
                          getIngredientTags(firstItem).includes('crispy')
                        ? 'crispy'
                        : firstItem &&
                            getIngredientTags(firstItem).includes('flaky')
                          ? 'flaky'
                          : firstItem &&
                              getIngredientTags(firstItem).includes('starchy')
                            ? 'starchy'
                            : 'familiar',
                });
                if (roleDescriptionPartsForNotes.length > 0) {
                  let availableConnectors = CULINARY_CONNECTORS.filter(
                    (c) => c !== lastConnector
                  );
                  let connector = getRandomElement(
                    availableConnectors.length > 0
                      ? availableConnectors
                      : CULINARY_CONNECTORS
                  );
                  if (!connector) connector = 'Then,';
                  lastConnector = connector;
                  part =
                    connector +
                    ' ' +
                    part.charAt(0).toLowerCase() +
                    part.slice(1);
                }
                roleDescriptionPartsForNotes.push(part);
              }
            }
          });

          let culinaryArchitecture = '';
          if (roleDescriptionPartsForNotes.length > 0) {
            culinaryArchitecture =
              'The culinary architecture unfolds as such: ' +
              roleDescriptionPartsForNotes.join(' ');
          }

          const journeyTemplateObjForNotes = FLAVOR_JOURNEYS;
          const validJourneyIngs = allSelectedIngredients.filter(
            (i) => i && !getIngredientTags(i).includes('placeholder')
          );
          let journeyText = '';

          if (journeyTemplateObjForNotes && validJourneyIngs.length >= 2) {
            const introIng =
              validJourneyIngs.find(
                (i) =>
                  i.role === 'garnish' ||
                  i.role === 'accent' ||
                  getIngredientWeight(i) === 'light' ||
                  getIngredientTags(i).includes('floral') ||
                  getIngredientTags(i).includes('fresh') ||
                  getIngredientTags(i).includes('delicate')
              ) || validJourneyIngs[0];
            const coreIng =
              validJourneyIngs.find(
                (i) => i.role === 'primary' || i.role === 'base'
              ) ||
              (validJourneyIngs.length > 1
                ? validJourneyIngs[1]
                : validJourneyIngs[0]);
            const aftertasteIng =
              validJourneyIngs.find(
                (i) =>
                  i.role === 'seasoning' ||
                  (i.role === 'accent' &&
                    getIngredientName(i) !== getIngredientName(introIng) &&
                    (getIngredientTags(i).includes('spicy') ||
                      getIngredientTags(i).includes('sour') ||
                      getIngredientTags(i).includes('bitter') ||
                      getIngredientTags(i).includes('cool')))
              ) ||
              (journeyIngs.length > 2
                ? journeyIngs[2]
                : journeyIngs.length > 1
                  ? journeyIngs[journeyIngs.length - 1]
                  : journeyIngs[0]);

            const distinctJourneyIngs = [
              introIng,
              coreIng,
              aftertasteIng,
            ].filter(
              (value, index, self) =>
                value &&
                typeof value === 'object' &&
                self.findIndex(
                  (v) =>
                    v &&
                    typeof v === 'object' &&
                    getIngredientName(v) === getIngredientName(value)
                ) === index
            );

            if (distinctJourneyIngs.length >= 2) {
              const firstFlavor = describeFlavorOfItem(
                distinctJourneyIngs[0],
                'journey_intro',
                dishType,
                usedDishDescriptors
              );
              const secondFlavor = describeFlavorOfItem(
                distinctJourneyIngs[1],
                'journey_core',
                dishType,
                usedDishDescriptors
              );
              if (
                distinctJourneyIngs.length >= 3 &&
                distinctJourneyIngs[2] &&
                getIngredientName(distinctJourneyIngs[2]) !==
                  getIngredientName(distinctJourneyIngs[0]) &&
                getIngredientName(distinctJourneyIngs[2]) !==
                  getIngredientName(distinctJourneyIngs[1])
              ) {
                const thirdFlavor = describeFlavorOfItem(
                  distinctJourneyIngs[2],
                  'journey_aftertaste',
                  dishType,
                  usedDishDescriptors
                );
                let journeyTemplate = getRandomElement(
                  FLAVOR_JOURNEYS.templates
                );
                journeyText = journeyTemplate
                  .replace('{intro}', firstFlavor)
                  .replace('{core}', secondFlavor)
                  .replace('{aftertaste}', thirdFlavor);
              } else {
                journeyText = `The experience centers on ${firstFlavor}, beautifully supported by ${secondFlavor}.`;
              }
            } else if (distinctJourneyIngs.length === 1) {
              journeyText = `The flavor experience highlights the ${describeFlavorOfItem(distinctJourneyIngs[0], 'template_simple_flavor_noun', dishType, usedDishDescriptors)} of ${getIngredientName(distinctJourneyIngs[0], true)}.`;
            }
          }
          notesParts.push(prepIntro, culinaryArchitecture, journeyText); // Push to notesParts
          notesParts = notesParts.filter(Boolean); // Filter out any empty strings that might have been pushed
        }
        // This final part is now outside the if/else if/else cascade for notes generation
        // It handles both the general case (notesParts) and the SW special case (which also pushed to notesParts now)
        // The Glimmering Nectar case is still handled by a direct assignment earlier.
        if (
          !generatedName.includes('Glimmering Moon_Touched Fruit Pulp Nectar')
        ) {
          let finalPlatingNotesForNotes = '';
          const primaryNationKeyForPlating =
            finalNationKeys && finalNationKeys.length > 0
              ? finalNationKeys[0]
              : 'earthKingdom';
          const platingNationData = CANON_DATA[primaryNationKeyForPlating];
          let specificPlating = '';

          const currentThemeData =
            themeVal && CANON_DATA.themes[themeVal]
              ? { ...CANON_DATA.themes[themeVal], themeKey: themeVal }
              : null;
          if (
            currentThemeData &&
            typeof currentThemeData === 'object' &&
            currentThemeData.plating
          ) {
            specificPlating = currentThemeData.plating;
          } else if (
            platingNationData &&
            typeof platingNationData === 'object' &&
            Array.isArray(platingNationData.platingNotes) &&
            platingNationData.platingNotes.length > 0
          ) {
            specificPlating = getRandomElement(platingNationData.platingNotes);
          } else {
            specificPlating =
              'It is served thoughtfully, inviting one to savor each element.';
          }

          finalPlatingNotesForNotes =
            'Presentation is an art form here. ' + specificPlating;
          notesParts.push(
            finalPlatingNotesForNotes.charAt(0).toUpperCase() +
              finalPlatingNotesForNotes.slice(1)
          );

          let randomEnding = getRandomElement([
            'A harmonious blend of texture and taste.',
            'Perfect for sharing with friends or quiet contemplation.',
            'Enjoy this unique culinary experience!',
            'A dish to remember.',
            'Truly a flavor of the elements.',
            'A symphony for the senses.',
          ]);
          if (randomEnding) notesParts.push(randomEnding);

          generatedNotes = notesParts
            .map((s) => s.trim())
            .join(' ')
            .replace(/\s+/g, ' ');
        }

        generatedLore = generateDishLore(
          allSelectedIngredients,
          finalNationDisplayNames,
          finalNationKeys,
          themeVal,
          dishType,
          CANON_DATA.themes[themeVal],
          generatedName
        );
        if (
          generatedName.includes('Glimmering Moon_Touched Fruit Pulp Nectar')
        ) {
          generatedLore =
            'They say the shrine appears only to those who‚Äôve lost something precious‚Äîand the nectar remembers what they‚Äôve forgotten, offering a taste of solace or a glimpse of what was.';
        }

        generatedConcept = cleanRedundantPhrases(generatedConcept);
        generatedNotes = cleanRedundantPhrases(generatedNotes);
        generatedLore = cleanRedundantPhrases(generatedLore);

        document.getElementById('dishName').textContent = generatedName;
        document.getElementById('dishConcept').textContent = generatedConcept;
        const ingredientListEl = document.getElementById('ingredientList');
        ingredientListEl.innerHTML = '';
        allSelectedIngredients.forEach((ingObj) => {
          const li = document.createElement('li');
          li.textContent = `${getIngredientName(ingObj, true)} (Role: ${ingObj.role || 'unknown'}; Type: ${getIngredientType(ingObj)}; Source: ${ingObj.sourceNation || 'Unknown'})`;
          if (
            getIngredientRarity(ingObj) &&
            getIngredientRarity(ingObj) !== 'common'
          ) {
            li.textContent += `; Rarity: ${getIngredientRarity(ingObj)}`;
          }
          ingredientListEl.appendChild(li);
        });
        document.getElementById('dishNotes').textContent = generatedNotes;
        if (generatedLore) {
          document.getElementById('loreText').textContent = generatedLore;
          document.getElementById('dishLore').style.display = 'block';
        } else {
          document.getElementById('dishLore').style.display = 'none';
        }
      }

      function interpolateTemplate(templateString, dataObject) {
        if (typeof templateString !== 'string') {
          return '';
        }
        let result = templateString;

        result = result.replace(/\{(.*?)\}/g, (match, key) => {
          const trimmedKey = key.trim();
          if (dataObject.hasOwnProperty(trimmedKey)) {
            let value = dataObject[trimmedKey];
            if (typeof value === 'object' && value !== null && value.name) {
              value = getIngredientName(value, true);
            }
            return String(value);
          }
          return match;
        });

        const vowels = 'aeiouAEIOU'; // Define vowels for the whole function

        // Fixed: Inlined the vowel sound check directly into the callback
        result = result.replace(
          /\b(a|an) +([a-zA-Z\{][\w\{]*)/g,
          (match, article, word) => {
            let actualNextWord = word; // Use 'word' directly from the regex match
            if (
              actualNextWord.startsWith('{') &&
              actualNextWord.endsWith('}')
            ) {
              return match;
            }

            const firstLetterLower = actualNextWord.charAt(0).toLowerCase();
            const isVowelSound =
              vowels.includes(firstLetterLower) &&
              !actualNextWord.toLowerCase().startsWith('uni') &&
              !actualNextWord.toLowerCase().startsWith('eu') &&
              !actualNextWord.toLowerCase().startsWith('one');

            if (
              article.toLowerCase() === 'an' &&
              (actualNextWord.toLowerCase().startsWith('unique') ||
                actualNextWord.toLowerCase().startsWith('uni') ||
                actualNextWord.toLowerCase().startsWith('eu') ||
                actualNextWord.toLowerCase().startsWith('one'))
            ) {
              return `a ${actualNextWord}`;
            }
            if (
              article.toLowerCase() === 'a' &&
              (actualNextWord.toLowerCase().startsWith('hour') ||
                actualNextWord.toLowerCase().startsWith('honor'))
            ) {
              return `an ${actualNextWord}`;
            }

            if (article.toLowerCase() === 'a' && isVowelSound) {
              return `an ${actualNextWord}`;
            } else if (article.toLowerCase() === 'an' && !isVowelSound) {
              return `a ${actualNextWord}`;
            }
            return match;
          }
        );

        result = result.replace(/\{([A-Za-z_]+)\}/g, (match, p1) => {
          return dataObject[p1] !== undefined
            ? String(dataObject[p1])
            : `[${p1.replace(/_/g, ' ').toLowerCase()}]`;
        });

        return result;
      }

      function generateStructuredName(
        selectedNationsData,
        allSelectedIngredients,
        dishType,
        baseFormat,
        themeData,
        nationKeys,
        nationDisplayNames
      ) {
        let potentialNameFormats = [];
        const primaryNationKey =
          nationKeys && nationKeys.length > 0 ? nationKeys[0] : null;
        const primaryNationData = primaryNationKey
          ? CANON_DATA[primaryNationKey]
          : null;
        const primaryNationDisplayName =
          nationDisplayNames && nationDisplayNames.length > 0
            ? nationDisplayNames[0]
            : 'Elemental';

        let nameData = {
          dishType: dishType,
          format: baseFormat || dishType,
          mainIngredient: 'Essence',
          secondaryIngredient: 'Whispers',
          themeAdj:
            themeData &&
            typeof themeData === 'object' &&
            Array.isArray(themeData.adj) &&
            themeData.adj.length > 0
              ? getRandomElement(themeData.adj)
              : '',
          nationAdj:
            primaryNationData &&
            typeof primaryNationData === 'object' &&
            Array.isArray(primaryNationData.adjectives) &&
            primaryNationData.adjectives.length > 0
              ? getRandomElement(primaryNationData.adjectives)
              : primaryNationDisplayName.split(' ')[0],
          flavorAdj:
            getRandomElement(
              CANON_DATA.genericAdjectives.filter(
                (adj) =>
                  !adj.endsWith('y') && !adj.endsWith('ing') && adj.length > 5
              )
            ) || 'Flavorful',
          culturalSymbol: 'Elemental Harmony',
          avatarName: getRandomElement([
            'Roku',
            'Kyoshi',
            'Yangchen',
            'Aang',
            'Korra',
            'Wan',
          ]),
          emotion: getRandomElement([
            'Joyful',
            'Nostalgic',
            'Spirited',
            'Bold',
            'Comforting',
            'Mellow',
            'Robust',
            'Tangy',
            'Spiced',
            'Imperial',
            'Victorious',
          ]),
          mainIngredient1: 'Component A',
          mainIngredient2: 'Component B',
          geography:
            getRandomElement(
              DISH_LORE_TEMPLATES._placeholders.Geographical_Feature
            ) || 'a Hidden Valley',
          region:
            getRandomElement(
              DISH_LORE_TEMPLATES._placeholders.EK_Province_Name
            ) || 'an Ancient Province',
          famous_figure: 'a Legendary Chef',
          spirit_location:
            getRandomElement(
              DISH_LORE_TEMPLATES._placeholders.Spirit_World_Landmark_Emotional
            ) || 'a Forgotten Shrine',
          fireLordName:
            getRandomElement(
              DISH_LORE_TEMPLATES._placeholders.Fire_Lord_Name
            ) || 'a Great Fire Lord',
          named_spirit_being:
            getRandomElement(
              DISH_LORE_TEMPLATES._placeholders.Named_Spirit_Being
            ) || 'an Ancient Spirit',
        };

        const primaryIngObj = allSelectedIngredients.find(
          (i) =>
            i &&
            i.role === 'primary' &&
            !getIngredientTags(i).includes('placeholder')
        );
        const baseIngObj = allSelectedIngredients.find(
          (i) =>
            i &&
            i.role === 'base' &&
            !getIngredientTags(i).includes('placeholder')
        );
        const accentIngObj = allSelectedIngredients.find(
          (i) =>
            i &&
            i.role === 'accent' &&
            !getIngredientTags(i).includes('placeholder')
        );

        let mainNameIngredientObj = primaryIngObj || baseIngObj;
        if (
          !mainNameIngredientObj &&
          allSelectedIngredients.filter(
            (i) => i && !getIngredientTags(i).includes('placeholder')
          ).length > 0
        ) {
          mainNameIngredientObj = allSelectedIngredients.find(
            (i) => i && !getIngredientTags(i).includes('placeholder')
          );
        }

        if (
          mainNameIngredientObj &&
          typeof mainNameIngredientObj === 'object'
        ) {
          nameData.mainIngredient = getIngredientName(
            mainNameIngredientObj,
            true
          ).split(' (')[0];
        } else {
          nameData.mainIngredient =
            dishType === 'Nectar'
              ? 'Mystic Nectar'
              : dishType === 'Dessert'
                ? 'Sweet Treat'
                : getRandomElement(CANON_DATA.genericDishNouns);
        }
        nameData.mainIngredient1 = nameData.mainIngredient;

        let secondaryNameIngredientObj = accentIngObj;
        if (
          mainNameIngredientObj &&
          typeof mainNameIngredientObj === 'object'
        ) {
          if (
            !secondaryNameIngredientObj ||
            (secondaryNameIngredientObj &&
              typeof secondaryNameIngredientObj === 'object' &&
              getIngredientName(secondaryNameIngredientObj) ===
                getIngredientName(mainNameIngredientObj))
          ) {
            secondaryNameIngredientObj = allSelectedIngredients.find(
              (i) =>
                i &&
                i.role !== mainNameIngredientObj.role &&
                getIngredientName(i) !==
                  getIngredientName(mainNameIngredientObj) &&
                !getIngredientTags(i).includes('placeholder')
            );
          }
        } else {
          if (
            !secondaryNameIngredientObj ||
            (secondaryNameIngredientObj &&
              typeof secondaryNameIngredientObj === 'object' &&
              getIngredientName(secondaryNameIngredientObj) ===
                nameData.mainIngredient1)
          ) {
            secondaryNameIngredientObj = allSelectedIngredients.find(
              (i) =>
                i &&
                !getIngredientTags(i).includes('placeholder') &&
                getIngredientName(i) !== nameData.mainIngredient1
            );
          }
        }

        if (
          secondaryNameIngredientObj &&
          typeof secondaryNameIngredientObj === 'object'
        ) {
          nameData.secondaryIngredient = getIngredientName(
            secondaryNameIngredientObj,
            true
          ).split(' (')[0];
        } else {
          const firstIngFlavorNote =
            mainNameIngredientObj &&
            typeof mainNameIngredientObj === 'object' &&
            getIngredientFlavorNotes(mainNameIngredientObj).length > 0
              ? getIngredientFlavorNotes(mainNameIngredientObj)[0] || 'Subtle'
              : 'Subtle';
          nameData.secondaryIngredient =
            firstIngFlavorNote.split('_')[0] + ' Notes'; // Note: adjusted to use _ due to data consistency
        }
        nameData.mainIngredient2 = nameData.secondaryIngredient;

        if (
          primaryNationData &&
          typeof primaryNationData === 'object' &&
          Array.isArray(primaryNationData.famousMonks)
        ) {
          let monkChoice = getRandomElement(primaryNationData.famousMonks);
          if (monkChoice) nameData.famous_figure = monkChoice;
        } else if (
          primaryNationData &&
          typeof primaryNationData === 'object' &&
          Array.isArray(primaryNationData.adjectives)
        ) {
          let adjChoice = getRandomElement(primaryNationData.adjectives);
          if (adjChoice && typeof adjChoice === 'string')
            nameData.famous_figure = `a ${adjChoice.split(' ')[0]} Elder`;
        }

        potentialNameFormats = [];
        if (nationKeys && nationKeys.length > 0) {
          nationKeys.forEach((key) => {
            if (
              CANON_DATA[key] &&
              typeof CANON_DATA[key] === 'object' &&
              Array.isArray(CANON_DATA[key].nameFormats) &&
              CANON_DATA[key].nameFormats.length > 0
            ) {
              potentialNameFormats.push(
                ...CANON_DATA[key].nameFormats.filter(
                  (nf) => typeof nf === 'object' && nf !== null && nf.pattern
                )
              );
            }
          });
        }
        if (
          themeData &&
          typeof themeData === 'object' &&
          CANON_DATA.themes[themeData.themeKey] &&
          Array.isArray(CANON_DATA.themes[themeData.themeKey].nameFormats)
        ) {
          potentialNameFormats.push(
            ...CANON_DATA.themes[themeData.themeKey].nameFormats.filter(
              (nf) => typeof nf === 'object' && nf !== null && nf.pattern
            )
          );
        }

        let filteredNameFormats = potentialNameFormats.filter((nf) => {
          if (nf.slots && typeof nf.slots.condition === 'function') {
            return nf.slots.condition(allSelectedIngredients);
          }
          return true;
        });

        let nameFormatTemplate = getRandomElement(
          filteredNameFormats.length > 0
            ? filteredNameFormats
            : potentialNameFormats.filter(
                (f) => f && typeof f === 'object' && f.pattern
              )
        );

        if (
          !nameFormatTemplate ||
          typeof nameFormatTemplate !== 'object' ||
          !nameFormatTemplate.pattern
        ) {
          let fallbackAdj = nameData.nationAdj || 'Simple';
          nameData.mainIngredient = nameData.mainIngredient || 'Treat';
          nameFormatTemplate = {
            pattern: `{nationAdj} {mainIngredient} {format}`,
            slots: { nationAdj: [fallbackAdj] },
          };
        }

        if (
          nameFormatTemplate &&
          typeof nameFormatTemplate.slots === 'object' &&
          nameFormatTemplate.slots !== null
        ) {
          for (const slotKey in nameFormatTemplate.slots) {
            const slotValueSource = nameFormatTemplate.slots[slotKey];
            if (Array.isArray(slotValueSource) && slotValueSource.length > 0) {
              nameData[slotKey] = getRandomElement(slotValueSource);
            } else if (typeof slotValueSource === 'string') {
              if (slotValueSource.startsWith('use_selected_')) {
                const typeHint = slotValueSource.substring(
                  'use_selected_'.length
                );
                let candidates = allSelectedIngredients.filter(
                  (i) => i && !getIngredientTags(i).includes('placeholder')
                );
                if (['main_ingredient', 'ingredient'].includes(typeHint)) {
                  nameData[slotKey] = nameData.mainIngredient;
                  continue;
                }
                if (['secondary_ingredient'].includes(typeHint)) {
                  nameData[slotKey] = nameData.secondaryIngredient;
                  continue;
                }

                if (
                  [
                    'fruit',
                    'veg',
                    'dairy',
                    'meat',
                    'seafood',
                    'grain',
                    'spirit',
                    'chili',
                    'herb',
                    'fungi',
                    'nut',
                    'spice',
                  ].some((t) => typeHint.includes(t))
                ) {
                  // Use .some for types
                  candidates = candidates.filter(
                    (ing) =>
                      getIngredientType(ing).includes(typeHint) ||
                      getIngredientTags(ing).includes(typeHint)
                  ); // Using .includes for types as they can be composite (e.g., 'fruit_product')
                }
                const chosenIng =
                  getRandomElement(
                    candidates.filter(
                      (ing) => ing.role === 'primary' || ing.role === 'base'
                    )
                  ) ||
                  getRandomElement(candidates) ||
                  (candidates.length > 0 ? candidates[0] : undefined);
                nameData[slotKey] =
                  chosenIng && typeof chosenIng === 'object'
                    ? getIngredientName(chosenIng, true).split(' (')[0]
                    : nameData.mainIngredient;
              } else if (
                slotValueSource === 'use_dish_format' ||
                slotValueSource === 'use_dish_type_or_format'
              ) {
                nameData[slotKey] = baseFormat || dishType;
              } else if (slotValueSource.startsWith('use_')) {
                const placeholderKey = slotValueSource.substring('use_'.length);
                let placeholderValue =
                  DISH_LORE_TEMPLATES._placeholders[
                    placeholderKey.charAt(0).toUpperCase() +
                      placeholderKey.slice(1)
                  ];
                nameData[slotKey] =
                  nameData[placeholderKey] ||
                  (placeholderValue && Array.isArray(placeholderValue)
                    ? getRandomElement(placeholderValue)
                    : placeholderKey);
              } else {
                nameData[slotKey] = slotValueSource;
              }
            }
          }
        }

        let generatedNameStr = interpolateTemplate(
          nameFormatTemplate.pattern,
          nameData
        );
        generatedNameStr = generatedNameStr.replace(/\{[^}]+\}/gi, (match) => {
          const keyWithin = match.slice(1, -1);
          return String(
            nameData[keyWithin] || nameData.mainIngredient || dishType
          );
        });

        const namePartsForRedundancyCheck = generatedNameStr.split(' ');
        if (namePartsForRedundancyCheck.length > 2 && nameData.mainIngredient) {
          const mainIngSimpleForName = nameData.mainIngredient.split(' ')[0];
          const glazeRegexCheck = new RegExp(
            `\\b${mainIngSimpleForName}\\b` +
              '.*?\\b' +
              `\\b${mainIngSimpleForName}\\s+Glaze\\b`,
            'i'
          );
          if (glazeRegexCheck.test(generatedNameStr)) {
            generatedNameStr = generatedNameStr.replace(
              glazeRegexCheck,
              `${nameData.mainIngredient} Glaze`
            );
          } else {
            if (
              nameData.secondaryIngredient &&
              nameData.secondaryIngredient
                .toLowerCase()
                .includes(mainIngSimpleForName.toLowerCase()) &&
              generatedNameStr
                .toLowerCase()
                .includes(
                  nameData.mainIngredient.toLowerCase() +
                    ' with ' +
                    nameData.secondaryIngredient.toLowerCase()
                )
            ) {
              generatedNameStr = generatedNameStr.replace(
                new RegExp(
                  nameData.mainIngredient +
                    ' with ' +
                    nameData.secondaryIngredient,
                  'ig'
                ),
                nameData.mainIngredient
              );
            }
          }
        }

        return (
          generatedNameStr
            .replace(/\s+/g, ' ')
            .trim()
            .replace(/Generic /gi, '')
            .replace(/Common /gi, '') || 'Unnamed Culinary Creation'
        );
      }

      function generateDishLore(
        ingredients,
        nationDisplayNames,
        nationKeys,
        themeValue,
        dishType,
        themeData,
        generatedName
      ) {
        let loreCandidates = [];
        const placeholders = DISH_LORE_TEMPLATES._placeholders;
        const primaryNationForLore =
          nationDisplayNames &&
          Array.isArray(nationDisplayNames) &&
          nationDisplayNames.length > 0
            ? nationDisplayNames[0]
            : 'an unknown land';

        ingredients
          .filter((i) => i && !getIngredientTags(i).includes('placeholder'))
          .forEach((ing) => {
            const ingNameStripped = getIngredientName(ing, true);
            const hints = getIngredientLoreHints(ing);
            if (
              DISH_LORE_TEMPLATES.byIngredientHint &&
              DISH_LORE_TEMPLATES.byIngredientHint[ingNameStripped] &&
              Array.isArray(
                DISH_LORE_TEMPLATES.byIngredientHint[ingNameStripped]
              )
            ) {
              let loreText = getRandomElement(
                DISH_LORE_TEMPLATES.byIngredientHint[ingNameStripped]
              );
              if (loreText)
                loreCandidates.push({
                  text: loreText,
                  priority: 0.5,
                  source: `ingredient_direct_${ingNameStripped}`,
                });
            }
            if (Array.isArray(hints)) {
              hints.forEach((hintKey) => {
                if (
                  DISH_LORE_TEMPLATES.byIngredientHint &&
                  DISH_LORE_TEMPLATES.byIngredientHint[hintKey] &&
                  Array.isArray(DISH_LORE_TEMPLATES.byIngredientHint[hintKey])
                ) {
                  let loreText = getRandomElement(
                    DISH_LORE_TEMPLATES.byIngredientHint[hintKey]
                  );
                  if (loreText)
                    loreCandidates.push({
                      text: loreText,
                      priority: 1,
                      source: `ingredient_hint_${hintKey}`,
                    });
                }
              });
            }
          });

        if (
          themeValue &&
          CANON_DATA.themes[themeValue] &&
          CANON_DATA.themes[themeValue].loreSourceTag &&
          DISH_LORE_TEMPLATES.byTheme[themeValue] &&
          Array.isArray(DISH_LORE_TEMPLATES.byTheme[themeValue])
        ) {
          const themeTag = CANON_DATA.themes[themeValue].loreSourceTag;
          DISH_LORE_TEMPLATES.byTheme[themeValue].forEach((lore) => {
            if (lore)
              loreCandidates.push({
                text: lore,
                priority: 1.5,
                source: themeTag,
              });
          });
        }

        if (nationDisplayNames && nationDisplayNames.length > 0) {
          nationDisplayNames.forEach((dispName) => {
            const nationKeyForLore = nationKeys.find(
              (nk, idx) => nationDisplayNames[idx] === dispName
            );
            if (
              nationKeyForLore &&
              DISH_LORE_TEMPLATES.byNation[nationKeyForLore] &&
              Array.isArray(DISH_LORE_TEMPLATES.byNation[nationKeyForLore])
            ) {
              DISH_LORE_TEMPLATES.byNation[nationKeyForLore].forEach((lore) => {
                if (lore)
                  loreCandidates.push({
                    text: lore,
                    priority: nationKeyForLore === 'spiritWorld' ? 1 : 2,
                    source: `nation_${nationKeyForLore}`,
                  });
              });
            }
          });
        }

        if (Array.isArray(DISH_LORE_TEMPLATES.generic)) {
          DISH_LORE_TEMPLATES.generic.forEach((lore) => {
            if (lore)
              loreCandidates.push({
                text: lore,
                priority: 3,
                source: 'generic',
              });
          });
        }

        if (
          loreCandidates.length > 1 &&
          Math.random() < 0.2 &&
          placeholders.Generic_Controversy &&
          Array.isArray(placeholders.Generic_Controversy) &&
          placeholders.Generic_Controversy.length > 0
        ) {
          let controversy = getRandomElement(placeholders.Generic_Controversy);
          if (controversy)
            loreCandidates.push({
              text: controversy,
              priority: 2.5,
              source: 'controversy',
            });
        }

        if (loreCandidates.length === 0)
          return 'The history of this dish is shrouded in delicious mystery, perhaps best discovered by tasting.';

        loreCandidates.sort((a, b) => a.priority - b.priority);

        let chosenLoreTemplate = undefined;
        let availableCandidatesForSelection = [...loreCandidates];
        let filteredCandidates = availableCandidatesForSelection.filter(
          (c) => !globalLoreHistory.has(c.source)
        );

        if (filteredCandidates.length > 0) {
          filteredCandidates.sort((a, b) => a.priority - b.priority);
          chosenLoreTemplate = filteredCandidates[0];
        } else {
          chosenLoreTemplate = availableCandidatesForSelection[0];
        }

        if (chosenLoreTemplate && chosenLoreTemplate.source) {
          globalLoreHistory.add(chosenLoreTemplate.source);
          if (globalLoreHistory.size > MAX_LORE_HISTORY) {
            let tempArray = Array.from(globalLoreHistory);
            tempArray.shift();
            globalLoreHistory = new Set(tempArray);
          }
        }

        const isSimpleDish =
          dishType === 'Snack' ||
          dishType === 'Side Dish' ||
          dishType === 'Street Food' ||
          (ingredients.length <= 3 &&
            ingredients.every((ing) => getIngredientRarity(ing) === 'common'));
        if (chosenLoreTemplate && isSimpleDish) {
          const epicLoreKeywords = [
            'Avatar ',
            'spirit_touched amulet',
            'Royal Family',
            'dynasty',
            'coronation',
            'ancient spirit',
            'Earth King',
            'Fire Lord',
            'legendary',
            'sacred',
            'mystical',
            'Sun Warrior',
            "Dragon's Peak",
            'prophecy',
            'ancient scrolls',
          ];
          if (
            epicLoreKeywords.some((keyword) =>
              chosenLoreTemplate.text
                .toLowerCase()
                .includes(keyword.toLowerCase())
            )
          ) {
            let lessEpicLore = loreCandidates.find(
              (lc) =>
                lc.priority > chosenLoreTemplate.priority &&
                !epicLoreKeywords.some((keyword) =>
                  lc.text.toLowerCase().includes(keyword.toLowerCase())
                )
            );
            if (lessEpicLore) {
              chosenLoreTemplate = lessEpicLore;
            }
          }
        }

        let chosenLore =
          chosenLoreTemplate &&
          typeof chosenLoreTemplate === 'object' &&
          chosenLoreTemplate.text
            ? chosenLoreTemplate.text
            : 'Its origins are as enigmatic as the Spirit World itself.';

        let loreData = {
          nation_name: primaryNationForLore,
          Dish_Name: generatedName,
          Dish_Type: dishType.toLowerCase(),
          ...Object.keys(placeholders).reduce((acc, key) => {
            if (
              placeholders[key] &&
              Array.isArray(placeholders[key]) &&
              placeholders[key].length > 0
            ) {
              let randomVal = getRandomElement(placeholders[key]);
              if (randomVal) acc[key] = randomVal;
            }
            return acc;
          }, {}),
        };

        const primaryNationKey =
          nationKeys && nationKeys.length > 0 ? nationKeys[0] : null;
        if (primaryNationKey) {
          const nationPrefix =
            primaryNationKey.charAt(0).toUpperCase() +
            primaryNationKey
              .slice(1)
              .replace(/([A-Z])/g, ' $1')
              .split(' ')[0];
          Object.keys(placeholders).forEach((key) => {
            if (
              key.toUpperCase().startsWith(nationPrefix.toUpperCase() + '_')
            ) {
              if (
                placeholders[key] &&
                Array.isArray(placeholders[key]) &&
                placeholders[key].length > 0
              ) {
                let randomVal = getRandomElement(placeholders[key]);
                if (randomVal) loreData[key] = randomVal;
              }
            }
          });
          const capitals = {
            airNomads: [
              'the Southern Air Temple',
              'the Northern Air Temple (historically)',
              'an ancient Sky Peak Monastery',
            ],
            waterTribes: [
              "Agna Qel'a",
              'the Southern Water Tribe capital city',
              'a hidden Foggy Swamp enclave',
            ],
            earthKingdom: ['Ba Sing Se', 'Omashu'],
            fireNation: ['Caldera City', "the Sun Warrior's hidden city"],
            unitedRepublic: ['Republic City'],
            spiritWorld: [
              'a known spirit crossroads',
              'the Fog of Lost Souls (metaphorically)',
              "Wan Shi Tong's Library (when accessible)",
            ],
          };
          if (
            capitals[primaryNationKey] &&
            Array.isArray(capitals[primaryNationKey])
          ) {
            let capChoice = getRandomElement(capitals[primaryNationKey]);
            if (capChoice) loreData.Nation_Capital = capChoice;
          }
        }

        if (
          generatedName.includes('Glimmering Moon_Touched Fruit Pulp Nectar')
        ) {
          return 'They say the shrine appears only to those who‚Äôve lost something precious‚Äîand the nectar remembers what they‚Äôve forgotten, offering a taste of solace or a glimpse of what was.';
        }
        chosenLore =
          typeof chosenLore === 'string'
            ? interpolateTemplate(chosenLore, loreData)
            : 'A truly ancient and storied dish.';
        return chosenLore;
      }

      document.addEventListener('DOMContentLoaded', function () {
        const dishForm = document.getElementById('dishForm');
        if (!dishForm) {
          console.error(
            "CRITICAL ERROR: The form with id 'dishForm' was not found in the DOM. The script cannot attach the submit event listener."
          );
          const body = document.querySelector('body');
          if (body) {
            const errorP = document.createElement('p');
            errorP.style.color = 'red';
            errorP.style.fontWeight = 'bold';
            errorP.style.textAlign = 'center';
            errorP.style.padding = '1em';
            errorP.style.border = '2px solid red';
            errorP.textContent =
              'Initialization Error: Could not find the dish form. The page might not work correctly. Please check the console (F12).';
            const mainContainer = document.querySelector('.container');
            if (mainContainer)
              mainContainer.insertBefore(errorP, mainContainer.firstChild);
            else body.insertBefore(errorP, body.firstChild);
          }
          return;
        }

        dishForm.addEventListener('submit', function (e) {
          e.preventDefault();

          const dishType = document.getElementById('dishTypeInput').value;
          const selectedNationValues = Array.from(
            document.querySelectorAll("input[name='nation']:checked")
          ).map((input) => input.value);
          const baseFormat = document.getElementById('baseFormat').value;
          const themeVal = document.getElementById('specialThemes').value;

          document.getElementById('dishName').textContent = 'Conjuring Dish...';
          document.getElementById('dishConcept').textContent =
            'Gathering ingredients from across the Four Nations...';
          document.getElementById('ingredientList').innerHTML =
            '<li>‚ùñ Searching the spirit wilds...</li>';
          document.getElementById('dishNotes').textContent =
            'Consulting ancient culinary scrolls...';
          document.getElementById('loreText').textContent =
            'Listening to the whispers of the past...';
          document.getElementById('dishLore').style.display = 'none';
          document.getElementById('dishResult').style.display = 'block';

          requestAnimationFrame(() => {
            // Defer generation to allow UI update
            setTimeout(() => {
              // Small delay to ensure UI renders "Conjuring..."
              try {
                generateAndDisplayDish(
                  dishType,
                  selectedNationValues,
                  baseFormat,
                  themeVal
                );
              } catch (error) {
                console.error('Error during dish generation:', error);
                document.getElementById('dishName').textContent =
                  'Error in the Kitchen!';
                document.getElementById('dishConcept').textContent =
                  'Something went wrong while conjuring the dish. Please check the console for details and try again. The spirits of cuisine can be fickle!';
                document.getElementById('ingredientList').innerHTML =
                  '<li>‚ùñ Culinary mishap...</li>';
                document.getElementById('dishNotes').textContent =
                  `Error: ${error.message}. Perhaps a fire ferret got into the spice rack? Check console for stack trace.`;
              }
            }, 50);
          });
        });
      });
    </script>
  </body>
</html>
